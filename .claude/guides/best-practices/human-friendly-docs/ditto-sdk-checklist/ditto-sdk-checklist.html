<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ditto SDK Implementation Checklist</title>
  <style>
    /* ==========================================================================
       CSS Variables & Base Styles
       ========================================================================== */
    :root {
      --bg-primary: #0a0e27;
      --bg-secondary: #1a1f3a;
      --bg-tertiary: #252b4a;
      --text-primary: #e8eaf0;
      --text-secondary: #a0a8c0;
      --text-muted: #6b7280;
      --accent-primary: #00d4ff;
      --accent-secondary: #4f46e5;
      --border-color: #2d3451;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.5);
      --transition-fast: 0.15s ease;
      --transition-normal: 0.3s ease;
      --gradient-primary: linear-gradient(135deg, #00d4ff 0%, #4f46e5 100%);
      --gradient-secondary: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(79, 70, 229, 0.1) 100%);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: var(--text-primary);
      background-color: var(--bg-primary);
      padding: 20px;
      min-height: 100vh;
    }

    /* ==========================================================================
       Container & Layout
       ========================================================================== */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 40px;
      box-shadow: var(--shadow-lg);
    }

    /* ==========================================================================
       Header Styles
       ========================================================================== */
    header {
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 2px solid var(--border-color);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 20px;
    }

    h1 {
      font-size: 2.5em;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
    }

    .lang-switcher {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-tertiary);
      padding: 8px 16px;
      border-radius: 24px;
      box-shadow: var(--shadow-sm);
    }

    .lang-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 16px;
      transition: all var(--transition-fast);
    }

    .lang-btn:hover {
      color: var(--accent-primary);
      background: rgba(0, 212, 255, 0.1);
    }

    .lang-btn.active {
      color: var(--accent-primary);
      background: rgba(0, 212, 255, 0.15);
    }

    .separator {
      color: var(--text-muted);
      font-weight: 300;
    }

    .metadata {
      color: var(--text-muted);
      font-size: 0.9em;
      margin-bottom: 20px;
    }

    /* ==========================================================================
       Progress Bar
       ========================================================================== */
    .progress-container {
      margin-top: 20px;
    }

    .progress-bar-bg {
      background: var(--bg-tertiary);
      height: 12px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .progress-bar {
      height: 100%;
      background: var(--gradient-primary);
      width: 0%;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0, 212, 255, 0.4);
    }

    .progress-text {
      text-align: center;
      margin-top: 12px;
      font-size: 0.95em;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* ==========================================================================
       Section Accordion
       ========================================================================== */
    .section {
      background: var(--bg-tertiary);
      border-radius: 12px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-normal);
    }

    .section:hover {
      box-shadow: var(--shadow-md);
    }

    .section-header {
      padding: 20px 24px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.05) 0%, rgba(79, 70, 229, 0.05) 100%);
      border-left: 4px solid transparent;
      transition: all var(--transition-fast);
    }

    .section-header:hover {
      border-left-color: var(--accent-primary);
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(79, 70, 229, 0.1) 100%);
    }

    .section-title {
      font-size: 1.4em;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-number {
      color: var(--accent-primary);
      font-weight: 700;
    }

    .section-toggle {
      font-size: 1.2em;
      color: var(--accent-primary);
      transition: transform var(--transition-normal);
    }

    .section.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .section-content {
      max-height: 10000px;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .section.collapsed .section-content {
      max-height: 0;
    }

    /* ==========================================================================
       Checklist Items
       ========================================================================== */
    .item {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      transition: background-color var(--transition-fast);
    }

    .item:last-child {
      border-bottom: none;
    }

    .item:hover {
      background: rgba(0, 212, 255, 0.02);
    }

    .item-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }

    .checkbox-wrapper {
      flex-shrink: 0;
      margin-top: 2px;
    }

    input[type="checkbox"] {
      width: 22px;
      height: 22px;
      cursor: pointer;
      accent-color: var(--accent-primary);
      border: 2px solid var(--border-color);
      border-radius: 4px;
    }

    .item-title {
      font-size: 1.15em;
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
      line-height: 1.4;
    }

    .item-details {
      margin-left: 38px;
    }

    .detail-section {
      margin-bottom: 16px;
    }

    .detail-section:last-child {
      margin-bottom: 0;
    }

    .detail-heading {
      font-weight: 600;
      color: var(--accent-primary);
      margin-bottom: 8px;
      font-size: 0.95em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-content {
      color: var(--text-secondary);
      line-height: 1.7;
    }

    .detail-content p {
      margin-bottom: 12px;
    }

    .detail-content p:last-child {
      margin-bottom: 0;
    }

    .detail-content ul,
    .detail-content ol {
      margin-left: 0;
      margin-bottom: 12px;
      padding-left: 0;
      list-style: none;
    }

    .detail-content ul li {
      margin-bottom: 8px;
      padding-left: 28px;
      position: relative;
    }

    .detail-content ul li::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 10px;
      width: 6px;
      height: 6px;
      background: var(--accent-primary);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0, 212, 255, 0.4);
    }

    .detail-content ol li {
      margin-bottom: 8px;
      padding-left: 28px;
    }

    /* Handle bullet points in paragraphs (for translated content starting with "- ") */
    .detail-content p.bullet-item {
      padding-left: 28px;
      position: relative;
      margin-bottom: 8px;
    }

    .detail-content p.bullet-item::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 10px;
      width: 6px;
      height: 6px;
      background: var(--accent-primary);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0, 212, 255, 0.4);
    }

    .detail-content strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .detail-content code {
      background: var(--bg-primary);
      padding: 2px 8px;
      border-radius: 4px;
      font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
      font-size: 0.9em;
      color: var(--accent-primary);
      border: 1px solid var(--border-color);
    }

    /* ==========================================================================
       Code Examples
       ========================================================================== */
    .code-example {
      margin-top: 16px;
      background: var(--bg-primary);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(0, 212, 255, 0.05);
      border-bottom: 1px solid var(--border-color);
    }

    .code-label {
      font-size: 0.85em;
      font-weight: 600;
      color: var(--accent-primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .code-toggle {
      background: transparent;
      border: 1px solid var(--accent-primary);
      color: var(--accent-primary);
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 600;
      transition: all var(--transition-fast);
    }

    .code-toggle:hover {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }

    .code-content {
      max-height: 500px;
      overflow: auto;
      padding: 16px;
    }

    .code-content.hidden {
      display: none;
    }

    .code-content pre {
      margin: 0;
      font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
      font-size: 0.95em;
      line-height: 1.6;
      color: var(--text-primary);
    }

    .code-content code {
      color: inherit;
    }

    /* ==========================================================================
       Floating Action Button
       ========================================================================== */
    .float-btn {
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: var(--gradient-primary);
      color: white;
      padding: 16px 24px;
      border-radius: 50px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
      font-weight: 600;
      font-size: 0.95em;
      transition: all var(--transition-normal);
      z-index: 1000;
    }

    .float-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.6);
    }

    .float-btn span:first-child {
      font-size: 1.3em;
    }

    /* ==========================================================================
       Responsive Design
       ========================================================================== */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px;
        border-radius: 12px;
      }

      h1 {
        font-size: 1.8em;
      }

      .header-top {
        flex-direction: column;
        align-items: flex-start;
      }

      .section-title {
        font-size: 1.2em;
      }

      .item-title {
        font-size: 1.05em;
      }

      .item-details {
        margin-left: 0;
      }

      .float-btn {
        bottom: 20px;
        right: 20px;
        padding: 14px 20px;
      }

      .float-btn-text {
        display: none;
      }
    }

    /* ==========================================================================
       Print Styles
       ========================================================================== */
    @media print {
      body {
        background: white;
        color: black;
        padding: 0;
      }

      .container {
        box-shadow: none;
        background: white;
      }

      .lang-switcher,
      .float-btn,
      .code-toggle {
        display: none;
      }

      .section {
        page-break-inside: avoid;
      }

      .section-content {
        max-height: none !important;
      }

      .code-content {
        display: block !important;
      }
    }

    /* ==========================================================================
       Utility Classes
       ========================================================================== */
    .hidden {
      display: none;
    }
  
    /* ==========================================================================
       Syntax Highlighting (Pygments)
       ========================================================================== */
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #49483e }
.highlight { background: #272822; color: #F8F8F2 }
.highlight .c { color: #959077 } /* Comment */
.highlight .err { color: #ED007E; background-color: #1E0010 } /* Error */
.highlight .esc { color: #F8F8F2 } /* Escape */
.highlight .g { color: #F8F8F2 } /* Generic */
.highlight .k { color: #66D9EF } /* Keyword */
.highlight .l { color: #AE81FF } /* Literal */
.highlight .n { color: #F8F8F2 } /* Name */
.highlight .o { color: #FF4689 } /* Operator */
.highlight .x { color: #F8F8F2 } /* Other */
.highlight .p { color: #F8F8F2 } /* Punctuation */
.highlight .ch { color: #959077 } /* Comment.Hashbang */
.highlight .cm { color: #959077 } /* Comment.Multiline */
.highlight .cp { color: #959077 } /* Comment.Preproc */
.highlight .cpf { color: #959077 } /* Comment.PreprocFile */
.highlight .c1 { color: #959077 } /* Comment.Single */
.highlight .cs { color: #959077 } /* Comment.Special */
.highlight .gd { color: #FF4689 } /* Generic.Deleted */
.highlight .ge { color: #F8F8F2; font-style: italic } /* Generic.Emph */
.highlight .ges { color: #F8F8F2; font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gr { color: #F8F8F2 } /* Generic.Error */
.highlight .gh { color: #F8F8F2 } /* Generic.Heading */
.highlight .gi { color: #A6E22E } /* Generic.Inserted */
.highlight .go { color: #66D9EF } /* Generic.Output */
.highlight .gp { color: #FF4689; font-weight: bold } /* Generic.Prompt */
.highlight .gs { color: #F8F8F2; font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #959077 } /* Generic.Subheading */
.highlight .gt { color: #F8F8F2 } /* Generic.Traceback */
.highlight .kc { color: #66D9EF } /* Keyword.Constant */
.highlight .kd { color: #66D9EF } /* Keyword.Declaration */
.highlight .kn { color: #FF4689 } /* Keyword.Namespace */
.highlight .kp { color: #66D9EF } /* Keyword.Pseudo */
.highlight .kr { color: #66D9EF } /* Keyword.Reserved */
.highlight .kt { color: #66D9EF } /* Keyword.Type */
.highlight .ld { color: #E6DB74 } /* Literal.Date */
.highlight .m { color: #AE81FF } /* Literal.Number */
.highlight .s { color: #E6DB74 } /* Literal.String */
.highlight .na { color: #A6E22E } /* Name.Attribute */
.highlight .nb { color: #F8F8F2 } /* Name.Builtin */
.highlight .nc { color: #A6E22E } /* Name.Class */
.highlight .no { color: #66D9EF } /* Name.Constant */
.highlight .nd { color: #A6E22E } /* Name.Decorator */
.highlight .ni { color: #F8F8F2 } /* Name.Entity */
.highlight .ne { color: #A6E22E } /* Name.Exception */
.highlight .nf { color: #A6E22E } /* Name.Function */
.highlight .nl { color: #F8F8F2 } /* Name.Label */
.highlight .nn { color: #F8F8F2 } /* Name.Namespace */
.highlight .nx { color: #A6E22E } /* Name.Other */
.highlight .py { color: #F8F8F2 } /* Name.Property */
.highlight .nt { color: #FF4689 } /* Name.Tag */
.highlight .nv { color: #F8F8F2 } /* Name.Variable */
.highlight .ow { color: #FF4689 } /* Operator.Word */
.highlight .pm { color: #F8F8F2 } /* Punctuation.Marker */
.highlight .w { color: #F8F8F2 } /* Text.Whitespace */
.highlight .mb { color: #AE81FF } /* Literal.Number.Bin */
.highlight .mf { color: #AE81FF } /* Literal.Number.Float */
.highlight .mh { color: #AE81FF } /* Literal.Number.Hex */
.highlight .mi { color: #AE81FF } /* Literal.Number.Integer */
.highlight .mo { color: #AE81FF } /* Literal.Number.Oct */
.highlight .sa { color: #E6DB74 } /* Literal.String.Affix */
.highlight .sb { color: #E6DB74 } /* Literal.String.Backtick */
.highlight .sc { color: #E6DB74 } /* Literal.String.Char */
.highlight .dl { color: #E6DB74 } /* Literal.String.Delimiter */
.highlight .sd { color: #E6DB74 } /* Literal.String.Doc */
.highlight .s2 { color: #E6DB74 } /* Literal.String.Double */
.highlight .se { color: #AE81FF } /* Literal.String.Escape */
.highlight .sh { color: #E6DB74 } /* Literal.String.Heredoc */
.highlight .si { color: #E6DB74 } /* Literal.String.Interpol */
.highlight .sx { color: #E6DB74 } /* Literal.String.Other */
.highlight .sr { color: #E6DB74 } /* Literal.String.Regex */
.highlight .s1 { color: #E6DB74 } /* Literal.String.Single */
.highlight .ss { color: #E6DB74 } /* Literal.String.Symbol */
.highlight .bp { color: #F8F8F2 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #A6E22E } /* Name.Function.Magic */
.highlight .vc { color: #F8F8F2 } /* Name.Variable.Class */
.highlight .vg { color: #F8F8F2 } /* Name.Variable.Global */
.highlight .vi { color: #F8F8F2 } /* Name.Variable.Instance */
.highlight .vm { color: #F8F8F2 } /* Name.Variable.Magic */
.highlight .il { color: #AE81FF } /* Literal.Number.Integer.Long */

    /* Adjust Pygments colors to match our dark theme */
    .highlight {
        background: transparent !important;
    }
    .highlight pre {
        margin: 0;
        font-family: inherit;
        line-height: inherit;
    }
    
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-top">
        <h1 id="main-title">Ditto SDK Implementation Checklist</h1>
        <div class="lang-switcher">
          <button class="lang-btn active" data-lang="en" onclick="switchLanguage('en')">ENG</button>
          <span class="separator">/</span>
          <button class="lang-btn" data-lang="ja" onclick="switchLanguage('ja')">JPN</button>
        </div>
      </div>
      <div class="metadata">Version 1.0 | Last Updated: 2025-12-21</div>
      <div class="progress-container">
        <div class="progress-bar-bg">
          <div class="progress-bar" id="global-progress"></div>
        </div>
        <div class="progress-text">
          <span id="completed-count">0</span> / <span id="total-count">0</span> <span id="completed-text">completed</span> (<span id="percent">0</span>%)
        </div>
      </div>
    </header>

    <main id="sections-container">
      
    <div class="section" id="section-1">
      <div class="section-header" onclick="toggleSection('section-1')">
        <h2 class="section-title"><span class="section-number">Section 1:</span> Initialization & API Basics</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-1-0">
            </div>
            <div class="item-title">Initialize Ditto with appropriate authentication mode</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Choose the correct identity mode:</p>
<ul>
<li><strong>Development</strong>: <code>OnlinePlaygroundIdentity</code> (for testing only, no access controls)</li>
<li><strong>Production</strong>: <code>OnlineWithAuthenticationIdentity</code> with authentication delegate</li>
<li><strong>Air-gapped/Offline</strong>: <code>SharedKeyIdentity</code> (no cloud sync)</li>
</ul>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Authentication mode determines security model and sync capabilities. OnlinePlayground is insecure for production. OnlineWithAuthentication provides proper access controls. SharedKey is for fully offline deployments.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-1-1">
            </div>
            <div class="item-title">Handle Ditto initialization errors gracefully</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Wrap <code>Ditto.open()</code>, <code>startSync()</code>, and <code>execute()</code> in try-catch blocks. Handle cases like invalid license, network unavailability, permission issues, or query errors.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Ditto initialization and operations can fail due to licensing, network, platform issues, or invalid queries. Graceful error handling prevents app crashes and provides user feedback.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-1-1')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-1-1">
            <pre><code class="highlight"><span></span><span class="c1">// ✅ GOOD: Proper error handling for Ditto initialization</span>
<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">ditto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">await</span><span class="w"> </span><span class="n">Ditto</span><span class="p">.</span><span class="n">open</span><span class="p">(</span>
<span class="w">    </span><span class="nl">identity:</span><span class="w"> </span><span class="n">OnlinePlaygroundIdentity</span><span class="p">(</span><span class="nl">appId:</span><span class="w"> </span><span class="n">appId</span><span class="p">,</span><span class="w"> </span><span class="nl">token:</span><span class="w"> </span><span class="n">token</span><span class="p">),</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span><span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">startSync</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="kd">on</span><span class="w"> </span><span class="n">DittoError</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Handle Ditto-specific errors (licensing, permissions, etc.)</span>
<span class="w">  </span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Ditto initialization failed: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="n">showErrorDialog</span><span class="p">(</span><span class="s1">&#39;Failed to initialize sync&#39;</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Handle unexpected errors</span>
<span class="w">  </span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Unexpected error: </span><span class="si">$</span><span class="n">e</span><span class="s1">&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-1-2">
            </div>
            <div class="item-title">Use DQL API (current), not legacy builder API</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Use <code>ditto.store.execute('SELECT * FROM collection ...')</code> and related DQL methods. Avoid deprecated builder APIs like <code>ditto.store.collection('name').find()</code>.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Builder API is deprecated and lacks features like transactions, optimizations, and v5 forward compatibility. DQL API is the current standard (SDK 4.12+) and will be maintained going forward.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-1-3">
            </div>
            <div class="item-title">Always await ALTER SYSTEM SET before startSync()</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>When configuring system settings like <code>DQL_STRICT_MODE</code>, always use <code>await</code> before calling <code>startSync()</code> or other operations.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p><code>store.execute()</code> is async. Proceeding without awaiting can cause settings to not be applied before sync starts, leading to inconsistent behavior across peers.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-1-3')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-1-3">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Missing await (settings might not apply before sync)</span>
<span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;ALTER SYSTEM SET DQL_STRICT_MODE = false&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// No await!</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">startSync</span><span class="p">();</span><span class="w"> </span><span class="c1">// May start with wrong settings</span>

<span class="c1">// ✅ GOOD: Always await ALTER SYSTEM SET</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;ALTER SYSTEM SET DQL_STRICT_MODE = false&#39;</span><span class="p">);</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">startSync</span><span class="p">();</span><span class="w"> </span><span class="c1">// Settings guaranteed to be applied</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="section-2">
      <div class="section-header" onclick="toggleSection('section-2')">
        <h2 class="section-title"><span class="section-number">Section 2:</span> Data Modeling Fundamentals</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-2-0">
            </div>
            <div class="item-title">Avoid ID patterns that can cause collisions across devices</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Never use sequential counters, timestamps, or device-based patterns for document IDs when multiple devices can create documents independently. Use globally unique identifiers (UUID v4, ULID) or let Ditto auto-generate IDs. Composite keys (e.g., <code>{"userId": "user123", "orderId": "&lt;uuid&gt;"}</code>) are acceptable when the combination is guaranteed unique.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Sequential ID generation causes collisions when multiple offline devices create documents with the same ID pattern (e.g., "order_001"). Collisions trigger conflict resolution, potentially causing data loss or unexpected behavior. For authorization patterns using composite keys (e.g., <code>{"userId": "user123", "resourceId": "&lt;uuid&gt;"}</code>), ensure at least one component is globally unique.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-2-0')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-2-0">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Sequential IDs cause collisions across offline devices</span>
<span class="kt">int</span><span class="w"> </span><span class="n">orderCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">;</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;order&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;order_</span><span class="si">${</span><span class="n">orderCounter</span><span class="o">++</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;item&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Coffee&#39;</span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">);</span>
<span class="c1">// Device A creates &quot;order_1&quot;, Device B also creates &quot;order_1&quot; → Collision!</span>

<span class="c1">// ✅ GOOD: Let Ditto auto-generate globally unique IDs</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;order&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;item&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Coffee&#39;</span><span class="p">}</span><span class="w">  </span><span class="c1">// No _id → Ditto auto-generates</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">);</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-2-1">
            </div>
            <div class="item-title">Use MAP instead of arrays for mutable data</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Arrays use Last-Write-Wins (REGISTER CRDT), causing merge conflicts when multiple peers update concurrently. Use MAP (object) structures with unique keys for data that can be modified by multiple devices.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Concurrent array updates from offline peers result in lost data, duplicates, or inconsistent state after sync. MAP structures use "add-wins" semantics, automatically merging concurrent updates to different keys without conflicts.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-2-1')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-2-1">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Array with concurrent updates (Last-Write-Wins)</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;order_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;items&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;item1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;qty&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">2</span><span class="p">}]</span><span class="w">  </span><span class="c1">// Merge conflicts!</span>
<span class="p">}</span>

<span class="c1">// ✅ GOOD: MAP structure for concurrent updates</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;order_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;items&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;item1&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;qty&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;productId&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;p1&quot;</span><span class="p">}}</span><span class="w">  </span><span class="c1">// Merge-safe</span>
<span class="p">}</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-2-2">
            </div>
            <div class="item-title">Use embedded vs foreign-key relationships appropriately</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Decide whether to embed related data in a single document or use separate documents with foreign-key references:</p>
<p><strong>Embedded (denormalized)</strong>:</p>
<ul>
<li>Store related data directly within the parent document</li>
<li>Requires single query to retrieve all data</li>
<li>Data duplication across documents (same customer info in multiple orders)</li>
<li>All related data syncs as a single unit</li>
<li>Best for: Small, static data retrieved together (order items, user profile with address)</li>
</ul>
<p><strong>Foreign-key (normalized)</strong>:</p>
<ul>
<li>Store related data in separate documents, reference by ID</li>
<li>Requires multiple sequential queries (no JOIN support in Ditto)</li>
<li>No data duplication, single source of truth</li>
<li>Related data syncs independently</li>
<li>Best for: Large data, frequently updated data, or data accessed independently (user profiles, product catalogs)</li>
</ul>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Ditto does not support SQL-style JOINs. With embedded data, one query retrieves everything but duplicates data across documents. With foreign-keys, you need multiple sequential queries (N+1 pattern risk) but maintain a single source of truth. Choose based on: (1) how data is accessed together, (2) update frequency, (3) data size, and (4) acceptable duplication trade-offs. Embedded data optimizes read performance at the cost of write overhead and storage; foreign-keys optimize write performance and storage at the cost of multiple queries.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-2-3">
            </div>
            <div class="item-title">Avoid storing large binary data directly in documents</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Don't store images, videos, or large files as base64 strings in document fields. Use Ditto attachments instead.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Large binary data in documents bloats sync traffic and storage. Attachments are lazy-loaded and fetched on-demand, optimizing bandwidth and storage.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-2-4">
            </div>
            <div class="item-title">Don't store calculated/derived fields in documents</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Avoid storing fields that can be calculated from existing data (e.g., <code>lineTotal = price × quantity</code>, <code>subtotal = sum(items)</code>, <code>total = subtotal + tax</code>). Calculate these values in application code when needed.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Storing calculated fields wastes bandwidth (syncs unnecessary data), creates risk of stale data (source changes but calculated field doesn't update), and adds synchronization overhead. Calculate on-demand instead.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-2-4')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-2-4">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Storing calculated values (wastes bandwidth, risk of stale data)</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;order_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;items&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;item_1&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;price&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">12.99</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;quantity&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lineTotal&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">25.98</span><span class="p">}</span><span class="w">  </span><span class="c1">// ❌ Calculated!</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s2">&quot;subtotal&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">25.98</span><span class="p">,</span><span class="w">  </span><span class="c1">// ❌ Calculated!</span>
<span class="w">  </span><span class="s2">&quot;tax&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">2.60</span><span class="p">,</span><span class="w">        </span><span class="c1">// ❌ Calculated!</span>
<span class="w">  </span><span class="s2">&quot;total&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">28.58</span><span class="w">      </span><span class="c1">// ❌ Calculated!</span>
<span class="p">}</span>

<span class="c1">// ✅ GOOD: Store only source data, calculate in app</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;order_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;items&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;item_1&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;price&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">12.99</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;quantity&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">2</span><span class="p">}</span><span class="w">  </span><span class="c1">// Source data only</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Calculate on-demand in application</span>
<span class="kt">double</span><span class="w"> </span><span class="n">calculateLineTotal</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="n">calculateTotal</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">taxRate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">subtotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">items</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">fold</span><span class="p">(</span><span class="m">0.0</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="n">sum</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]));</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">subtotal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">subtotal</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">taxRate</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-2-5">
            </div>
            <div class="item-title">Exclude unnecessary data from documents</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Every field in a Ditto document syncs across all peers in the mesh network, consuming bandwidth and storage. Only include data that represents shared business state needed across devices. Don't sync:</p>
<ul>
<li><strong>UI-specific state</strong>: Expansion/selection/hover states, scroll positions, active tab indices</li>
<li><strong>Temporary/transient state</strong>: Upload progress, processing flags, retry counters, loading indicators</li>
<li><strong>Device-specific data</strong>: Local file paths, device IDs (unless required for authorization), device capabilities</li>
<li><strong>Cached/derived data</strong>: Values that can be calculated from other fields or fetched from external sources</li>
<li><strong>High-frequency ephemeral data</strong>: Mouse cursor positions, typing indicators, real-time sensor readings that don't need persistence</li>
<li><strong>Debug/development data</strong>: Test flags, debug counters, development-only metadata</li>
</ul>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Syncing unnecessary data wastes network bandwidth (critical for metered connections), drains battery (continuous sync), bloats storage on all devices, and slows sync performance for important business data. Every peer must store, process, and relay this data, even though much of it is only relevant to a single device or moment in time.</p>
<p><strong>Key principle:</strong> Only sync data that represents <strong>business state</strong> (the "single source of truth" needed across devices), not <strong>presentation state</strong> (how UI displays data), <strong>transient state</strong> (temporary processing status), or <strong>device-local state</strong> (specific to one device's environment).</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-2-5')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-2-5">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Syncing unnecessary data</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;task_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Review PR&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// ❌ UI state (device-specific, not business data)</span>
<span class="w">  </span><span class="s2">&quot;isExpanded&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;selectedTab&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">2</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// ❌ Temporary state (transient, changes frequently)</span>
<span class="w">  </span><span class="s2">&quot;uploadProgress&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">67</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;isProcessing&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// ❌ Device-specific (only relevant to one device)</span>
<span class="w">  </span><span class="s2">&quot;localFilePath&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;/storage/cache/task_123.tmp&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// ❌ Cached data (can be fetched from external source)</span>
<span class="w">  </span><span class="s2">&quot;userAvatarUrl&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;https://api.example.com/avatars/user_789.jpg&quot;</span>
<span class="p">}</span>

<span class="c1">// ✅ GOOD: Only business state synced, other data managed locally</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;task_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Review PR&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;assignee&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user_789&quot;</span><span class="w">  </span><span class="c1">// Business data: who&#39;s responsible</span>
<span class="p">}</span>

<span class="c1">// Store non-business state locally (ViewModel, cache, device storage):</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">TaskViewModel</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="n">task</span><span class="p">;</span><span class="w">  </span><span class="c1">// Ditto business data</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">isExpanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// UI state (local)</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">uploadProgress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.0</span><span class="p">;</span><span class="w">  </span><span class="c1">// Temporary state (local)</span>
<span class="w">  </span><span class="kt">String</span><span class="o">?</span><span class="w"> </span><span class="n">cachedAvatarUrl</span><span class="p">;</span><span class="w">  </span><span class="c1">// Cached data (fetched as needed)</span>
<span class="p">}</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-2-6">
            </div>
            <div class="item-title">Enable DQL Strict Mode for type safety across peers [SDK 4.11+]</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Execute <code>ALTER SYSTEM SET DQL_STRICT_MODE = true</code> before <code>startSync()</code> to enforce type consistency across all fields. This prevents different devices from writing incompatible types to the same field.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Without Strict Mode, Device A can write <code>{"age": 30}</code> (number) while Device B writes <code>{"age": "thirty"}</code> (string), causing cross-peer data inconsistency and unpredictable query results. Strict Mode enforces type declarations via MAP literals, catching type errors at development time instead of runtime.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="section-3">
      <div class="section-header" onclick="toggleSection('section-3')">
        <h2 class="section-title"><span class="section-number">Section 3:</span> Write Operations</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-3-0">
            </div>
            <div class="item-title">Use field-level UPDATE instead of full document replacement</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Update only specific fields using <code>UPDATE collection SET field = :value WHERE ...</code> instead of re-inserting entire documents with <code>INSERT ... ON ID CONFLICT DO UPDATE</code>.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Full document replacement treats all fields as changed, creating unnecessary sync deltas even for unchanged values. Field-level updates minimize sync traffic and reduce conflict potential.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-3-0')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-3-0">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Full document replacement (unnecessary sync traffic)</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;INSERT INTO orders DOCUMENTS (:order) ON ID CONFLICT DO UPDATE&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;order&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;o1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;status&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;done&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;customer&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;c1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;items&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[...]}</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">);</span>

<span class="c1">// ✅ GOOD: Field-level update (only changed field syncs)</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;UPDATE orders SET status = :status WHERE _id = :id&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;o1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;status&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;done&#39;</span><span class="p">},</span>
<span class="p">);</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-3-1">
            </div>
            <div class="item-title">Avoid updating fields with the same value unnecessarily</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Before executing an UPDATE statement, query the document to check if the new value differs from the current value. Skip the UPDATE if the values are identical.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Even when updating a field with the same value (e.g., setting <code>status = "pending"</code> when it's already <code>"pending"</code>), Ditto treats this as a change and creates a sync delta. This delta is transmitted to all peers across the mesh network, consuming bandwidth and triggering observer callbacks unnecessarily. The underlying CRDT counter increments regardless of whether the value actually changed, causing every peer to process the update. By checking before updating, you avoid this unnecessary network traffic, reduce sync overhead, and prevent redundant UI updates across all connected devices. This is particularly important in high-frequency update scenarios where the same value might be set repeatedly (e.g., periodic status checks, polling loops, or user interactions).</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-3-2">
            </div>
            <div class="item-title">Use DO UPDATE_LOCAL_DIFF for efficient upserts [SDK 4.12+]</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>When upserting documents with <code>ON ID CONFLICT</code>, use <code>DO UPDATE_LOCAL_DIFF</code> instead of <code>DO UPDATE</code> to avoid syncing unchanged field values.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p><code>DO UPDATE</code> treats all fields as changed and syncs them as deltas, even if values are identical. <code>DO UPDATE_LOCAL_DIFF</code> compares incoming vs existing documents and only syncs fields that actually differ, reducing network traffic.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-3-2')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-3-2">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: DO UPDATE syncs ALL fields (even unchanged)</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;INSERT INTO orders DOCUMENTS (:order) ON ID CONFLICT DO UPDATE&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;order&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;o1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;status&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;done&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;customer&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;c1&#39;</span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">);</span>

<span class="c1">// ✅ GOOD: DO UPDATE_LOCAL_DIFF only syncs changed fields (SDK 4.12+)</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;INSERT INTO orders DOCUMENTS (:order) ON ID CONFLICT DO UPDATE_LOCAL_DIFF&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;order&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;o1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;status&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;done&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;customer&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;c1&#39;</span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">);</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-3-3">
            </div>
            <div class="item-title">Use COUNTER type for distributed counters [SDK 4.14.0+]</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>For counters that may be updated concurrently by multiple peers, use <code>COUNTER</code> type with <code>INCREMENT BY</code> operation instead of SET operations.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>SET operations perform read-modify-write, causing lost updates when devices are disconnected. COUNTER operations merge correctly across concurrent updates using commutative CRDT semantics.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-3-3')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-3-3">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: SET operation for counters (lost updates)</span>
<span class="kd">final</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM products WHERE _id = :id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;p1&#39;</span><span class="p">}</span>
<span class="p">)).</span><span class="n">items</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;UPDATE products SET viewCount = :count WHERE _id = :id&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;viewCount&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;p1&#39;</span><span class="p">},</span>
<span class="p">);</span>

<span class="c1">// ✅ GOOD: COUNTER type for distributed counters (SDK 4.14.0+)</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;UPDATE products APPLY viewCount COUNTER INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;p1&#39;</span><span class="p">},</span>
<span class="p">);</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-3-4">
            </div>
            <div class="item-title">Don't use counters for derived values that can be calculated</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Avoid maintaining counter fields that represent aggregated or calculated values from other data sources. Instead, calculate these values from the source data when needed. Common anti-patterns include:</p>
<ul>
<li><strong>Inventory counters</strong>: Don't maintain <code>currentStock</code> as a counter field—calculate it from order/transaction history</li>
<li><strong>Relationship counts</strong>: Don't maintain <code>followerCount</code> updated from <code>followers</code> collection—query and count when needed</li>
<li><strong>Status tallies</strong>: Don't maintain <code>completedTaskCount</code> from <code>tasks</code> collection—query with filters</li>
</ul>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Counters for derived values create several problems:</p>
<p>1. <strong>Cross-collection synchronization complexity</strong>: Updating source data (e.g., orders) requires also updating counters in other collections (e.g., products), creating tight coupling</p>
<p>2. <strong>Data integrity risk</strong>: Source data and counters can become inconsistent if updates fail partially or sync in wrong order</p>
<p>3. <strong>Not self-correcting</strong>: If counters drift out of sync due to bugs or data issues, they don't auto-correct. Calculated values are always accurate based on current source data.</p>
<p>4. <strong>Single source of truth violation</strong>: Maintains redundant state that must be kept synchronized</p>
<p><strong>When counters ARE appropriate:</strong> Use counters (COUNTER type with PN_INCREMENT) for <strong>independent, additive data</strong> where each increment is a standalone event:</p>
<ul>
<li>✅ View counts (each view is independent)</li>
<li>✅ Like counts (each like is independent)</li>
<li>✅ Usage metrics (each usage event is independent)</li>
<li>✅ Vote tallies (each vote is independent)</li>
</ul>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-3-4')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-3-4">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Using counter for derived inventory value</span>
<span class="c1">// Product document maintains currentStock counter</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;product_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Coffee Beans&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;currentStock&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">50</span><span class="w">  </span><span class="c1">// ❌ Counter updated from orders collection</span>
<span class="p">}</span>

<span class="c1">// When order is placed, must update TWO collections:</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;order&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;o1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;productId&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;product_123&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;qty&#39;</span><span class="o">:</span><span class="w"> </span><span class="m">5</span><span class="p">}}</span>
<span class="p">);</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;UPDATE products APPLY currentStock PN_INCREMENT BY -5.0 WHERE _id = :id&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;product_123&#39;</span><span class="p">}</span>
<span class="p">);</span>
<span class="c1">// Problems: Cross-collection coupling, integrity risk, not self-correcting</span>

<span class="c1">// ✅ GOOD: Calculate inventory from order history</span>
<span class="c1">// Product document has no stock counter</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;product_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Coffee Beans&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;initialStock&quot;</span><span class="o">:</span><span class="w"> </span><span class="m">100</span><span class="w">  </span><span class="c1">// Starting inventory (baseline)</span>
<span class="p">}</span>

<span class="c1">// Order documents are source of truth</span>
<span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;o1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;productId&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;product_123&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;qty&#39;</span><span class="o">:</span><span class="w"> </span><span class="m">5</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;o2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;productId&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;product_123&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;qty&#39;</span><span class="o">:</span><span class="w"> </span><span class="m">10</span><span class="p">}</span>

<span class="c1">// Calculate current stock from orders when needed:</span>
<span class="kt">int</span><span class="w"> </span><span class="n">calculateCurrentStock</span><span class="p">(</span><span class="kt">String</span><span class="w"> </span><span class="n">productId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getProduct</span><span class="p">(</span><span class="n">productId</span><span class="p">);</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOrders</span><span class="p">(</span><span class="n">productId</span><span class="p">);</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">totalOrdered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="n">fold</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">sum</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;initialStock&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">totalOrdered</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// Benefits: Single source of truth, self-correcting, no cross-collection updates</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-3-5">
            </div>
            <div class="item-title">Use separate documents for event history, not arrays</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>For append-only logs (status history, audit trails), INSERT a new document for each event instead of appending to an array field.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Arrays are REGISTER CRDTs (Last-Write-Wins). Concurrent appends from offline peers result in lost events after merge. Separate documents allow all events to be preserved independently.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-3-6">
            </div>
            <div class="item-title">Use INITIAL DOCUMENTS for device-local templates</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>For device-local default data (categories, templates, seed data), use <code>INSERT INTO collection INITIAL DOCUMENTS (...)</code> instead of regular <code>INSERT</code>.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Regular INSERT creates sync deltas that propagate to all peers unnecessarily. <code>INITIAL DOCUMENTS</code> treats data as "existing from the beginning of time," preventing sync traffic for device-local templates.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="section-4">
      <div class="section-header" onclick="toggleSection('section-4')">
        <h2 class="section-title"><span class="section-number">Section 4:</span> Deletion & Storage Lifecycle</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-4-0">
            </div>
            <div class="item-title">Understand the difference between Soft-Delete and DELETE queries</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>In distributed databases like Ditto, deleting data on one device doesn't automatically remove it from others. Both approaches are <strong>deletion propagation mechanisms</strong> with different trade-offs:</p>
<ul>
<li><strong>Soft-Delete Pattern</strong>: Developer-implemented pattern using UPDATE operations to mark documents as deleted (e.g., <code>UPDATE orders SET isDeleted = true WHERE _id = :id</code>). Deletion flags propagate through the mesh network like any other field update. Filter deleted documents in queries/observers, then periodically remove them locally with EVICT.</li>
<li><strong>DELETE query</strong>: Built-in operation that physically removes documents and automatically creates Tombstones (compressed deletion markers with 30-day TTL on Cloud, configurable on Edge SDK). Tombstones propagate through the mesh to notify peers about deletions.</li>
</ul>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Both approaches eventually result in permanent data removal. The choice is about <strong>how deletion information propagates</strong> through the mesh:</p>
<p><strong>Soft-Delete propagation advantages:</strong></p>
<ul>
<li>✅ No TTL dependency: Deletion flags persist until EVICT, so long-offline devices always receive deletion notifications</li>
<li>✅ CRDT-safe: UPDATE operations merge cleanly, preventing husked documents from concurrent DELETE + UPDATE conflicts</li>
<li>✅ Reliable multi-hop relay: Deletion flags propagate through intermediary peers like any other field update</li>
</ul>
<p><strong>Soft-Delete propagation disadvantages:</strong></p>
<ul>
<li>❌ Higher code complexity: Must filter <code>isDeleted</code> consistently in all queries and observers</li>
<li>❌ Implementation discipline required: Easy to forget filtering or incorrectly filter in subscriptions (breaks relay)</li>
<li>❌ Larger dataset until EVICT: Slightly slower queries as deleted documents remain in database</li>
<li>❌ Manual cleanup required: Must implement periodic EVICT to permanently remove old deleted documents</li>
</ul>
<p><strong>DELETE propagation advantages:</strong></p>
<ul>
<li>✅ Simpler implementation: Automatic Tombstone creation and propagation, no filtering logic needed</li>
<li>✅ Smaller active dataset: Documents removed immediately, faster queries after Tombstone TTL expires</li>
<li>✅ Automatic cleanup: Tombstones expire automatically after TTL period</li>
</ul>
<p><strong>DELETE propagation disadvantages:</strong></p>
<ul>
<li>❌ TTL-based propagation: Devices offline longer than TTL miss deletion notification, may resurrect deleted data (zombie data)</li>
<li>❌ CRDT conflicts possible: Concurrent DELETE + UPDATE from different peers can create husked documents (partial null fields)</li>
<li>❌ Tombstone propagation timing: Brief window during multi-hop relay before all peers receive Tombstones</li>
</ul>
<p><strong>Choose based on your application's requirements:</strong></p>
<ul>
<li><strong>Use Soft-Delete</strong> when: Devices may be offline longer than Tombstone TTL (>30 days Cloud, >configured Edge), concurrent DELETE + UPDATE scenarios are likely, or reliable multi-hop relay propagation is critical for your use case</li>
<li><strong>Use DELETE</strong> when: All devices sync regularly within Tombstone TTL period, temporary/ephemeral data with short lifecycle, simpler implementation is preferred, or concurrent DELETE + UPDATE scenarios are unlikely</li>
</ul>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-4-1">
            </div>
            <div class="item-title">(If using Soft-Delete) Subscribe broadly, filter in observers/queries</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>When implementing Soft-Delete with an <code>isDeleted</code> flag:</p>
<ul>
<li><strong>Subscriptions</strong>: <code>SELECT * FROM orders</code> (no <code>isDeleted</code> filter)</li>
<li><strong>Observers</strong>: <code>SELECT * FROM orders WHERE isDeleted != true</code></li>
<li><strong>Queries</strong>: <code>SELECT * FROM orders WHERE isDeleted != true</code></li>
</ul>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Filtering deletion flags in subscriptions breaks multi-hop relay. Intermediate devices won't store deleted documents, preventing deletion notifications from reaching indirectly connected peers. Subscribe broadly for relay, filter locally for display. This is a critical implementation pattern only for Soft-Delete—if using DELETE queries, this does not apply.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-4-1')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-4-1">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ WRONG: Filtering deletion flags in subscriptions</span>
<span class="kd">final</span><span class="w"> </span><span class="n">subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM orders WHERE isDeleted != true&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">// Blocks relay!</span>
<span class="p">);</span>

<span class="c1">// ✅ CORRECT: Subscribe broadly, filter in observer</span>
<span class="kd">final</span><span class="w"> </span><span class="n">subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">// No filter - allows multi-hop relay</span>
<span class="p">);</span>
<span class="kd">final</span><span class="w"> </span><span class="n">observer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">registerObserverWithSignalNext</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM orders WHERE isDeleted != true&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">// Filter here</span>
<span class="w">  </span><span class="nl">onChange:</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">signalNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">updateUI</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">items</span><span class="p">);</span>
<span class="w">    </span><span class="n">signalNext</span><span class="p">();</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">);</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-4-2">
            </div>
            <div class="item-title">(If using Soft-Delete) Periodically EVICT old deleted documents</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>After marking documents as deleted (e.g., <code>isDeleted: true, deletedAt: &lt;timestamp&gt;</code>), periodically run <code>EVICT FROM collection WHERE isDeleted = true AND deletedAt &lt; :cutoff</code> to free local storage. Choose an appropriate retention period (e.g., 30-90 days).</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Soft-Delete keeps documents in the database indefinitely, consuming storage. Eviction removes old deleted documents from local storage without affecting peers (EVICT is local-only, not DELETE). This prevents storage bloat while maintaining multi-hop relay during the retention period.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-4-3">
            </div>
            <div class="item-title">(If using Soft-Delete) Use EVICT for local-only removal</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p><code>EVICT FROM collection WHERE ...</code> removes documents from local storage only. Peers retain their copies and can re-share evicted documents later.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>EVICT frees local storage without affecting other devices. Useful for clearing caches, removing old data, or managing storage limits on resource-constrained devices. This is critical for Soft-Delete cleanup—EVICT removes documents locally after the retention period without affecting multi-hop relay.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-4-4">
            </div>
            <div class="item-title">(If using Soft-Delete) Cancel subscriptions before EVICT to prevent resync loops</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>When evicting documents from local storage, cancel the corresponding subscription first, then EVICT, then recreate the subscription with an updated filter if needed.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Evicting documents while a subscription is active causes Ditto to immediately request them again from peers, creating an infinite resync loop that wastes network bandwidth and battery.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-4-4')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-4-4">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: EVICT without canceling subscription (resync loop!)</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;EVICT FROM orders WHERE deletedAt &lt; :cutoff&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;cutoff&#39;</span><span class="o">:</span><span class="w"> </span><span class="n">cutoffDate</span><span class="p">},</span>
<span class="p">);</span>

<span class="c1">// ✅ GOOD: Cancel subscription → EVICT → Recreate with updated filter</span>
<span class="n">orderSubscription</span><span class="o">?</span><span class="p">.</span><span class="n">cancel</span><span class="p">();</span><span class="w">  </span><span class="c1">// Step 1: Cancel first</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;EVICT FROM orders WHERE isDeleted = true AND deletedAt &lt; :cutoff&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;cutoff&#39;</span><span class="o">:</span><span class="w"> </span><span class="n">cutoffDate</span><span class="p">},</span>
<span class="p">);</span>
<span class="n">orderSubscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM orders WHERE isDeleted != true&#39;</span><span class="p">,</span>
<span class="p">);</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-4-5">
            </div>
            <div class="item-title">(If using DELETE) Understand tombstones and TTL behavior</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>When you DELETE a document, Ditto creates a tombstone that propagates to peers during the TTL window (default: 30 days). After TTL expires, the tombstone is removed, and peers who were offline during the entire TTL window may re-share the document ("zombie resurrection").</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Tombstones are Ditto's built-in deletion propagation mechanism that automatically notifies all peers about deletions. However, Tombstones only exist during the TTL period. If a peer is offline longer than the TTL (e.g., 35 days on Cloud), they miss the deletion notification and may resurrect deleted data when they reconnect. For applications where devices may be offline longer than the TTL period, Soft-Delete provides more reliable deletion propagation as flags persist indefinitely until EVICT.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-4-6">
            </div>
            <div class="item-title">(If using DELETE) Understand husked documents and how to prevent them</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>"Husked documents" occur when one peer DELETEs a document while another peer concurrently UPDATEs it. After merge, the document exists but has only <code>_id</code> and the updated field(s), with all other fields set to null.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Husked documents can break application logic that assumes required fields always exist. Soft-Delete prevents husking by using UPDATE instead of DELETE.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-4-6')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-4-6">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ PROBLEM: DELETE + concurrent UPDATE = husked document</span>
<span class="c1">// Device A:</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM cars WHERE _id = :id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;car1&#39;</span><span class="p">});</span>
<span class="c1">// Device B (offline):</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;UPDATE cars SET color = :color WHERE _id = :id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;car1&#39;</span><span class="p">});</span>
<span class="c1">// Result after sync: {_id: &quot;car1&quot;, color: &quot;blue&quot;, make: null, model: null}</span>

<span class="c1">// ✅ SOLUTION: Soft-Delete prevents husked documents</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;UPDATE cars SET isDeleted = true, deletedAt = :time WHERE _id = :id&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="o">:</span><span class="w"> </span><span class="n">DateTime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">toIso8601String</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;car1&#39;</span><span class="p">},</span>
<span class="p">);</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-4-7">
            </div>
            <div class="item-title">(If using DELETE) Use DELETE only for permanent, irreversible removal</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p><code>DELETE FROM collection WHERE ...</code> permanently removes documents from all peers in the mesh. Deletion propagates via tombstones during the TTL period (default: 30 days).</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>DELETE is irreversible and propagates via Tombstones to all peers. Both Soft-Delete and DELETE eventually result in permanent data removal—the difference is the propagation mechanism. DELETE works well for:</p>
<ul>
<li>Temporary/ephemeral data with short lifecycle</li>
<li>Scenarios where all devices sync regularly within TTL period</li>
<li>Simpler implementation is preferred</li>
</ul>
<p>For applications where devices may be offline longer than Tombstone TTL, or where concurrent DELETE + UPDATE scenarios are likely, Soft-Delete provides more reliable deletion propagation through UPDATE-based flags that persist until EVICT.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="section-5">
      <div class="section-header" onclick="toggleSection('section-5')">
        <h2 class="section-title"><span class="section-number">Section 5:</span> Read Operations & Queries</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-5-0">
            </div>
            <div class="item-title">Filter data in queries, not in application code</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Use DQL <code>WHERE</code> clauses to filter data at the database level instead of fetching all documents and filtering in application code.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Database-level filtering reduces memory usage, improves query performance, and minimizes data transfer overhead. When you fetch all documents and filter in application code, Ditto must:</p>
<p>1. Load all documents from storage into memory</p>
<p>2. Deserialize all documents from internal format (CBOR) to application objects</p>
<p>3. Allocate memory for QueryResultItems that hold references to underlying data structures</p>
<p>This creates unnecessary memory pressure, especially on resource-constrained devices. Database-level filtering (WHERE clauses) happens inside Ditto's storage engine before deserialization, minimizing memory allocation and processing overhead. For large collections (thousands of documents), the performance difference is significant: application-level filtering can cause memory issues or slow performance, while database filtering keeps memory usage constant regardless of collection size.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-5-0')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-5-0">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Fetch all documents, filter in application code</span>
<span class="kd">final</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">);</span>
<span class="kd">final</span><span class="w"> </span><span class="n">activeOrders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">items</span>
<span class="w">  </span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">toList</span><span class="p">();</span>
<span class="c1">// Problems: High memory usage, slow deserialization, all documents loaded</span>

<span class="c1">// ✅ GOOD: Filter at database level with WHERE clause</span>
<span class="kd">final</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM orders WHERE status = :status&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="p">},</span>
<span class="p">);</span>
<span class="kd">final</span><span class="w"> </span><span class="n">activeOrders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="n">toList</span><span class="p">();</span>
<span class="c1">// Benefits: Low memory usage, fast query, only filtered documents loaded</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-5-1">
            </div>
            <div class="item-title">Use query result pagination for large datasets</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>For collections with thousands of documents, use <code>LIMIT</code> and <code>OFFSET</code> in queries to paginate results rather than fetching all documents at once.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Large result sets consume memory and slow down UI rendering. Pagination improves app responsiveness and reduces memory pressure.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-5-2">
            </div>
            <div class="item-title">Don't retain QueryResultItem references long-term</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Extract <code>item.value</code> from QueryResultItems immediately and convert to application models. Don't store QueryResultItems in state, pass them between functions, or hold references beyond the immediate callback scope.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>QueryResultItems are lazy-loading database cursors, not plain data objects. They hold internal references to Ditto's storage engine and underlying CRDT data structures. Retaining QueryResultItems long-term causes:</p>
<p>1. <strong>Memory leaks</strong>: Prevents Ditto from releasing memory for internal data structures</p>
<p>2. <strong>Blocked garbage collection</strong>: Holds references that prevent cleanup of processed results</p>
<p>3. <strong>Unpredictable behavior</strong>: Cursors may become stale if underlying data changes</p>
<p>4. <strong>Resource exhaustion</strong>: Accumulating cursors consumes memory proportional to query result count</p>
<p><strong>Best practice:</strong> Extract data immediately in observer callbacks or query handlers, convert to plain Dart objects or application models, and let QueryResultItems fall out of scope for garbage collection.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-5-2')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-5-2">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Retaining QueryResultItem references (memory leak)</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">OrdersViewModel</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">QueryResultItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_orderItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w">  </span><span class="c1">// ❌ Storing cursors!</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">updateOrders</span><span class="p">(</span><span class="n">QueryResult</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_orderItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">toList</span><span class="p">();</span><span class="w">  </span><span class="c1">// ❌ Long-lived references</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">displayOrder</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_orderItems</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">value</span><span class="p">;</span><span class="w">  </span><span class="c1">// ❌ Using stale cursor</span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Order: </span><span class="si">${</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="c1">// Problem: Holds QueryResultItem cursors indefinitely, memory never released</span>

<span class="c1">// ✅ GOOD: Extract data immediately, store plain objects</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">OrdersViewModel</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_orders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w">  </span><span class="c1">// ✅ Plain application models</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">updateOrders</span><span class="p">(</span><span class="n">QueryResult</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Extract data immediately and convert to models</span>
<span class="w">    </span><span class="n">_orders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">items</span>
<span class="w">      </span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Order</span><span class="p">.</span><span class="n">fromMap</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">))</span>
<span class="w">      </span><span class="p">.</span><span class="n">toList</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// QueryResultItems fall out of scope here, GC can clean them up</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">displayOrder</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_orders</span><span class="p">[</span><span class="n">index</span><span class="p">];</span><span class="w">  </span><span class="c1">// ✅ Using plain model</span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Order: </span><span class="si">${</span><span class="n">order</span><span class="p">.</span><span class="n">title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Application model (plain Dart class)</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">Order</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">title</span><span class="p">;</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>

<span class="w">  </span><span class="n">Order</span><span class="p">({</span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">status</span><span class="p">});</span>

<span class="w">  </span><span class="kd">factory</span><span class="w"> </span><span class="n">Order</span><span class="p">.</span><span class="n">fromMap</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Order</span><span class="p">(</span>
<span class="w">      </span><span class="nl">id:</span><span class="w"> </span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">      </span><span class="nl">title:</span><span class="w"> </span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">      </span><span class="nl">status:</span><span class="w"> </span><span class="n">map</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="section-6">
      <div class="section-header" onclick="toggleSection('section-6')">
        <h2 class="section-title"><span class="section-number">Section 6:</span> Subscriptions & Real-time Sync</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-6-0">
            </div>
            <div class="item-title">Use long-lived subscriptions, not request/response pattern</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Create subscriptions once during app initialization or when entering a feature, keep them active while the feature is in use, and cancel only when leaving the feature. Don't create/cancel subscriptions repeatedly for each query.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Subscriptions are not HTTP requests—they're long-lived replication contracts that tell Ditto what data to sync. Frequent create/cancel cycles cause unnecessary connection overhead, delays in data availability, and increased battery usage. Ditto is offline-first: data should be continuously synced, not fetched on-demand.</p>
<p><strong>Common mistake:</strong> Treating Ditto like a REST API by creating a subscription, waiting briefly, querying data, and immediately canceling. This defeats the purpose of mesh sync and prevents real-time updates from reaching your device.</p>
<p><strong>When to cancel subscriptions:</strong></p>
<ul>
<li>✅ When a feature/screen is permanently closed (not just hidden temporarily)</li>
<li>✅ Before EVICT operations to prevent resync loops</li>
<li>✅ When subscription scope needs to change (cancel old, create new with updated query)</li>
<li>✅ During app termination for proper cleanup</li>
</ul>
<p><strong>When NOT to cancel:</strong></p>
<ul>
<li>❌ Between individual queries to the same data</li>
<li>❌ During temporary UI state changes (navigation, minimize/maximize)</li>
<li>❌ After every data read operation</li>
</ul>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-6-0')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-6-0">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Request/response pattern (treating Ditto like HTTP)</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">fetchOrders</span><span class="p">()</span><span class="w"> </span><span class="kd">async</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">await</span><span class="w"> </span><span class="n">Future</span><span class="p">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">Duration</span><span class="p">(</span><span class="nl">seconds:</span><span class="w"> </span><span class="m">2</span><span class="p">));</span><span class="w">  </span><span class="c1">// Inefficient waiting!</span>
<span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="n">sub</span><span class="p">.</span><span class="n">cancel</span><span class="p">();</span><span class="w">  </span><span class="c1">// Defeats mesh sync benefits</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Order</span><span class="p">.</span><span class="n">fromMap</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">)).</span><span class="n">toList</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// ✅ GOOD: Long-lived subscription with observer for real-time updates</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">OrdersService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Subscription</span><span class="o">?</span><span class="w"> </span><span class="n">_subscription</span><span class="p">;</span>
<span class="w">  </span><span class="n">StoreObserver</span><span class="o">?</span><span class="w"> </span><span class="n">_observer</span><span class="p">;</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Start subscription - keep alive for feature lifetime</span>
<span class="w">    </span><span class="n">_subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Use observer for real-time updates</span>
<span class="w">    </span><span class="n">_observer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">registerObserverWithSignalNext</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nl">onChange:</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">signalNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">updateUI</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Order</span><span class="p">.</span><span class="n">fromMap</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">)));</span>
<span class="w">        </span><span class="n">signalNext</span><span class="p">();</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">dispose</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_observer</span><span class="o">?</span><span class="p">.</span><span class="n">cancel</span><span class="p">();</span>
<span class="w">    </span><span class="n">_subscription</span><span class="o">?</span><span class="p">.</span><span class="n">cancel</span><span class="p">();</span><span class="w">  </span><span class="c1">// Cancel only when feature is done</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-6-1">
            </div>
            <div class="item-title">Subscribe broadly, filter in observers (for multi-hop relay)</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Subscriptions should have minimal WHERE filters (or none for small collections). Apply detailed filters in observers and queries instead.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Narrow subscription filters prevent relay devices from storing documents needed by indirectly connected peers. Broad subscriptions enable multi-hop relay; local filters optimize UI display.</p>
<p><strong>The multi-hop relay problem:</strong> Consider a mesh network with Device A (source) → Device B (relay) → Device C (destination). If Device B subscribes with a narrow filter like <code>WHERE priority = 'high'</code>, it won't store low-priority documents from Device A. When Device C subscribes to all orders, it never receives the low-priority documents because Device B (the relay) doesn't have them to forward. This breaks multi-hop relay for filtered-out documents.</p>
<p><strong>Solution:</strong> Device B subscribes broadly without priority filters, stores all documents, and can relay everything to Device C. Each device filters locally in observers/queries for UI display only.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-6-1')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-6-1">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Narrow subscription filter breaks multi-hop relay</span>
<span class="kd">final</span><span class="w"> </span><span class="n">subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM orders WHERE priority = :priority&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;priority&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;high&#39;</span><span class="p">},</span>
<span class="p">);</span>
<span class="c1">// Problem: This device won&#39;t store/relay low-priority orders to other peers</span>

<span class="c1">// ✅ GOOD: Broad subscription + local filter in observer</span>
<span class="kd">final</span><span class="w"> </span><span class="n">subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">// No priority filter - enables relay</span>
<span class="p">);</span>

<span class="kd">final</span><span class="w"> </span><span class="n">observer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">registerObserverWithSignalNext</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM orders WHERE priority = :priority&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">// Filter here for UI</span>
<span class="w">  </span><span class="nl">onChange:</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">signalNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">updateUI</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">items</span><span class="p">);</span><span class="w">  </span><span class="c1">// Only high-priority orders displayed</span>
<span class="w">    </span><span class="n">signalNext</span><span class="p">();</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;priority&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;high&#39;</span><span class="p">},</span>
<span class="p">);</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-6-2">
            </div>
            <div class="item-title">Avoid subscribing to data you don't need</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Scope subscriptions to relevant collections and use appropriate WHERE filters to limit data to what your feature actually needs. Avoid subscribing to entire collections without any filtering when only a subset is required.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Every subscription tells Ditto to sync and store matching documents locally. Overly broad subscriptions cause:</p>
<p>1. <strong>Storage bloat</strong>: Unnecessary documents consume device storage</p>
<p>2. <strong>Network waste</strong>: Syncing documents you'll never use consumes bandwidth and battery</p>
<p>3. <strong>Memory pressure</strong>: Larger local datasets increase memory usage during queries</p>
<p>4. <strong>Performance degradation</strong>: More documents to scan during queries, even if filtered in observers</p>
<p><strong>Balance with multi-hop relay:</strong> While you should avoid unnecessary data, remember that subscriptions too narrow can break multi-hop relay (see "Subscribe broadly, filter in observers"). The goal is to subscribe to data that's relevant to your feature or needed for relay, not everything in the database.</p>
<p><strong>Examples of appropriate scoping:</strong></p>
<ul>
<li>✅ Subscribe to orders for a specific customer: <code>WHERE customerId = :id</code></li>
<li>✅ Subscribe to recent data: <code>WHERE createdAt &gt; :cutoff</code></li>
<li>✅ Subscribe to data in relevant states: <code>WHERE status IN ('pending', 'active', 'completed')</code></li>
<li>❌ Subscribe to all orders across all customers when you only display one customer's data</li>
<li>❌ Subscribe to historical data (>1 year old) when your feature only shows recent activity</li>
</ul>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-6-2')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-6-2">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Overly broad subscription when feature only displays current user&#39;s data</span>
<span class="kd">final</span><span class="w"> </span><span class="n">subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">// Syncs ALL orders from ALL users!</span>
<span class="p">);</span>

<span class="c1">// ✅ GOOD: Scoped to relevant customer</span>
<span class="kd">final</span><span class="w"> </span><span class="n">subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM orders WHERE customerId = :customerId&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;customerId&#39;</span><span class="o">:</span><span class="w"> </span><span class="n">currentUserId</span><span class="p">},</span>
<span class="p">);</span>
<span class="c1">// Only syncs orders for this customer</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-6-3">
            </div>
            <div class="item-title">Cancel observers and subscriptions when no longer needed</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Store references to observers and subscriptions, then call <code>.cancel()</code> when the feature is closed or the widget is disposed.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Observers and subscriptions continue running until explicitly canceled. Failing to cancel them causes:</p>
<p>1. <strong>Memory leaks</strong>: Observers hold references to callbacks, preventing garbage collection</p>
<p>2. <strong>Wasted resources</strong>: Continued processing of database changes and network updates for features no longer in use</p>
<p>3. <strong>Unnecessary network traffic</strong>: Active subscriptions keep telling peers to send updates</p>
<p><strong>When to cancel:</strong></p>
<ul>
<li>When a screen/feature is permanently closed</li>
<li>When a widget is disposed (Flutter: in <code>dispose()</code> method)</li>
<li>Before EVICT operations (prevents resync loops)</li>
<li>During app termination</li>
</ul>
<p><strong>When NOT to cancel:</strong></p>
<ul>
<li>During temporary navigation (if returning soon)</li>
<li>When app goes to background (if feature remains relevant)</li>
</ul>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-6-3')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-6-3">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: No references saved, cannot cancel - memory leak</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">OrdersScreen</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">StatefulWidget</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@override</span>
<span class="w">  </span><span class="n">State</span><span class="o">&lt;</span><span class="n">OrdersScreen</span><span class="o">&gt;</span><span class="w"> </span><span class="n">createState</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_OrdersScreenState</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">_OrdersScreenState</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">State</span><span class="o">&lt;</span><span class="n">OrdersScreen</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@override</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">initState</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
<span class="w">    </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">registerObserverWithSignalNext</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nl">onChange:</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">signalNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="n">signalNext</span><span class="p">();</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ✅ GOOD: Save references and cancel in dispose()</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">_OrdersScreenState</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">State</span><span class="o">&lt;</span><span class="n">OrdersScreen</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Subscription</span><span class="o">?</span><span class="w"> </span><span class="n">_subscription</span><span class="p">;</span>
<span class="w">  </span><span class="n">StoreObserver</span><span class="o">?</span><span class="w"> </span><span class="n">_observer</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@override</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">initState</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
<span class="w">    </span><span class="n">_subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="kd">sync</span><span class="p">.</span><span class="n">registerSubscription</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">_observer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">registerObserverWithSignalNext</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;SELECT * FROM orders&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nl">onChange:</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">signalNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="n">signalNext</span><span class="p">();</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@override</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">dispose</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_observer</span><span class="o">?</span><span class="p">.</span><span class="n">cancel</span><span class="p">();</span>
<span class="w">    </span><span class="n">_subscription</span><span class="o">?</span><span class="p">.</span><span class="n">cancel</span><span class="p">();</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-6-4">
            </div>
            <div class="item-title">Use registerObserverWithSignalNext for backpressure control</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Use <code>registerObserverWithSignalNext()</code> instead of <code>registerObserver()</code> to control when the next observer event is delivered. Call <code>signalNext()</code> after processing each event.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Prevents observer events from overwhelming the UI when rapid changes occur. Backpressure control ensures UI updates complete before the next batch arrives, improving responsiveness and preventing frame drops.</p>
<p><strong>Platform availability:</strong></p>
<ul>
<li><strong>Non-Flutter platforms</strong> (iOS, Android, JavaScript, etc.): Recommended pattern available in SDK 4.x</li>
<li><strong>Flutter</strong>: Not available in SDK 4.x. Will be available in future SDK version. Use <code>registerObserver()</code> with manual debouncing if needed.</li>
</ul>
<p><strong>Code Example</strong> (Non-Flutter):</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-6-4')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-6-4">
            <pre><code class="highlight"><span></span><span class="c1">// ✅ GOOD: Observer with backpressure control</span>
<span class="kd">final</span><span class="w"> </span><span class="n">observer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">registerObserverWithSignalNext</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;SELECT * FROM sensor_data WHERE deviceId = :deviceId&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;deviceId&#39;</span><span class="o">:</span><span class="w"> </span><span class="n">deviceId</span><span class="p">},</span>
<span class="w">  </span><span class="nl">onChange:</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">signalNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">updateUI</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="n">toList</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// Call signalNext() when ready for next batch</span>
<span class="w">    </span><span class="n">signalNext</span><span class="p">();</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">);</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-6-5">
            </div>
            <div class="item-title">Handle observer errors gracefully</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Wrap observer callbacks in try-catch blocks to handle unexpected errors (e.g., JSON deserialization failures, type mismatches, malformed data).</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Unhandled observer errors can crash the app or leave UI in inconsistent state. Graceful error handling ensures app stability and prevents one malformed document from breaking the entire observer.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-6-6">
            </div>
            <div class="item-title">Avoid heavy computation in observer callbacks</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Keep observer callbacks lightweight. Offload heavy computation (data transformation, business logic) to background isolates or threads.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Observer callbacks block the UI thread. Heavy computation causes frame drops and unresponsive UI. Offloading ensures smooth user experience.</p>
<p><strong>Examples of heavy computation to avoid in observer callbacks:</strong></p>
<ul>
<li>Large JSON serialization/deserialization operations (e.g., <code>jsonEncode()</code> on hundreds of documents)</li>
<li>Complex data transformations or aggregations across many documents</li>
<li>Image processing or compression</li>
<li>Network requests or file I/O operations</li>
<li>Cryptographic operations (hashing, encryption)</li>
<li>Sorting or filtering large datasets in memory</li>
<li>Nested iterations over large collections</li>
</ul>
<p>Instead, extract raw data from <code>item.value</code> immediately and offload processing to background isolates (Flutter: <code>compute()</code>) or worker threads.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="section-7">
      <div class="section-header" onclick="toggleSection('section-7')">
        <h2 class="section-title"><span class="section-number">Section 7:</span> Performance Optimization</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-7-0">
            </div>
            <div class="item-title">Use CREATE INDEX for selective queries [SDK 4.12+]</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Create indexes on fields frequently used in WHERE clauses for queries that return a small subset of documents (high selectivity). Use <code>CREATE INDEX IF NOT EXISTS idx_name ON collection (field)</code>.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Indexes can improve query performance by up to 90% for selective queries (those returning <10% of collection). Without indexes, Ditto performs full collection scans. However, indexes have overhead for writes and storage, so only index fields used in selective queries.</p>
<p><strong>When to use indexes based on collection size:</strong></p>
<ul>
<li><strong>Small collections (<100 documents)</strong>: Indexes usually not necessary—full scans are fast enough</li>
<li><strong>Medium collections (100-1,000 documents)</strong>: Consider indexes for frequently queried fields with high selectivity (<10% match rate)</li>
<li><strong>Large collections (>1,000 documents)</strong>: Indexes strongly recommended for selective queries—performance gains become significant</li>
<li><strong>Very large collections (>10,000 documents)</strong>: Indexes essential for acceptable query performance on selective queries</li>
</ul>
<p><strong>Key principle:</strong> Index effectiveness depends on both collection size AND query selectivity. A query returning 5% of documents benefits greatly from indexes in a 10,000-document collection (~9,500 documents skipped), but gains little in a 100-document collection (~95 documents skipped, minimal overhead difference).</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-7-1">
            </div>
            <div class="item-title">Use EXPLAIN to verify index usage [SDK 4.12+]</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Prefix queries with <code>EXPLAIN</code> to see the execution plan and confirm indexes are used: <code>EXPLAIN SELECT * FROM orders WHERE status = 'pending'</code>.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>EXPLAIN reveals whether indexes are used, scan counts, and performance bottlenecks. Helps validate that indexes are correctly applied.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-7-2">
            </div>
            <div class="item-title">Avoid N+1 query patterns (multiple individual lookups)</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Instead of querying for each related document individually in a loop (N queries), fetch all related documents in a single query using <code>WHERE _id IN (...)</code>.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>N+1 patterns multiply query overhead. For example, fetching 100 related documents individually requires 100 queries vs 1 batch query. Batch queries reduce execution time and improve performance significantly.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="section-8">
      <div class="section-header" onclick="toggleSection('section-8')">
        <h2 class="section-title"><span class="section-number">Section 8:</span> Transactions</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-8-0">
            </div>
            <div class="item-title">Batch multiple operations in transactions</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Use <code>ditto.store.transaction()</code> to batch multiple INSERT/UPDATE/DELETE operations into a single atomic transaction.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Without transactions, partial failures leave data in inconsistent state. If one operation succeeds but another fails, your data can become corrupted. Transactions ensure all operations succeed together or all fail together (atomicity), maintaining data integrity.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-8-0')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-8-0">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Multiple separate operations without atomicity</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;order&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;o1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;customerId&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;c1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total&#39;</span><span class="o">:</span><span class="w"> </span><span class="m">100</span><span class="p">}},</span>
<span class="p">);</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;UPDATE customers APPLY orderCount PN_INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;c1&#39;</span><span class="p">},</span>
<span class="p">);</span>
<span class="c1">// Problem: If second operation fails, order exists but customer count is wrong</span>

<span class="c1">// ✅ GOOD: Atomic transaction ensures all-or-nothing execution</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">transaction</span><span class="p">(</span><span class="nl">hint:</span><span class="w"> </span><span class="s1">&#39;create-order&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="kd">async</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;order&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;o1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;customerId&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;c1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total&#39;</span><span class="o">:</span><span class="w"> </span><span class="m">100</span><span class="p">}},</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span><span class="kd">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;UPDATE customers APPLY orderCount PN_INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;c1&#39;</span><span class="p">},</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">// Benefit: Both operations succeed together or both fail, ensuring data consistency</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-8-1">
            </div>
            <div class="item-title">Use read-only transactions for consistent multi-query reads</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>When reading related data across multiple queries, use <code>ditto.store.transaction()</code> with <code>isReadOnly: true</code> to ensure all queries see a consistent snapshot.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Without transactions, data can change between queries, causing inconsistent reads. For example, if you first query for document IDs that match certain criteria, and then query for the details of each document, another peer might update or delete those documents in between your queries. This causes race conditions where your second query might return different data than what the first query suggested, leading to null references or inconsistent UI states.</p>
<p>Read-only transactions provide snapshot isolation: all queries within the transaction see the database state as it was at the moment the transaction started, ensuring consistency across multiple reads.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-8-1')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-8-1">
            <pre><code class="highlight"><span></span><span class="kd">final</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">transaction</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="kd">async</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// First, get all order IDs for a specific customer</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">orderIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kd">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;SELECT _id FROM orders WHERE customerId = :customerId&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;customerId&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;c1&#39;</span><span class="p">},</span>
<span class="w">    </span><span class="p">)).</span><span class="n">items</span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">String</span><span class="p">).</span><span class="n">toList</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Then, fetch full details for each order</span>
<span class="w">    </span><span class="c1">// Guaranteed to see the same data state as the first query</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">orderDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;SELECT * FROM orders WHERE _id IN :ids&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;ids&#39;</span><span class="o">:</span><span class="w"> </span><span class="n">orderIds</span><span class="p">},</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">orderDetails</span><span class="p">.</span><span class="n">items</span><span class="p">;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nl">isReadOnly:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nl">hint:</span><span class="w"> </span><span class="s1">&#39;fetch-orders&#39;</span><span class="p">,</span>
<span class="p">);</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-8-2">
            </div>
            <div class="item-title">Never nest read-write transactions (causes deadlock)</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Don't call <code>ditto.store.transaction()</code> inside another read-write transaction. Nested read-only transactions are safe, but nested writes cause permanent deadlocks.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Nested read-write transactions create a deadlock where the inner transaction waits for the outer to complete, while the outer waits for the inner. The app freezes permanently and requires force-quit. This is a critical error that developers must avoid.</p>
<p><strong>Platform note:</strong> Flutter SDK v4.11+ supports transactions but does not have this nesting limitation check. Non-Flutter platforms have this limitation.</p>
              </div>
            </div>
        <div class="code-example">
          <div class="code-header">
            <span class="code-label">Code Example (dart)</span>
            <button class="code-toggle" onclick="toggleCode('code-8-2')">Show Code</button>
          </div>
          <div class="code-content hidden" id="code-8-2">
            <pre><code class="highlight"><span></span><span class="c1">// ❌ BAD: Nested read-write transaction causes permanent deadlock</span>
<span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">transaction</span><span class="p">((</span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="kd">async</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;order&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;o1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total&#39;</span><span class="o">:</span><span class="w"> </span><span class="m">100</span><span class="p">}},</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// DEADLOCK: Inner transaction waits for outer, outer waits for inner</span>
<span class="w">  </span><span class="kd">await</span><span class="w"> </span><span class="n">ditto</span><span class="p">.</span><span class="n">store</span><span class="p">.</span><span class="n">transaction</span><span class="p">((</span><span class="n">innerTx</span><span class="p">)</span><span class="w"> </span><span class="kd">async</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">await</span><span class="w"> </span><span class="n">innerTx</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;UPDATE customers APPLY orderCount PN_INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nl">arguments:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;c1&#39;</span><span class="p">},</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
<span class="c1">// Result: App freezes permanently, requires force-quit</span>
</code></pre>
          </div>
        </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-8-3">
            </div>
            <div class="item-title">Keep transactions short and focused</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Minimize the number of operations and execution time inside transactions. Avoid heavy computation, network calls, or long-running logic.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Long transactions hold locks, blocking other operations and reducing concurrency. Short transactions improve throughput and responsiveness.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-8-4">
            </div>
            <div class="item-title">(Flutter-specific) Always await pending transactions before ditto.close()</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>In Flutter SDK, track all pending transactions and use <code>await Future.wait(pendingTransactions)</code> before calling <code>ditto.close()</code>. Unlike other platforms, Flutter SDK does not wait for transactions automatically.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Closing Ditto before transactions complete causes data loss. Transactions may be incomplete or corrupted. You must manually track and await all transaction futures before closing the Ditto instance.</p>
<p><strong>Platform note:</strong> This limitation is specific to Flutter SDK v4.11+. Other platforms automatically wait for transaction completion.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="section-9">
      <div class="section-header" onclick="toggleSection('section-9')">
        <h2 class="section-title"><span class="section-number">Section 9:</span> Attachments</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-9-0">
            </div>
            <div class="item-title">Use attachments for large binary data (images, videos, files)</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Store large binary data (typically >100KB) as Ditto attachments, not as base64 strings in document fields. Store attachment tokens in document fields to reference the binary data.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Embedding binary data in documents bloats sync traffic and storage, as every document change syncs the entire binary blob. Attachments are lazy-loaded and fetched on-demand only when needed, dramatically reducing bandwidth usage and improving sync performance.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-9-1">
            </div>
            <div class="item-title">Handle attachment fetch errors gracefully</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Wrap <code>fetchAttachment()</code> in try-catch blocks to handle cases like peer unavailability, network timeout, or corrupted data.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Attachment fetches can fail due to network issues or missing peers. Graceful error handling provides user feedback and retry options.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-9-2">
            </div>
            <div class="item-title">Set attachment fetch timeouts appropriately</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Use <code>fetchAttachment()</code> timeout parameter to limit wait time for slow or unavailable peers: <code>fetchAttachment(token, timeout: Duration(seconds: 30))</code>.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Without timeouts, attachment fetches can hang indefinitely when peers are offline. Timeouts ensure responsive UX.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-9-3">
            </div>
            <div class="item-title">Understand attachment availability constraints (immediate peers only)</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Attachments can only be fetched from <strong>immediate peers</strong> (directly connected devices) that have already fetched the attachment. In a multi-hop scenario where Device A has the attachment and Device C wants it, Device C cannot fetch from Device A if Device B (the intermediary) hasn't fetched it yet.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Unlike documents that sync through multi-hop relay, attachments require direct peer connection. Users may see document metadata but be unable to download the attachment until an intermediate peer fetches it first. Design UI to show attachment availability status (e.g., "Available from 2 peers").</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-9-4">
            </div>
            <div class="item-title">Implement timeout detection for stalled attachment fetches</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Ditto's attachment fetch does not raise errors when connections stall—it simply stops making progress. Implement a progress monitoring wrapper that detects when no progress has occurred for a timeout period (e.g., 5 minutes).</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>If all source peers disconnect during a fetch, Ditto will not report an error but the fetch will stall indefinitely, consuming resources. Timeout detection allows you to cancel stalled fetches, notify users, or retry gracefully.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-9-5">
            </div>
            <div class="item-title">Clean up orphaned attachment tokens periodically</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>When deleting documents with attachments, consider removing attachment references. Periodically scan for attachment tokens with no corresponding documents.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Orphaned attachments consume storage without serving any purpose. Cleanup frees storage on resource-constrained devices.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-9-6">
            </div>
            <div class="item-title">Consider attachment size limits for Bluetooth LE transport</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>On mobile devices relying on Bluetooth LE, limit attachment sizes (e.g., <5MB for images, use thumbnails for larger). Test sync performance over Bluetooth.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Bluetooth LE has lower bandwidth than WiFi/LAN. Large attachments over Bluetooth are slow and impact user experience.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="section-10">
      <div class="section-header" onclick="toggleSection('section-10')">
        <h2 class="section-title"><span class="section-number">Section 10:</span> Security</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-10-0">
            </div>
            <div class="item-title">Use OnlineWithAuthenticationIdentity for production apps</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Configure Ditto with <code>OnlineWithAuthenticationIdentity</code> and implement an authentication delegate to integrate with your auth system (OAuth, JWT, custom).</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>OnlinePlaygroundIdentity has no access controls and is insecure for production. OnlineWithAuthentication enforces proper permissions via Ditto Big Peer.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-10-1">
            </div>
            <div class="item-title">Never commit API keys, tokens, or credentials</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Use environment variables or secure storage for Ditto App ID, authentication tokens, and API keys. Never hardcode or commit them to version control.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Exposed credentials allow unauthorized access to your Ditto app and data. Use <code>.env</code> files (excluded from git) or platform-specific secure storage.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-10-2">
            </div>
            <div class="item-title">Implement proper authentication delegate callbacks</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Implement <code>onAuthenticationExpiringSoon()</code> and <code>onAuthenticationRequired()</code> callbacks to refresh tokens before expiry and prompt re-authentication.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Expired tokens cause sync failures. Proactive token refresh ensures continuous sync and prevents user disruption.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-10-3">
            </div>
            <div class="item-title">Use SharedKeyIdentity only for fully offline deployments</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>SharedKeyIdentity (offline mode) disables cloud sync and uses a shared secret for mesh authentication. Use only when cloud connectivity is not available.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>SharedKey lacks cloud-based access controls and audit trails. Suitable for air-gapped deployments but not for internet-connected apps.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-10-4">
            </div>
            <div class="item-title">Never hardcode SharedKey in application code (security risk)</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Don't hardcode SharedKey values directly in mobile app source code. Use MDM (Mobile Device Management) for secure key distribution, or secure platform-specific storage with runtime provisioning.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Hardcoded keys in mobile apps are vulnerable to reverse engineering. Attackers can decompile APK/IPA files to extract the SharedKey, compromising the entire mesh network. A single leaked key grants unauthorized access to all mesh data. Use controlled distribution mechanisms like MDM.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-10-5">
            </div>
            <div class="item-title">Validate and sanitize user inputs before inserting into Ditto</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Apply input validation (length limits, format checks, injection prevention) before inserting user-provided data into documents.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Malicious inputs can cause injection vulnerabilities or data corruption. Validation ensures data integrity and security.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-10-6">
            </div>
            <div class="item-title">Avoid storing sensitive data (PII, passwords) in Ditto documents</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Don't store passwords, credit card numbers, SSNs, or highly sensitive PII directly in Ditto. Use references to secure external storage or encrypt before storing.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Ditto syncs data across devices and peers. Sensitive data exposure increases risk. Use encryption or external secure storage for highly sensitive data.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" id="section-11">
      <div class="section-header" onclick="toggleSection('section-11')">
        <h2 class="section-title"><span class="section-number">Section 11:</span> Observability & Testing</h2>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-11-0">
            </div>
            <div class="item-title">Enable minimum logging level in production</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Set Ditto's minimum log level to <code>warning</code> or <code>error</code> in production using <code>setMinimumLogLevel()</code>. Use <code>debug</code> only during development.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Verbose logging (<code>debug</code>) creates large log files, consumes storage, and may expose sensitive data. Production apps should log errors only.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-11-1">
            </div>
            <div class="item-title">Query system info for debugging (SDK 4.13+)</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Use <code>SELECT * FROM SYSTEM_INFO</code> to retrieve SDK version, platform, device ID, and configuration for support tickets.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>System info helps support teams diagnose environment-specific issues. Include it in bug reports.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-11-2">
            </div>
            <div class="item-title">Monitor sync health with observability callbacks</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Implement transport condition callbacks to monitor network connectivity and peer availability.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Sync health visibility helps diagnose connectivity issues and provides user feedback (e.g., "offline mode").</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-11-3">
            </div>
            <div class="item-title">Use presence to track connected peers</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Use Ditto Presence API to observe which peers are currently connected and available for sync.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Presence data enables features like "online user" lists and helps debug sync issues by showing peer connectivity.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-11-4">
            </div>
            <div class="item-title">Test offline-first behavior (create data while offline)</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Write tests that simulate realistic offline scenarios:</p>
<p>1. Create, update, and delete data while <code>ditto.startSync()</code> is not called or network is disabled</p>
<p>2. Simulate multiple devices making concurrent changes while disconnected from each other</p>
<p>3. Verify data syncs correctly after reconnection with no data loss</p>
<p>4. Test that business logic invariants hold after conflict resolution</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Offline-first is Ditto's core value proposition. Apps must work seamlessly while disconnected and sync correctly when connectivity returns. Multiple devices can modify the same data independently while offline, and changes must merge intelligently upon reconnection. Testing offline scenarios catches critical issues:</p>
<ul>
<li>Missing subscriptions that prevent data from syncing after reconnection</li>
<li>Improper error handling during sync initialization</li>
<li>Data loss or corruption during merge operations</li>
<li>Business rule violations after conflict resolution (e.g., inventory going negative, duplicate order numbers)</li>
<li>UI inconsistencies when offline changes sync to other devices</li>
</ul>
<p><strong>Testing approach:</strong></p>
<ul>
<li>Test <strong>your application's business logic</strong> with realistic concurrent scenarios using your actual domain models</li>
<li>Verify <strong>business rules</strong> hold after conflict resolution (e.g., "inventory never negative", "order numbers unique")</li>
<li>Focus on <strong>your data model</strong>, not just SDK API behavior—the SDK itself is already tested</li>
</ul>
<p><strong>Example test scenarios:</strong></p>
<ul>
<li><strong>Concurrent sales</strong>: Two offline POS terminals sell the same product. After sync, verify inventory doesn't go negative.</li>
<li><strong>Unique identifiers</strong>: Two devices create orders while disconnected. After sync, verify all order numbers are unique.</li>
<li><strong>Deletion scenarios</strong>: Device A deletes an order while Device B updates it offline. After sync, verify the final state matches your business rules (husked document handling, logical deletion filtering).</li>
<li><strong>Subscription lifecycle</strong>: Create data offline, then start sync. Verify subscriptions properly request the data and observers trigger with new documents.</li>
</ul>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-11-5">
            </div>
            <div class="item-title">Test multi-device conflict scenarios</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Write tests that simulate concurrent modifications to the same document from multiple offline devices, then verify CRDT merge behavior after sync:</p>
<p>1. Create two or more test Ditto instances representing different devices</p>
<p>2. Disconnect them from each other (or don't call <code>startSync()</code>)</p>
<p>3. Have each device make conflicting updates to the same document</p>
<p>4. Sync the devices together and verify the merged result matches CRDT semantics</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Ditto uses CRDTs (Conflict-free Replicated Data Types) for automatic conflict resolution, and different CRDT types have different merge behaviors:</p>
<ul>
<li><strong>MAP fields (objects)</strong>: Use "add-wins" semantics—concurrent updates to different keys both persist</li>
<li><strong>REGISTER fields (scalars, arrays)</strong>: Use "last-write-wins" (LWW) based on Hybrid Logical Clock—one update wins, the other is discarded</li>
<li><strong>COUNTER fields</strong>: Use commutative addition—all increments from all devices are summed</li>
</ul>
<p>Without testing, you won't know if your data model handles conflicts correctly. For example, if you use arrays for mutable data that multiple devices modify concurrently, the last-write-wins behavior will cause data loss. Tests validate that your data model design is conflict-safe.</p>
<p><strong>What to test:</strong></p>
<ul>
<li><strong>MAP field conflicts</strong>: Device A updates <code>field1</code>, Device B updates <code>field2</code> → both updates should persist after merge</li>
<li><strong>REGISTER field conflicts</strong>: Device A sets <code>status = "shipped"</code>, Device B sets <code>status = "delivered"</code> → only one value wins (verify which one using HLC/timestamp)</li>
<li><strong>Array conflicts</strong>: Device A appends <code>[item3]</code>, Device B appends <code>[item4]</code> → last-write-wins, one array is lost (this demonstrates why arrays are problematic)</li>
<li><strong>COUNTER conflicts</strong>: Device A increments by 5, Device B increments by 3 → final value should be +8 (commutative addition)</li>
<li><strong>Mixed conflicts</strong>: Device A updates MAP field while Device B updates REGISTER field → both changes should persist (different CRDT types)</li>
</ul>
<p><strong>Testing pattern:</strong></p>
<ul>
<li>Use multiple Ditto instances in tests (each represents a device)</li>
<li>Simulate offline period by not syncing between instances</li>
<li>Make concurrent modifications to the same document</li>
<li>Manually trigger sync (or call sync methods) to merge changes</li>
<li>Assert final state matches expected CRDT behavior</li>
</ul>
<p><strong>Example scenarios:</strong></p>
<ul>
<li><strong>Inventory counter</strong>: Two POS terminals concurrently decrement inventory. After sync, verify the total decrement is correct (not lost due to LWW).</li>
<li><strong>Order modifications</strong>: Device A updates <code>shippingAddress</code>, Device B updates <code>paymentMethod</code>. After sync, verify both fields are updated (MAP add-wins).</li>
<li><strong>Status race condition</strong>: Two devices concurrently update order status. After sync, verify the final status follows HLC ordering (last-write-wins for REGISTER).</li>
<li><strong>Array append collision</strong>: Two devices append items to an array field. After sync, verify you understand which array won (demonstrates why MAP is safer for concurrent modifications).</li>
</ul>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-11-6">
            </div>
            <div class="item-title">Test deletion patterns (Soft-Delete and DELETE)</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">

              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Deletion bugs cause ghost records in UI, data inconsistencies across devices, and sync failures. See [Section 4: Deletion & Storage Lifecycle](#section-4-deletion--storage-lifecycle) for implementation patterns.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-11-7">
            </div>
            <div class="item-title">Test application-specific business logic, not SDK behavior</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Write tests that verify <strong>your application's business logic and data model</strong> under concurrent scenarios using your actual domain models (e.g., inventory management, order creation, data validation rules). Don't test basic SDK behavior (e.g., "data I inserted can be queried")—the SDK itself is already tested.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Tests that only verify SDK behavior (e.g., "INSERT then SELECT returns the document") provide no value—the SDK is already tested. What matters is testing how <strong>your specific business logic</strong> behaves under offline-first and concurrent scenarios. Focus on <strong>your application's invariants</strong> (e.g., "inventory never negative", "order numbers unique", "deleted items don't reappear").</p>
              </div>
            </div>
          </div>
        </div>

        <div class="item">
          <div class="item-header">
            <div class="checkbox-wrapper">
              <input type="checkbox" class="item-checkbox" id="item-11-8">
            </div>
            <div class="item-title">Test timestamp precision and clock drift tolerance</div>
          </div>
          <div class="item-details">
            <div class="detail-section">
              <div class="detail-heading">What this means:</div>
              <div class="detail-content">
<p>Write tests that simulate devices with mismatched clocks (e.g., Device A is 5 seconds ahead, Device B is 3 seconds behind). Verify that timestamp-based logic handles clock drift gracefully with appropriate tolerance ranges.</p>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-heading">Why this matters:</div>
              <div class="detail-content">
<p>Device clocks are never perfectly synchronized. iOS typically has ~100ms drift, while Android can drift by several seconds. Timestamp-based validation (e.g., <code>createdAt &lt; updatedAt</code>) can fail due to clock skew. Tests ensure your logic tolerates reasonable clock drift.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </main>

    <a href="https://docs.ditto.live" class="float-btn" target="_blank" rel="noopener noreferrer">
      <span>📘</span>
      <span class="float-btn-text" id="official-doc-text">Official Doc</span>
    </a>
  </div>

  <script>
    // ==========================================================================
    // Translation Data (injected by build script)
    // ==========================================================================
    const translations = {
  "en": {
    "title": "Ditto SDK Implementation Checklist",
    "completed": "completed",
    "showCode": "Show Code",
    "hideCode": "Hide Code",
    "officialDoc": "Official Doc",
    "whatMeans": "What this means:",
    "whyMatters": "Why this matters:",
    "sections": [
      "<span class=\"section-number\">Section 1:</span> Initialization & API Basics",
      "<span class=\"section-number\">Section 2:</span> Data Modeling Fundamentals",
      "<span class=\"section-number\">Section 3:</span> Write Operations",
      "<span class=\"section-number\">Section 4:</span> Deletion & Storage Lifecycle",
      "<span class=\"section-number\">Section 5:</span> Read Operations & Queries",
      "<span class=\"section-number\">Section 6:</span> Subscriptions & Real-time Sync",
      "<span class=\"section-number\">Section 7:</span> Performance Optimization",
      "<span class=\"section-number\">Section 8:</span> Transactions",
      "<span class=\"section-number\">Section 9:</span> Attachments",
      "<span class=\"section-number\">Section 10:</span> Security",
      "<span class=\"section-number\">Section 11:</span> Observability & Testing"
    ],
    "items": [
      "Initialize Ditto with appropriate authentication mode",
      "Handle Ditto initialization errors gracefully",
      "Use DQL API (current), not legacy builder API",
      "Always await ALTER SYSTEM SET before startSync()",
      "Avoid ID patterns that can cause collisions across devices",
      "Use MAP instead of arrays for mutable data",
      "Use embedded vs foreign-key relationships appropriately",
      "Avoid storing large binary data directly in documents",
      "Don't store calculated/derived fields in documents",
      "Exclude unnecessary data from documents",
      "Enable DQL Strict Mode for type safety across peers [SDK 4.11+]",
      "Use field-level UPDATE instead of full document replacement",
      "Avoid updating fields with the same value unnecessarily",
      "Use DO UPDATE_LOCAL_DIFF for efficient upserts [SDK 4.12+]",
      "Use COUNTER type for distributed counters [SDK 4.14.0+]",
      "Don't use counters for derived values that can be calculated",
      "Use separate documents for event history, not arrays",
      "Use INITIAL DOCUMENTS for device-local templates",
      "Understand the difference between Soft-Delete and DELETE queries",
      "(If using Soft-Delete) Subscribe broadly, filter in observers/queries",
      "(If using Soft-Delete) Periodically EVICT old deleted documents",
      "(If using Soft-Delete) Use EVICT for local-only removal",
      "(If using Soft-Delete) Cancel subscriptions before EVICT to prevent resync loops",
      "(If using DELETE) Understand tombstones and TTL behavior",
      "(If using DELETE) Understand husked documents and how to prevent them",
      "(If using DELETE) Use DELETE only for permanent, irreversible removal",
      "Filter data in queries, not in application code",
      "Use query result pagination for large datasets",
      "Don't retain QueryResultItem references long-term",
      "Use long-lived subscriptions, not request/response pattern",
      "Subscribe broadly, filter in observers (for multi-hop relay)",
      "Avoid subscribing to data you don't need",
      "Cancel observers and subscriptions when no longer needed",
      "Use registerObserverWithSignalNext for backpressure control",
      "Handle observer errors gracefully",
      "Avoid heavy computation in observer callbacks",
      "Use CREATE INDEX for selective queries [SDK 4.12+]",
      "Use EXPLAIN to verify index usage [SDK 4.12+]",
      "Avoid N+1 query patterns (multiple individual lookups)",
      "Batch multiple operations in transactions",
      "Use read-only transactions for consistent multi-query reads",
      "Never nest read-write transactions (causes deadlock)",
      "Keep transactions short and focused",
      "(Flutter-specific) Always await pending transactions before ditto.close()",
      "Use attachments for large binary data (images, videos, files)",
      "Handle attachment fetch errors gracefully",
      "Set attachment fetch timeouts appropriately",
      "Understand attachment availability constraints (immediate peers only)",
      "Implement timeout detection for stalled attachment fetches",
      "Clean up orphaned attachment tokens periodically",
      "Consider attachment size limits for Bluetooth LE transport",
      "Use OnlineWithAuthenticationIdentity for production apps",
      "Never commit API keys, tokens, or credentials",
      "Implement proper authentication delegate callbacks",
      "Use SharedKeyIdentity only for fully offline deployments",
      "Never hardcode SharedKey in application code (security risk)",
      "Validate and sanitize user inputs before inserting into Ditto",
      "Avoid storing sensitive data (PII, passwords) in Ditto documents",
      "Enable minimum logging level in production",
      "Query system info for debugging (SDK 4.13+)",
      "Monitor sync health with observability callbacks",
      "Use presence to track connected peers",
      "Test offline-first behavior (create data while offline)",
      "Test multi-device conflict scenarios",
      "Test deletion patterns (Soft-Delete and DELETE)",
      "Test application-specific business logic, not SDK behavior",
      "Test timestamp precision and clock drift tolerance"
    ],
    "whatMeansSections": [
      "<p>Choose the correct identity mode:</p>\n<ul>\n<li><strong>Development</strong>: <code>OnlinePlaygroundIdentity</code> (for testing only, no access controls)</li>\n<li><strong>Production</strong>: <code>OnlineWithAuthenticationIdentity</code> with authentication delegate</li>\n<li><strong>Air-gapped/Offline</strong>: <code>SharedKeyIdentity</code> (no cloud sync)</li>\n</ul>",
      "<p>Wrap <code>Ditto.open()</code>, <code>startSync()</code>, and <code>execute()</code> in try-catch blocks. Handle cases like invalid license, network unavailability, permission issues, or query errors.</p>",
      "<p>Use <code>ditto.store.execute('SELECT * FROM collection ...')</code> and related DQL methods. Avoid deprecated builder APIs like <code>ditto.store.collection('name').find()</code>.</p>",
      "<p>When configuring system settings like <code>DQL_STRICT_MODE</code>, always use <code>await</code> before calling <code>startSync()</code> or other operations.</p>",
      "<p>Never use sequential counters, timestamps, or device-based patterns for document IDs when multiple devices can create documents independently. Use globally unique identifiers (UUID v4, ULID) or let Ditto auto-generate IDs. Composite keys (e.g., <code>{\"userId\": \"user123\", \"orderId\": \"&lt;uuid&gt;\"}</code>) are acceptable when the combination is guaranteed unique.</p>",
      "<p>Arrays use Last-Write-Wins (REGISTER CRDT), causing merge conflicts when multiple peers update concurrently. Use MAP (object) structures with unique keys for data that can be modified by multiple devices.</p>",
      "<p>Decide whether to embed related data in a single document or use separate documents with foreign-key references:</p>\n<p><strong>Embedded (denormalized)</strong>:</p>\n<ul>\n<li>Store related data directly within the parent document</li>\n<li>Requires single query to retrieve all data</li>\n<li>Data duplication across documents (same customer info in multiple orders)</li>\n<li>All related data syncs as a single unit</li>\n<li>Best for: Small, static data retrieved together (order items, user profile with address)</li>\n</ul>\n<p><strong>Foreign-key (normalized)</strong>:</p>\n<ul>\n<li>Store related data in separate documents, reference by ID</li>\n<li>Requires multiple sequential queries (no JOIN support in Ditto)</li>\n<li>No data duplication, single source of truth</li>\n<li>Related data syncs independently</li>\n<li>Best for: Large data, frequently updated data, or data accessed independently (user profiles, product catalogs)</li>\n</ul>",
      "<p>Don't store images, videos, or large files as base64 strings in document fields. Use Ditto attachments instead.</p>",
      "<p>Avoid storing fields that can be calculated from existing data (e.g., <code>lineTotal = price × quantity</code>, <code>subtotal = sum(items)</code>, <code>total = subtotal + tax</code>). Calculate these values in application code when needed.</p>",
      "<p>Every field in a Ditto document syncs across all peers in the mesh network, consuming bandwidth and storage. Only include data that represents shared business state needed across devices. Don't sync:</p>\n<ul>\n<li><strong>UI-specific state</strong>: Expansion/selection/hover states, scroll positions, active tab indices</li>\n<li><strong>Temporary/transient state</strong>: Upload progress, processing flags, retry counters, loading indicators</li>\n<li><strong>Device-specific data</strong>: Local file paths, device IDs (unless required for authorization), device capabilities</li>\n<li><strong>Cached/derived data</strong>: Values that can be calculated from other fields or fetched from external sources</li>\n<li><strong>High-frequency ephemeral data</strong>: Mouse cursor positions, typing indicators, real-time sensor readings that don't need persistence</li>\n<li><strong>Debug/development data</strong>: Test flags, debug counters, development-only metadata</li>\n</ul>",
      "<p>Execute <code>ALTER SYSTEM SET DQL_STRICT_MODE = true</code> before <code>startSync()</code> to enforce type consistency across all fields. This prevents different devices from writing incompatible types to the same field.</p>",
      "<p>Update only specific fields using <code>UPDATE collection SET field = :value WHERE ...</code> instead of re-inserting entire documents with <code>INSERT ... ON ID CONFLICT DO UPDATE</code>.</p>",
      "<p>Before executing an UPDATE statement, query the document to check if the new value differs from the current value. Skip the UPDATE if the values are identical.</p>",
      "<p>When upserting documents with <code>ON ID CONFLICT</code>, use <code>DO UPDATE_LOCAL_DIFF</code> instead of <code>DO UPDATE</code> to avoid syncing unchanged field values.</p>",
      "<p>For counters that may be updated concurrently by multiple peers, use <code>COUNTER</code> type with <code>INCREMENT BY</code> operation instead of SET operations.</p>",
      "<p>Avoid maintaining counter fields that represent aggregated or calculated values from other data sources. Instead, calculate these values from the source data when needed. Common anti-patterns include:</p>\n<ul>\n<li><strong>Inventory counters</strong>: Don't maintain <code>currentStock</code> as a counter field—calculate it from order/transaction history</li>\n<li><strong>Relationship counts</strong>: Don't maintain <code>followerCount</code> updated from <code>followers</code> collection—query and count when needed</li>\n<li><strong>Status tallies</strong>: Don't maintain <code>completedTaskCount</code> from <code>tasks</code> collection—query with filters</li>\n</ul>",
      "<p>For append-only logs (status history, audit trails), INSERT a new document for each event instead of appending to an array field.</p>",
      "<p>For device-local default data (categories, templates, seed data), use <code>INSERT INTO collection INITIAL DOCUMENTS (...)</code> instead of regular <code>INSERT</code>.</p>",
      "<p>In distributed databases like Ditto, deleting data on one device doesn't automatically remove it from others. Both approaches are <strong>deletion propagation mechanisms</strong> with different trade-offs:</p>\n<ul>\n<li><strong>Soft-Delete Pattern</strong>: Developer-implemented pattern using UPDATE operations to mark documents as deleted (e.g., <code>UPDATE orders SET isDeleted = true WHERE _id = :id</code>). Deletion flags propagate through the mesh network like any other field update. Filter deleted documents in queries/observers, then periodically remove them locally with EVICT.</li>\n<li><strong>DELETE query</strong>: Built-in operation that physically removes documents and automatically creates Tombstones (compressed deletion markers with 30-day TTL on Cloud, configurable on Edge SDK). Tombstones propagate through the mesh to notify peers about deletions.</li>\n</ul>",
      "<p>When implementing Soft-Delete with an <code>isDeleted</code> flag:</p>\n<ul>\n<li><strong>Subscriptions</strong>: <code>SELECT * FROM orders</code> (no <code>isDeleted</code> filter)</li>\n<li><strong>Observers</strong>: <code>SELECT * FROM orders WHERE isDeleted != true</code></li>\n<li><strong>Queries</strong>: <code>SELECT * FROM orders WHERE isDeleted != true</code></li>\n</ul>",
      "<p>After marking documents as deleted (e.g., <code>isDeleted: true, deletedAt: &lt;timestamp&gt;</code>), periodically run <code>EVICT FROM collection WHERE isDeleted = true AND deletedAt &lt; :cutoff</code> to free local storage. Choose an appropriate retention period (e.g., 30-90 days).</p>",
      "<p><code>EVICT FROM collection WHERE ...</code> removes documents from local storage only. Peers retain their copies and can re-share evicted documents later.</p>",
      "<p>When evicting documents from local storage, cancel the corresponding subscription first, then EVICT, then recreate the subscription with an updated filter if needed.</p>",
      "<p>When you DELETE a document, Ditto creates a tombstone that propagates to peers during the TTL window (default: 30 days). After TTL expires, the tombstone is removed, and peers who were offline during the entire TTL window may re-share the document (\"zombie resurrection\").</p>",
      "<p>\"Husked documents\" occur when one peer DELETEs a document while another peer concurrently UPDATEs it. After merge, the document exists but has only <code>_id</code> and the updated field(s), with all other fields set to null.</p>",
      "<p><code>DELETE FROM collection WHERE ...</code> permanently removes documents from all peers in the mesh. Deletion propagates via tombstones during the TTL period (default: 30 days).</p>",
      "<p>Use DQL <code>WHERE</code> clauses to filter data at the database level instead of fetching all documents and filtering in application code.</p>",
      "<p>For collections with thousands of documents, use <code>LIMIT</code> and <code>OFFSET</code> in queries to paginate results rather than fetching all documents at once.</p>",
      "<p>Extract <code>item.value</code> from QueryResultItems immediately and convert to application models. Don't store QueryResultItems in state, pass them between functions, or hold references beyond the immediate callback scope.</p>",
      "<p>Create subscriptions once during app initialization or when entering a feature, keep them active while the feature is in use, and cancel only when leaving the feature. Don't create/cancel subscriptions repeatedly for each query.</p>",
      "<p>Subscriptions should have minimal WHERE filters (or none for small collections). Apply detailed filters in observers and queries instead.</p>",
      "<p>Scope subscriptions to relevant collections and use appropriate WHERE filters to limit data to what your feature actually needs. Avoid subscribing to entire collections without any filtering when only a subset is required.</p>",
      "<p>Store references to observers and subscriptions, then call <code>.cancel()</code> when the feature is closed or the widget is disposed.</p>",
      "<p>Use <code>registerObserverWithSignalNext()</code> instead of <code>registerObserver()</code> to control when the next observer event is delivered. Call <code>signalNext()</code> after processing each event.</p>",
      "<p>Wrap observer callbacks in try-catch blocks to handle unexpected errors (e.g., JSON deserialization failures, type mismatches, malformed data).</p>",
      "<p>Keep observer callbacks lightweight. Offload heavy computation (data transformation, business logic) to background isolates or threads.</p>",
      "<p>Create indexes on fields frequently used in WHERE clauses for queries that return a small subset of documents (high selectivity). Use <code>CREATE INDEX IF NOT EXISTS idx_name ON collection (field)</code>.</p>",
      "<p>Prefix queries with <code>EXPLAIN</code> to see the execution plan and confirm indexes are used: <code>EXPLAIN SELECT * FROM orders WHERE status = 'pending'</code>.</p>",
      "<p>Instead of querying for each related document individually in a loop (N queries), fetch all related documents in a single query using <code>WHERE _id IN (...)</code>.</p>",
      "<p>Use <code>ditto.store.transaction()</code> to batch multiple INSERT/UPDATE/DELETE operations into a single atomic transaction.</p>",
      "<p>When reading related data across multiple queries, use <code>ditto.store.transaction()</code> with <code>isReadOnly: true</code> to ensure all queries see a consistent snapshot.</p>",
      "<p>Don't call <code>ditto.store.transaction()</code> inside another read-write transaction. Nested read-only transactions are safe, but nested writes cause permanent deadlocks.</p>",
      "<p>Minimize the number of operations and execution time inside transactions. Avoid heavy computation, network calls, or long-running logic.</p>",
      "<p>In Flutter SDK, track all pending transactions and use <code>await Future.wait(pendingTransactions)</code> before calling <code>ditto.close()</code>. Unlike other platforms, Flutter SDK does not wait for transactions automatically.</p>",
      "<p>Store large binary data (typically >100KB) as Ditto attachments, not as base64 strings in document fields. Store attachment tokens in document fields to reference the binary data.</p>",
      "<p>Wrap <code>fetchAttachment()</code> in try-catch blocks to handle cases like peer unavailability, network timeout, or corrupted data.</p>",
      "<p>Use <code>fetchAttachment()</code> timeout parameter to limit wait time for slow or unavailable peers: <code>fetchAttachment(token, timeout: Duration(seconds: 30))</code>.</p>",
      "<p>Attachments can only be fetched from <strong>immediate peers</strong> (directly connected devices) that have already fetched the attachment. In a multi-hop scenario where Device A has the attachment and Device C wants it, Device C cannot fetch from Device A if Device B (the intermediary) hasn't fetched it yet.</p>",
      "<p>Ditto's attachment fetch does not raise errors when connections stall—it simply stops making progress. Implement a progress monitoring wrapper that detects when no progress has occurred for a timeout period (e.g., 5 minutes).</p>",
      "<p>When deleting documents with attachments, consider removing attachment references. Periodically scan for attachment tokens with no corresponding documents.</p>",
      "<p>On mobile devices relying on Bluetooth LE, limit attachment sizes (e.g., <5MB for images, use thumbnails for larger). Test sync performance over Bluetooth.</p>",
      "<p>Configure Ditto with <code>OnlineWithAuthenticationIdentity</code> and implement an authentication delegate to integrate with your auth system (OAuth, JWT, custom).</p>",
      "<p>Use environment variables or secure storage for Ditto App ID, authentication tokens, and API keys. Never hardcode or commit them to version control.</p>",
      "<p>Implement <code>onAuthenticationExpiringSoon()</code> and <code>onAuthenticationRequired()</code> callbacks to refresh tokens before expiry and prompt re-authentication.</p>",
      "<p>SharedKeyIdentity (offline mode) disables cloud sync and uses a shared secret for mesh authentication. Use only when cloud connectivity is not available.</p>",
      "<p>Don't hardcode SharedKey values directly in mobile app source code. Use MDM (Mobile Device Management) for secure key distribution, or secure platform-specific storage with runtime provisioning.</p>",
      "<p>Apply input validation (length limits, format checks, injection prevention) before inserting user-provided data into documents.</p>",
      "<p>Don't store passwords, credit card numbers, SSNs, or highly sensitive PII directly in Ditto. Use references to secure external storage or encrypt before storing.</p>",
      "<p>Set Ditto's minimum log level to <code>warning</code> or <code>error</code> in production using <code>setMinimumLogLevel()</code>. Use <code>debug</code> only during development.</p>",
      "<p>Use <code>SELECT * FROM SYSTEM_INFO</code> to retrieve SDK version, platform, device ID, and configuration for support tickets.</p>",
      "<p>Implement transport condition callbacks to monitor network connectivity and peer availability.</p>",
      "<p>Use Ditto Presence API to observe which peers are currently connected and available for sync.</p>",
      "<p>Write tests that simulate realistic offline scenarios:</p>\n<p>1. Create, update, and delete data while <code>ditto.startSync()</code> is not called or network is disabled</p>\n<p>2. Simulate multiple devices making concurrent changes while disconnected from each other</p>\n<p>3. Verify data syncs correctly after reconnection with no data loss</p>\n<p>4. Test that business logic invariants hold after conflict resolution</p>",
      "<p>Write tests that simulate concurrent modifications to the same document from multiple offline devices, then verify CRDT merge behavior after sync:</p>\n<p>1. Create two or more test Ditto instances representing different devices</p>\n<p>2. Disconnect them from each other (or don't call <code>startSync()</code>)</p>\n<p>3. Have each device make conflicting updates to the same document</p>\n<p>4. Sync the devices together and verify the merged result matches CRDT semantics</p>",
      "",
      "<p>Write tests that verify <strong>your application's business logic and data model</strong> under concurrent scenarios using your actual domain models (e.g., inventory management, order creation, data validation rules). Don't test basic SDK behavior (e.g., \"data I inserted can be queried\")—the SDK itself is already tested.</p>",
      "<p>Write tests that simulate devices with mismatched clocks (e.g., Device A is 5 seconds ahead, Device B is 3 seconds behind). Verify that timestamp-based logic handles clock drift gracefully with appropriate tolerance ranges.</p>"
    ],
    "whyMattersSections": [
      "<p>Authentication mode determines security model and sync capabilities. OnlinePlayground is insecure for production. OnlineWithAuthentication provides proper access controls. SharedKey is for fully offline deployments.</p>",
      "<p>Ditto initialization and operations can fail due to licensing, network, platform issues, or invalid queries. Graceful error handling prevents app crashes and provides user feedback.</p>",
      "<p>Builder API is deprecated and lacks features like transactions, optimizations, and v5 forward compatibility. DQL API is the current standard (SDK 4.12+) and will be maintained going forward.</p>",
      "<p><code>store.execute()</code> is async. Proceeding without awaiting can cause settings to not be applied before sync starts, leading to inconsistent behavior across peers.</p>",
      "<p>Sequential ID generation causes collisions when multiple offline devices create documents with the same ID pattern (e.g., \"order_001\"). Collisions trigger conflict resolution, potentially causing data loss or unexpected behavior. For authorization patterns using composite keys (e.g., <code>{\"userId\": \"user123\", \"resourceId\": \"&lt;uuid&gt;\"}</code>), ensure at least one component is globally unique.</p>",
      "<p>Concurrent array updates from offline peers result in lost data, duplicates, or inconsistent state after sync. MAP structures use \"add-wins\" semantics, automatically merging concurrent updates to different keys without conflicts.</p>",
      "<p>Ditto does not support SQL-style JOINs. With embedded data, one query retrieves everything but duplicates data across documents. With foreign-keys, you need multiple sequential queries (N+1 pattern risk) but maintain a single source of truth. Choose based on: (1) how data is accessed together, (2) update frequency, (3) data size, and (4) acceptable duplication trade-offs. Embedded data optimizes read performance at the cost of write overhead and storage; foreign-keys optimize write performance and storage at the cost of multiple queries.</p>",
      "<p>Large binary data in documents bloats sync traffic and storage. Attachments are lazy-loaded and fetched on-demand, optimizing bandwidth and storage.</p>",
      "<p>Storing calculated fields wastes bandwidth (syncs unnecessary data), creates risk of stale data (source changes but calculated field doesn't update), and adds synchronization overhead. Calculate on-demand instead.</p>",
      "<p>Syncing unnecessary data wastes network bandwidth (critical for metered connections), drains battery (continuous sync), bloats storage on all devices, and slows sync performance for important business data. Every peer must store, process, and relay this data, even though much of it is only relevant to a single device or moment in time.</p>\n<p><strong>Key principle:</strong> Only sync data that represents <strong>business state</strong> (the \"single source of truth\" needed across devices), not <strong>presentation state</strong> (how UI displays data), <strong>transient state</strong> (temporary processing status), or <strong>device-local state</strong> (specific to one device's environment).</p>",
      "<p>Without Strict Mode, Device A can write <code>{\"age\": 30}</code> (number) while Device B writes <code>{\"age\": \"thirty\"}</code> (string), causing cross-peer data inconsistency and unpredictable query results. Strict Mode enforces type declarations via MAP literals, catching type errors at development time instead of runtime.</p>",
      "<p>Full document replacement treats all fields as changed, creating unnecessary sync deltas even for unchanged values. Field-level updates minimize sync traffic and reduce conflict potential.</p>",
      "<p>Even when updating a field with the same value (e.g., setting <code>status = \"pending\"</code> when it's already <code>\"pending\"</code>), Ditto treats this as a change and creates a sync delta. This delta is transmitted to all peers across the mesh network, consuming bandwidth and triggering observer callbacks unnecessarily. The underlying CRDT counter increments regardless of whether the value actually changed, causing every peer to process the update. By checking before updating, you avoid this unnecessary network traffic, reduce sync overhead, and prevent redundant UI updates across all connected devices. This is particularly important in high-frequency update scenarios where the same value might be set repeatedly (e.g., periodic status checks, polling loops, or user interactions).</p>",
      "<p><code>DO UPDATE</code> treats all fields as changed and syncs them as deltas, even if values are identical. <code>DO UPDATE_LOCAL_DIFF</code> compares incoming vs existing documents and only syncs fields that actually differ, reducing network traffic.</p>",
      "<p>SET operations perform read-modify-write, causing lost updates when devices are disconnected. COUNTER operations merge correctly across concurrent updates using commutative CRDT semantics.</p>",
      "<p>Counters for derived values create several problems:</p>\n<p>1. <strong>Cross-collection synchronization complexity</strong>: Updating source data (e.g., orders) requires also updating counters in other collections (e.g., products), creating tight coupling</p>\n<p>2. <strong>Data integrity risk</strong>: Source data and counters can become inconsistent if updates fail partially or sync in wrong order</p>\n<p>3. <strong>Not self-correcting</strong>: If counters drift out of sync due to bugs or data issues, they don't auto-correct. Calculated values are always accurate based on current source data.</p>\n<p>4. <strong>Single source of truth violation</strong>: Maintains redundant state that must be kept synchronized</p>\n<p><strong>When counters ARE appropriate:</strong> Use counters (COUNTER type with PN_INCREMENT) for <strong>independent, additive data</strong> where each increment is a standalone event:</p>\n<ul>\n<li>✅ View counts (each view is independent)</li>\n<li>✅ Like counts (each like is independent)</li>\n<li>✅ Usage metrics (each usage event is independent)</li>\n<li>✅ Vote tallies (each vote is independent)</li>\n</ul>",
      "<p>Arrays are REGISTER CRDTs (Last-Write-Wins). Concurrent appends from offline peers result in lost events after merge. Separate documents allow all events to be preserved independently.</p>",
      "<p>Regular INSERT creates sync deltas that propagate to all peers unnecessarily. <code>INITIAL DOCUMENTS</code> treats data as \"existing from the beginning of time,\" preventing sync traffic for device-local templates.</p>",
      "<p>Both approaches eventually result in permanent data removal. The choice is about <strong>how deletion information propagates</strong> through the mesh:</p>\n<p><strong>Soft-Delete propagation advantages:</strong></p>\n<ul>\n<li>✅ No TTL dependency: Deletion flags persist until EVICT, so long-offline devices always receive deletion notifications</li>\n<li>✅ CRDT-safe: UPDATE operations merge cleanly, preventing husked documents from concurrent DELETE + UPDATE conflicts</li>\n<li>✅ Reliable multi-hop relay: Deletion flags propagate through intermediary peers like any other field update</li>\n</ul>\n<p><strong>Soft-Delete propagation disadvantages:</strong></p>\n<ul>\n<li>❌ Higher code complexity: Must filter <code>isDeleted</code> consistently in all queries and observers</li>\n<li>❌ Implementation discipline required: Easy to forget filtering or incorrectly filter in subscriptions (breaks relay)</li>\n<li>❌ Larger dataset until EVICT: Slightly slower queries as deleted documents remain in database</li>\n<li>❌ Manual cleanup required: Must implement periodic EVICT to permanently remove old deleted documents</li>\n</ul>\n<p><strong>DELETE propagation advantages:</strong></p>\n<ul>\n<li>✅ Simpler implementation: Automatic Tombstone creation and propagation, no filtering logic needed</li>\n<li>✅ Smaller active dataset: Documents removed immediately, faster queries after Tombstone TTL expires</li>\n<li>✅ Automatic cleanup: Tombstones expire automatically after TTL period</li>\n</ul>\n<p><strong>DELETE propagation disadvantages:</strong></p>\n<ul>\n<li>❌ TTL-based propagation: Devices offline longer than TTL miss deletion notification, may resurrect deleted data (zombie data)</li>\n<li>❌ CRDT conflicts possible: Concurrent DELETE + UPDATE from different peers can create husked documents (partial null fields)</li>\n<li>❌ Tombstone propagation timing: Brief window during multi-hop relay before all peers receive Tombstones</li>\n</ul>\n<p><strong>Choose based on your application's requirements:</strong></p>\n<ul>\n<li><strong>Use Soft-Delete</strong> when: Devices may be offline longer than Tombstone TTL (>30 days Cloud, >configured Edge), concurrent DELETE + UPDATE scenarios are likely, or reliable multi-hop relay propagation is critical for your use case</li>\n<li><strong>Use DELETE</strong> when: All devices sync regularly within Tombstone TTL period, temporary/ephemeral data with short lifecycle, simpler implementation is preferred, or concurrent DELETE + UPDATE scenarios are unlikely</li>\n</ul>",
      "<p>Filtering deletion flags in subscriptions breaks multi-hop relay. Intermediate devices won't store deleted documents, preventing deletion notifications from reaching indirectly connected peers. Subscribe broadly for relay, filter locally for display. This is a critical implementation pattern only for Soft-Delete—if using DELETE queries, this does not apply.</p>",
      "<p>Soft-Delete keeps documents in the database indefinitely, consuming storage. Eviction removes old deleted documents from local storage without affecting peers (EVICT is local-only, not DELETE). This prevents storage bloat while maintaining multi-hop relay during the retention period.</p>",
      "<p>EVICT frees local storage without affecting other devices. Useful for clearing caches, removing old data, or managing storage limits on resource-constrained devices. This is critical for Soft-Delete cleanup—EVICT removes documents locally after the retention period without affecting multi-hop relay.</p>",
      "<p>Evicting documents while a subscription is active causes Ditto to immediately request them again from peers, creating an infinite resync loop that wastes network bandwidth and battery.</p>",
      "<p>Tombstones are Ditto's built-in deletion propagation mechanism that automatically notifies all peers about deletions. However, Tombstones only exist during the TTL period. If a peer is offline longer than the TTL (e.g., 35 days on Cloud), they miss the deletion notification and may resurrect deleted data when they reconnect. For applications where devices may be offline longer than the TTL period, Soft-Delete provides more reliable deletion propagation as flags persist indefinitely until EVICT.</p>",
      "<p>Husked documents can break application logic that assumes required fields always exist. Soft-Delete prevents husking by using UPDATE instead of DELETE.</p>",
      "<p>DELETE is irreversible and propagates via Tombstones to all peers. Both Soft-Delete and DELETE eventually result in permanent data removal—the difference is the propagation mechanism. DELETE works well for:</p>\n<ul>\n<li>Temporary/ephemeral data with short lifecycle</li>\n<li>Scenarios where all devices sync regularly within TTL period</li>\n<li>Simpler implementation is preferred</li>\n</ul>\n<p>For applications where devices may be offline longer than Tombstone TTL, or where concurrent DELETE + UPDATE scenarios are likely, Soft-Delete provides more reliable deletion propagation through UPDATE-based flags that persist until EVICT.</p>",
      "<p>Database-level filtering reduces memory usage, improves query performance, and minimizes data transfer overhead. When you fetch all documents and filter in application code, Ditto must:</p>\n<p>1. Load all documents from storage into memory</p>\n<p>2. Deserialize all documents from internal format (CBOR) to application objects</p>\n<p>3. Allocate memory for QueryResultItems that hold references to underlying data structures</p>\n<p>This creates unnecessary memory pressure, especially on resource-constrained devices. Database-level filtering (WHERE clauses) happens inside Ditto's storage engine before deserialization, minimizing memory allocation and processing overhead. For large collections (thousands of documents), the performance difference is significant: application-level filtering can cause memory issues or slow performance, while database filtering keeps memory usage constant regardless of collection size.</p>",
      "<p>Large result sets consume memory and slow down UI rendering. Pagination improves app responsiveness and reduces memory pressure.</p>",
      "<p>QueryResultItems are lazy-loading database cursors, not plain data objects. They hold internal references to Ditto's storage engine and underlying CRDT data structures. Retaining QueryResultItems long-term causes:</p>\n<p>1. <strong>Memory leaks</strong>: Prevents Ditto from releasing memory for internal data structures</p>\n<p>2. <strong>Blocked garbage collection</strong>: Holds references that prevent cleanup of processed results</p>\n<p>3. <strong>Unpredictable behavior</strong>: Cursors may become stale if underlying data changes</p>\n<p>4. <strong>Resource exhaustion</strong>: Accumulating cursors consumes memory proportional to query result count</p>\n<p><strong>Best practice:</strong> Extract data immediately in observer callbacks or query handlers, convert to plain Dart objects or application models, and let QueryResultItems fall out of scope for garbage collection.</p>",
      "<p>Subscriptions are not HTTP requests—they're long-lived replication contracts that tell Ditto what data to sync. Frequent create/cancel cycles cause unnecessary connection overhead, delays in data availability, and increased battery usage. Ditto is offline-first: data should be continuously synced, not fetched on-demand.</p>\n<p><strong>Common mistake:</strong> Treating Ditto like a REST API by creating a subscription, waiting briefly, querying data, and immediately canceling. This defeats the purpose of mesh sync and prevents real-time updates from reaching your device.</p>\n<p><strong>When to cancel subscriptions:</strong></p>\n<ul>\n<li>✅ When a feature/screen is permanently closed (not just hidden temporarily)</li>\n<li>✅ Before EVICT operations to prevent resync loops</li>\n<li>✅ When subscription scope needs to change (cancel old, create new with updated query)</li>\n<li>✅ During app termination for proper cleanup</li>\n</ul>\n<p><strong>When NOT to cancel:</strong></p>\n<ul>\n<li>❌ Between individual queries to the same data</li>\n<li>❌ During temporary UI state changes (navigation, minimize/maximize)</li>\n<li>❌ After every data read operation</li>\n</ul>",
      "<p>Narrow subscription filters prevent relay devices from storing documents needed by indirectly connected peers. Broad subscriptions enable multi-hop relay; local filters optimize UI display.</p>\n<p><strong>The multi-hop relay problem:</strong> Consider a mesh network with Device A (source) → Device B (relay) → Device C (destination). If Device B subscribes with a narrow filter like <code>WHERE priority = 'high'</code>, it won't store low-priority documents from Device A. When Device C subscribes to all orders, it never receives the low-priority documents because Device B (the relay) doesn't have them to forward. This breaks multi-hop relay for filtered-out documents.</p>\n<p><strong>Solution:</strong> Device B subscribes broadly without priority filters, stores all documents, and can relay everything to Device C. Each device filters locally in observers/queries for UI display only.</p>",
      "<p>Every subscription tells Ditto to sync and store matching documents locally. Overly broad subscriptions cause:</p>\n<p>1. <strong>Storage bloat</strong>: Unnecessary documents consume device storage</p>\n<p>2. <strong>Network waste</strong>: Syncing documents you'll never use consumes bandwidth and battery</p>\n<p>3. <strong>Memory pressure</strong>: Larger local datasets increase memory usage during queries</p>\n<p>4. <strong>Performance degradation</strong>: More documents to scan during queries, even if filtered in observers</p>\n<p><strong>Balance with multi-hop relay:</strong> While you should avoid unnecessary data, remember that subscriptions too narrow can break multi-hop relay (see \"Subscribe broadly, filter in observers\"). The goal is to subscribe to data that's relevant to your feature or needed for relay, not everything in the database.</p>\n<p><strong>Examples of appropriate scoping:</strong></p>\n<ul>\n<li>✅ Subscribe to orders for a specific customer: <code>WHERE customerId = :id</code></li>\n<li>✅ Subscribe to recent data: <code>WHERE createdAt &gt; :cutoff</code></li>\n<li>✅ Subscribe to data in relevant states: <code>WHERE status IN ('pending', 'active', 'completed')</code></li>\n<li>❌ Subscribe to all orders across all customers when you only display one customer's data</li>\n<li>❌ Subscribe to historical data (>1 year old) when your feature only shows recent activity</li>\n</ul>",
      "<p>Observers and subscriptions continue running until explicitly canceled. Failing to cancel them causes:</p>\n<p>1. <strong>Memory leaks</strong>: Observers hold references to callbacks, preventing garbage collection</p>\n<p>2. <strong>Wasted resources</strong>: Continued processing of database changes and network updates for features no longer in use</p>\n<p>3. <strong>Unnecessary network traffic</strong>: Active subscriptions keep telling peers to send updates</p>\n<p><strong>When to cancel:</strong></p>\n<ul>\n<li>When a screen/feature is permanently closed</li>\n<li>When a widget is disposed (Flutter: in <code>dispose()</code> method)</li>\n<li>Before EVICT operations (prevents resync loops)</li>\n<li>During app termination</li>\n</ul>\n<p><strong>When NOT to cancel:</strong></p>\n<ul>\n<li>During temporary navigation (if returning soon)</li>\n<li>When app goes to background (if feature remains relevant)</li>\n</ul>",
      "<p>Prevents observer events from overwhelming the UI when rapid changes occur. Backpressure control ensures UI updates complete before the next batch arrives, improving responsiveness and preventing frame drops.</p>\n<p><strong>Platform availability:</strong></p>\n<ul>\n<li><strong>Non-Flutter platforms</strong> (iOS, Android, JavaScript, etc.): Recommended pattern available in SDK 4.x</li>\n<li><strong>Flutter</strong>: Not available in SDK 4.x. Will be available in future SDK version. Use <code>registerObserver()</code> with manual debouncing if needed.</li>\n</ul>\n<p><strong>Code Example</strong> (Non-Flutter):</p>",
      "<p>Unhandled observer errors can crash the app or leave UI in inconsistent state. Graceful error handling ensures app stability and prevents one malformed document from breaking the entire observer.</p>",
      "<p>Observer callbacks block the UI thread. Heavy computation causes frame drops and unresponsive UI. Offloading ensures smooth user experience.</p>\n<p><strong>Examples of heavy computation to avoid in observer callbacks:</strong></p>\n<ul>\n<li>Large JSON serialization/deserialization operations (e.g., <code>jsonEncode()</code> on hundreds of documents)</li>\n<li>Complex data transformations or aggregations across many documents</li>\n<li>Image processing or compression</li>\n<li>Network requests or file I/O operations</li>\n<li>Cryptographic operations (hashing, encryption)</li>\n<li>Sorting or filtering large datasets in memory</li>\n<li>Nested iterations over large collections</li>\n</ul>\n<p>Instead, extract raw data from <code>item.value</code> immediately and offload processing to background isolates (Flutter: <code>compute()</code>) or worker threads.</p>",
      "<p>Indexes can improve query performance by up to 90% for selective queries (those returning <10% of collection). Without indexes, Ditto performs full collection scans. However, indexes have overhead for writes and storage, so only index fields used in selective queries.</p>\n<p><strong>When to use indexes based on collection size:</strong></p>\n<ul>\n<li><strong>Small collections (<100 documents)</strong>: Indexes usually not necessary—full scans are fast enough</li>\n<li><strong>Medium collections (100-1,000 documents)</strong>: Consider indexes for frequently queried fields with high selectivity (<10% match rate)</li>\n<li><strong>Large collections (>1,000 documents)</strong>: Indexes strongly recommended for selective queries—performance gains become significant</li>\n<li><strong>Very large collections (>10,000 documents)</strong>: Indexes essential for acceptable query performance on selective queries</li>\n</ul>\n<p><strong>Key principle:</strong> Index effectiveness depends on both collection size AND query selectivity. A query returning 5% of documents benefits greatly from indexes in a 10,000-document collection (~9,500 documents skipped), but gains little in a 100-document collection (~95 documents skipped, minimal overhead difference).</p>",
      "<p>EXPLAIN reveals whether indexes are used, scan counts, and performance bottlenecks. Helps validate that indexes are correctly applied.</p>",
      "<p>N+1 patterns multiply query overhead. For example, fetching 100 related documents individually requires 100 queries vs 1 batch query. Batch queries reduce execution time and improve performance significantly.</p>",
      "<p>Without transactions, partial failures leave data in inconsistent state. If one operation succeeds but another fails, your data can become corrupted. Transactions ensure all operations succeed together or all fail together (atomicity), maintaining data integrity.</p>",
      "<p>Without transactions, data can change between queries, causing inconsistent reads. For example, if you first query for document IDs that match certain criteria, and then query for the details of each document, another peer might update or delete those documents in between your queries. This causes race conditions where your second query might return different data than what the first query suggested, leading to null references or inconsistent UI states.</p>\n<p>Read-only transactions provide snapshot isolation: all queries within the transaction see the database state as it was at the moment the transaction started, ensuring consistency across multiple reads.</p>",
      "<p>Nested read-write transactions create a deadlock where the inner transaction waits for the outer to complete, while the outer waits for the inner. The app freezes permanently and requires force-quit. This is a critical error that developers must avoid.</p>\n<p><strong>Platform note:</strong> Flutter SDK v4.11+ supports transactions but does not have this nesting limitation check. Non-Flutter platforms have this limitation.</p>",
      "<p>Long transactions hold locks, blocking other operations and reducing concurrency. Short transactions improve throughput and responsiveness.</p>",
      "<p>Closing Ditto before transactions complete causes data loss. Transactions may be incomplete or corrupted. You must manually track and await all transaction futures before closing the Ditto instance.</p>\n<p><strong>Platform note:</strong> This limitation is specific to Flutter SDK v4.11+. Other platforms automatically wait for transaction completion.</p>",
      "<p>Embedding binary data in documents bloats sync traffic and storage, as every document change syncs the entire binary blob. Attachments are lazy-loaded and fetched on-demand only when needed, dramatically reducing bandwidth usage and improving sync performance.</p>",
      "<p>Attachment fetches can fail due to network issues or missing peers. Graceful error handling provides user feedback and retry options.</p>",
      "<p>Without timeouts, attachment fetches can hang indefinitely when peers are offline. Timeouts ensure responsive UX.</p>",
      "<p>Unlike documents that sync through multi-hop relay, attachments require direct peer connection. Users may see document metadata but be unable to download the attachment until an intermediate peer fetches it first. Design UI to show attachment availability status (e.g., \"Available from 2 peers\").</p>",
      "<p>If all source peers disconnect during a fetch, Ditto will not report an error but the fetch will stall indefinitely, consuming resources. Timeout detection allows you to cancel stalled fetches, notify users, or retry gracefully.</p>",
      "<p>Orphaned attachments consume storage without serving any purpose. Cleanup frees storage on resource-constrained devices.</p>",
      "<p>Bluetooth LE has lower bandwidth than WiFi/LAN. Large attachments over Bluetooth are slow and impact user experience.</p>",
      "<p>OnlinePlaygroundIdentity has no access controls and is insecure for production. OnlineWithAuthentication enforces proper permissions via Ditto Big Peer.</p>",
      "<p>Exposed credentials allow unauthorized access to your Ditto app and data. Use <code>.env</code> files (excluded from git) or platform-specific secure storage.</p>",
      "<p>Expired tokens cause sync failures. Proactive token refresh ensures continuous sync and prevents user disruption.</p>",
      "<p>SharedKey lacks cloud-based access controls and audit trails. Suitable for air-gapped deployments but not for internet-connected apps.</p>",
      "<p>Hardcoded keys in mobile apps are vulnerable to reverse engineering. Attackers can decompile APK/IPA files to extract the SharedKey, compromising the entire mesh network. A single leaked key grants unauthorized access to all mesh data. Use controlled distribution mechanisms like MDM.</p>",
      "<p>Malicious inputs can cause injection vulnerabilities or data corruption. Validation ensures data integrity and security.</p>",
      "<p>Ditto syncs data across devices and peers. Sensitive data exposure increases risk. Use encryption or external secure storage for highly sensitive data.</p>",
      "<p>Verbose logging (<code>debug</code>) creates large log files, consumes storage, and may expose sensitive data. Production apps should log errors only.</p>",
      "<p>System info helps support teams diagnose environment-specific issues. Include it in bug reports.</p>",
      "<p>Sync health visibility helps diagnose connectivity issues and provides user feedback (e.g., \"offline mode\").</p>",
      "<p>Presence data enables features like \"online user\" lists and helps debug sync issues by showing peer connectivity.</p>",
      "<p>Offline-first is Ditto's core value proposition. Apps must work seamlessly while disconnected and sync correctly when connectivity returns. Multiple devices can modify the same data independently while offline, and changes must merge intelligently upon reconnection. Testing offline scenarios catches critical issues:</p>\n<ul>\n<li>Missing subscriptions that prevent data from syncing after reconnection</li>\n<li>Improper error handling during sync initialization</li>\n<li>Data loss or corruption during merge operations</li>\n<li>Business rule violations after conflict resolution (e.g., inventory going negative, duplicate order numbers)</li>\n<li>UI inconsistencies when offline changes sync to other devices</li>\n</ul>\n<p><strong>Testing approach:</strong></p>\n<ul>\n<li>Test <strong>your application's business logic</strong> with realistic concurrent scenarios using your actual domain models</li>\n<li>Verify <strong>business rules</strong> hold after conflict resolution (e.g., \"inventory never negative\", \"order numbers unique\")</li>\n<li>Focus on <strong>your data model</strong>, not just SDK API behavior—the SDK itself is already tested</li>\n</ul>\n<p><strong>Example test scenarios:</strong></p>\n<ul>\n<li><strong>Concurrent sales</strong>: Two offline POS terminals sell the same product. After sync, verify inventory doesn't go negative.</li>\n<li><strong>Unique identifiers</strong>: Two devices create orders while disconnected. After sync, verify all order numbers are unique.</li>\n<li><strong>Deletion scenarios</strong>: Device A deletes an order while Device B updates it offline. After sync, verify the final state matches your business rules (husked document handling, logical deletion filtering).</li>\n<li><strong>Subscription lifecycle</strong>: Create data offline, then start sync. Verify subscriptions properly request the data and observers trigger with new documents.</li>\n</ul>",
      "<p>Ditto uses CRDTs (Conflict-free Replicated Data Types) for automatic conflict resolution, and different CRDT types have different merge behaviors:</p>\n<ul>\n<li><strong>MAP fields (objects)</strong>: Use \"add-wins\" semantics—concurrent updates to different keys both persist</li>\n<li><strong>REGISTER fields (scalars, arrays)</strong>: Use \"last-write-wins\" (LWW) based on Hybrid Logical Clock—one update wins, the other is discarded</li>\n<li><strong>COUNTER fields</strong>: Use commutative addition—all increments from all devices are summed</li>\n</ul>\n<p>Without testing, you won't know if your data model handles conflicts correctly. For example, if you use arrays for mutable data that multiple devices modify concurrently, the last-write-wins behavior will cause data loss. Tests validate that your data model design is conflict-safe.</p>\n<p><strong>What to test:</strong></p>\n<ul>\n<li><strong>MAP field conflicts</strong>: Device A updates <code>field1</code>, Device B updates <code>field2</code> → both updates should persist after merge</li>\n<li><strong>REGISTER field conflicts</strong>: Device A sets <code>status = \"shipped\"</code>, Device B sets <code>status = \"delivered\"</code> → only one value wins (verify which one using HLC/timestamp)</li>\n<li><strong>Array conflicts</strong>: Device A appends <code>[item3]</code>, Device B appends <code>[item4]</code> → last-write-wins, one array is lost (this demonstrates why arrays are problematic)</li>\n<li><strong>COUNTER conflicts</strong>: Device A increments by 5, Device B increments by 3 → final value should be +8 (commutative addition)</li>\n<li><strong>Mixed conflicts</strong>: Device A updates MAP field while Device B updates REGISTER field → both changes should persist (different CRDT types)</li>\n</ul>\n<p><strong>Testing pattern:</strong></p>\n<ul>\n<li>Use multiple Ditto instances in tests (each represents a device)</li>\n<li>Simulate offline period by not syncing between instances</li>\n<li>Make concurrent modifications to the same document</li>\n<li>Manually trigger sync (or call sync methods) to merge changes</li>\n<li>Assert final state matches expected CRDT behavior</li>\n</ul>\n<p><strong>Example scenarios:</strong></p>\n<ul>\n<li><strong>Inventory counter</strong>: Two POS terminals concurrently decrement inventory. After sync, verify the total decrement is correct (not lost due to LWW).</li>\n<li><strong>Order modifications</strong>: Device A updates <code>shippingAddress</code>, Device B updates <code>paymentMethod</code>. After sync, verify both fields are updated (MAP add-wins).</li>\n<li><strong>Status race condition</strong>: Two devices concurrently update order status. After sync, verify the final status follows HLC ordering (last-write-wins for REGISTER).</li>\n<li><strong>Array append collision</strong>: Two devices append items to an array field. After sync, verify you understand which array won (demonstrates why MAP is safer for concurrent modifications).</li>\n</ul>",
      "<p>Deletion bugs cause ghost records in UI, data inconsistencies across devices, and sync failures. See [Section 4: Deletion & Storage Lifecycle](#section-4-deletion--storage-lifecycle) for implementation patterns.</p>",
      "<p>Tests that only verify SDK behavior (e.g., \"INSERT then SELECT returns the document\") provide no value—the SDK is already tested. What matters is testing how <strong>your specific business logic</strong> behaves under offline-first and concurrent scenarios. Focus on <strong>your application's invariants</strong> (e.g., \"inventory never negative\", \"order numbers unique\", \"deleted items don't reappear\").</p>",
      "<p>Device clocks are never perfectly synchronized. iOS typically has ~100ms drift, while Android can drift by several seconds. Timestamp-based validation (e.g., <code>createdAt &lt; updatedAt</code>) can fail due to clock skew. Tests ensure your logic tolerates reasonable clock drift.</p>"
    ],
    "codeExamples": [
      "<span></span><span class=\"c1\">// ✅ GOOD: Proper error handling for Ditto initialization</span>\n<span class=\"k\">try</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">Ditto</span><span class=\"p\">.</span><span class=\"n\">open</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"nl\">identity:</span><span class=\"w\"> </span><span class=\"n\">OnlinePlaygroundIdentity</span><span class=\"p\">(</span><span class=\"nl\">appId:</span><span class=\"w\"> </span><span class=\"n\">appId</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nl\">token:</span><span class=\"w\"> </span><span class=\"n\">token</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">startSync</span><span class=\"p\">();</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"kd\">on</span><span class=\"w\"> </span><span class=\"n\">DittoError</span><span class=\"w\"> </span><span class=\"k\">catch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"c1\">// Handle Ditto-specific errors (licensing, permissions, etc.)</span>\n<span class=\"w\">  </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;Ditto initialization failed: </span><span class=\"si\">${</span><span class=\"n\">e</span><span class=\"p\">.</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">showErrorDialog</span><span class=\"p\">(</span><span class=\"s1\">&#39;Failed to initialize sync&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">catch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"c1\">// Handle unexpected errors</span>\n<span class=\"w\">  </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;Unexpected error: </span><span class=\"si\">$</span><span class=\"n\">e</span><span class=\"s1\">&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Missing await (settings might not apply before sync)</span>\n<span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;ALTER SYSTEM SET DQL_STRICT_MODE = false&#39;</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// No await!</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">startSync</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"c1\">// May start with wrong settings</span>\n\n<span class=\"c1\">// ✅ GOOD: Always await ALTER SYSTEM SET</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;ALTER SYSTEM SET DQL_STRICT_MODE = false&#39;</span><span class=\"p\">);</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">startSync</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"c1\">// Settings guaranteed to be applied</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Sequential IDs cause collisions across offline devices</span>\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">orderCounter</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">;</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;order_</span><span class=\"si\">${</span><span class=\"n\">orderCounter</span><span class=\"o\">++</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;item&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;Coffee&#39;</span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"c1\">// Device A creates &quot;order_1&quot;, Device B also creates &quot;order_1&quot; → Collision!</span>\n\n<span class=\"c1\">// ✅ GOOD: Let Ditto auto-generate globally unique IDs</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;item&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;Coffee&#39;</span><span class=\"p\">}</span><span class=\"w\">  </span><span class=\"c1\">// No _id → Ditto auto-generates</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Array with concurrent updates (Last-Write-Wins)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;order_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;items&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[{</span><span class=\"s2\">&quot;id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;item1&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;qty&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">}]</span><span class=\"w\">  </span><span class=\"c1\">// Merge conflicts!</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ✅ GOOD: MAP structure for concurrent updates</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;order_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;items&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s2\">&quot;item1&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s2\">&quot;qty&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;productId&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;p1&quot;</span><span class=\"p\">}}</span><span class=\"w\">  </span><span class=\"c1\">// Merge-safe</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Storing calculated values (wastes bandwidth, risk of stale data)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;order_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;items&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s2\">&quot;item_1&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s2\">&quot;price&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">12.99</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;quantity&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;lineTotal&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">25.98</span><span class=\"p\">}</span><span class=\"w\">  </span><span class=\"c1\">// ❌ Calculated!</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;subtotal&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">25.98</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// ❌ Calculated!</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;tax&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2.60</span><span class=\"p\">,</span><span class=\"w\">        </span><span class=\"c1\">// ❌ Calculated!</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;total&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">28.58</span><span class=\"w\">      </span><span class=\"c1\">// ❌ Calculated!</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ✅ GOOD: Store only source data, calculate in app</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;order_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;items&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s2\">&quot;item_1&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s2\">&quot;price&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">12.99</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;quantity&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">}</span><span class=\"w\">  </span><span class=\"c1\">// Source data only</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// Calculate on-demand in application</span>\n<span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">calculateLineTotal</span><span class=\"p\">(</span><span class=\"n\">Map</span><span class=\"o\">&lt;</span><span class=\"kt\">String</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">dynamic</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">[</span><span class=\"s1\">&#39;price&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">[</span><span class=\"s1\">&#39;quantity&#39;</span><span class=\"p\">];</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">calculateTotal</span><span class=\"p\">(</span><span class=\"n\">Map</span><span class=\"o\">&lt;</span><span class=\"kt\">String</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">dynamic</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">taxRate</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subtotal</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">values</span><span class=\"p\">.</span><span class=\"n\">fold</span><span class=\"p\">(</span><span class=\"m\">0.0</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">sum</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">[</span><span class=\"s1\">&#39;price&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">[</span><span class=\"s1\">&#39;quantity&#39;</span><span class=\"p\">]));</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">subtotal</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">subtotal</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">taxRate</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Syncing unnecessary data</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;task_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;title&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;Review PR&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;status&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;pending&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"c1\">// ❌ UI state (device-specific, not business data)</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;isExpanded&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;selectedTab&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"c1\">// ❌ Temporary state (transient, changes frequently)</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;uploadProgress&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">67</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;isProcessing&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"c1\">// ❌ Device-specific (only relevant to one device)</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;localFilePath&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;/storage/cache/task_123.tmp&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"c1\">// ❌ Cached data (can be fetched from external source)</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;userAvatarUrl&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;https://api.example.com/avatars/user_789.jpg&quot;</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ✅ GOOD: Only business state synced, other data managed locally</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;task_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;title&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;Review PR&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;status&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;pending&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;assignee&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;user_789&quot;</span><span class=\"w\">  </span><span class=\"c1\">// Business data: who&#39;s responsible</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// Store non-business state locally (ViewModel, cache, device storage):</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">TaskViewModel</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// Ditto business data</span>\n<span class=\"w\">  </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">isExpanded</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// UI state (local)</span>\n<span class=\"w\">  </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">uploadProgress</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.0</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// Temporary state (local)</span>\n<span class=\"w\">  </span><span class=\"kt\">String</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">cachedAvatarUrl</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// Cached data (fetched as needed)</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Full document replacement (unnecessary sync traffic)</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order) ON ID CONFLICT DO UPDATE&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;status&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;done&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;customer&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;items&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[...]}</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ GOOD: Field-level update (only changed field syncs)</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE orders SET status = :status WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;status&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;done&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: DO UPDATE syncs ALL fields (even unchanged)</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order) ON ID CONFLICT DO UPDATE&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;status&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;done&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;customer&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ GOOD: DO UPDATE_LOCAL_DIFF only syncs changed fields (SDK 4.12+)</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order) ON ID CONFLICT DO UPDATE_LOCAL_DIFF&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;status&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;done&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;customer&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: SET operation for counters (lost updates)</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">product</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM products WHERE _id = :id&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;p1&#39;</span><span class=\"p\">}</span>\n<span class=\"p\">)).</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">first</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE products SET viewCount = :count WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;count&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">product</span><span class=\"p\">[</span><span class=\"s1\">&#39;viewCount&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">??</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;p1&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ GOOD: COUNTER type for distributed counters (SDK 4.14.0+)</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE products APPLY viewCount COUNTER INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;p1&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Using counter for derived inventory value</span>\n<span class=\"c1\">// Product document maintains currentStock counter</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;product_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;name&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;Coffee Beans&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;currentStock&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">50</span><span class=\"w\">  </span><span class=\"c1\">// ❌ Counter updated from orders collection</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// When order is placed, must update TWO collections:</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;productId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;product_123&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;qty&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"p\">}}</span>\n<span class=\"p\">);</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE products APPLY currentStock PN_INCREMENT BY -5.0 WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;product_123&#39;</span><span class=\"p\">}</span>\n<span class=\"p\">);</span>\n<span class=\"c1\">// Problems: Cross-collection coupling, integrity risk, not self-correcting</span>\n\n<span class=\"c1\">// ✅ GOOD: Calculate inventory from order history</span>\n<span class=\"c1\">// Product document has no stock counter</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;product_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;name&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;Coffee Beans&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;initialStock&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"w\">  </span><span class=\"c1\">// Starting inventory (baseline)</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// Order documents are source of truth</span>\n<span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;productId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;product_123&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;qty&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"p\">}</span>\n<span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o2&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;productId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;product_123&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;qty&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">10</span><span class=\"p\">}</span>\n\n<span class=\"c1\">// Calculate current stock from orders when needed:</span>\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">calculateCurrentStock</span><span class=\"p\">(</span><span class=\"kt\">String</span><span class=\"w\"> </span><span class=\"n\">productId</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">product</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">getProduct</span><span class=\"p\">(</span><span class=\"n\">productId</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">getOrders</span><span class=\"p\">(</span><span class=\"n\">productId</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">totalOrdered</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"p\">.</span><span class=\"n\">fold</span><span class=\"p\">(</span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">sum</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"p\">[</span><span class=\"s1\">&#39;qty&#39;</span><span class=\"p\">]);</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">product</span><span class=\"p\">[</span><span class=\"s1\">&#39;initialStock&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">totalOrdered</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"c1\">// Benefits: Single source of truth, self-correcting, no cross-collection updates</span>\n",
      "<span></span><span class=\"c1\">// ❌ WRONG: Filtering deletion flags in subscriptions</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE isDeleted != true&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// Blocks relay!</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ CORRECT: Subscribe broadly, filter in observer</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// No filter - allows multi-hop relay</span>\n<span class=\"p\">);</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">observer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE isDeleted != true&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// Filter here</span>\n<span class=\"w\">  </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">updateUI</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">signalNext</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: EVICT without canceling subscription (resync loop!)</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;EVICT FROM orders WHERE deletedAt &lt; :cutoff&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;cutoff&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cutoffDate</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ GOOD: Cancel subscription → EVICT → Recreate with updated filter</span>\n<span class=\"n\">orderSubscription</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span><span class=\"w\">  </span><span class=\"c1\">// Step 1: Cancel first</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;EVICT FROM orders WHERE isDeleted = true AND deletedAt &lt; :cutoff&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;cutoff&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cutoffDate</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"n\">orderSubscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE isDeleted != true&#39;</span><span class=\"p\">,</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ PROBLEM: DELETE + concurrent UPDATE = husked document</span>\n<span class=\"c1\">// Device A:</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;DELETE FROM cars WHERE _id = :id&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;car1&#39;</span><span class=\"p\">});</span>\n<span class=\"c1\">// Device B (offline):</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;UPDATE cars SET color = :color WHERE _id = :id&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;color&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;blue&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;car1&#39;</span><span class=\"p\">});</span>\n<span class=\"c1\">// Result after sync: {_id: &quot;car1&quot;, color: &quot;blue&quot;, make: null, model: null}</span>\n\n<span class=\"c1\">// ✅ SOLUTION: Soft-Delete prevents husked documents</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE cars SET isDeleted = true, deletedAt = :time WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;time&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DateTime</span><span class=\"p\">.</span><span class=\"n\">now</span><span class=\"p\">().</span><span class=\"n\">toIso8601String</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;car1&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Fetch all documents, filter in application code</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">activeOrders</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span>\n<span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">where</span><span class=\"p\">((</span><span class=\"n\">order</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"p\">[</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"s1\">&#39;active&#39;</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">toList</span><span class=\"p\">();</span>\n<span class=\"c1\">// Problems: High memory usage, slow deserialization, all documents loaded</span>\n\n<span class=\"c1\">// ✅ GOOD: Filter at database level with WHERE clause</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE status = :status&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;status&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;active&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">activeOrders</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">).</span><span class=\"n\">toList</span><span class=\"p\">();</span>\n<span class=\"c1\">// Benefits: Low memory usage, fast query, only filtered documents loaded</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Retaining QueryResultItem references (memory leak)</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">OrdersViewModel</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"o\">&lt;</span><span class=\"n\">QueryResultItem</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">_orderItems</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[];</span><span class=\"w\">  </span><span class=\"c1\">// ❌ Storing cursors!</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">updateOrders</span><span class=\"p\">(</span><span class=\"n\">QueryResult</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_orderItems</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">toList</span><span class=\"p\">();</span><span class=\"w\">  </span><span class=\"c1\">// ❌ Long-lived references</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">displayOrder</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_orderItems</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">].</span><span class=\"n\">value</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// ❌ Using stale cursor</span>\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;Order: </span><span class=\"si\">${</span><span class=\"n\">order</span><span class=\"p\">[</span><span class=\"s1\">&#39;title&#39;</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"c1\">// Problem: Holds QueryResultItem cursors indefinitely, memory never released</span>\n\n<span class=\"c1\">// ✅ GOOD: Extract data immediately, store plain objects</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">OrdersViewModel</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"o\">&lt;</span><span class=\"n\">Order</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">_orders</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[];</span><span class=\"w\">  </span><span class=\"c1\">// ✅ Plain application models</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">updateOrders</span><span class=\"p\">(</span><span class=\"n\">QueryResult</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// Extract data immediately and convert to models</span>\n<span class=\"w\">    </span><span class=\"n\">_orders</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span>\n<span class=\"w\">      </span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"p\">.</span><span class=\"n\">fromMap</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">))</span>\n<span class=\"w\">      </span><span class=\"p\">.</span><span class=\"n\">toList</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"c1\">// QueryResultItems fall out of scope here, GC can clean them up</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">displayOrder</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_orders</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">];</span><span class=\"w\">  </span><span class=\"c1\">// ✅ Using plain model</span>\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;Order: </span><span class=\"si\">${</span><span class=\"n\">order</span><span class=\"p\">.</span><span class=\"n\">title</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// Application model (plain Dart class)</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">Order</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"w\"> </span><span class=\"n\">title</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"n\">Order</span><span class=\"p\">({</span><span class=\"kd\">required</span><span class=\"w\"> </span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kd\">required</span><span class=\"w\"> </span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"n\">title</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kd\">required</span><span class=\"w\"> </span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"n\">status</span><span class=\"p\">});</span>\n\n<span class=\"w\">  </span><span class=\"kd\">factory</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"p\">.</span><span class=\"n\">fromMap</span><span class=\"p\">(</span><span class=\"n\">Map</span><span class=\"o\">&lt;</span><span class=\"kt\">String</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">dynamic</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"nl\">id:</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">[</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">title:</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">[</span><span class=\"s1\">&#39;title&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">status:</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">[</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Request/response pattern (treating Ditto like HTTP)</span>\n<span class=\"n\">Future</span><span class=\"o\">&lt;</span><span class=\"n\">List</span><span class=\"o\">&lt;</span><span class=\"n\">Order</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">fetchOrders</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"kd\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">Future</span><span class=\"p\">.</span><span class=\"n\">delayed</span><span class=\"p\">(</span><span class=\"n\">Duration</span><span class=\"p\">(</span><span class=\"nl\">seconds:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">));</span><span class=\"w\">  </span><span class=\"c1\">// Inefficient waiting!</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span><span class=\"w\">  </span><span class=\"c1\">// Defeats mesh sync benefits</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"p\">.</span><span class=\"n\">fromMap</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">)).</span><span class=\"n\">toList</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ✅ GOOD: Long-lived subscription with observer for real-time updates</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">OrdersService</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">Subscription</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">_subscription</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">StoreObserver</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">_observer</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">initialize</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// Start subscription - keep alive for feature lifetime</span>\n<span class=\"w\">    </span><span class=\"n\">_subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Use observer for real-time updates</span>\n<span class=\"w\">    </span><span class=\"n\">_observer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">updateUI</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"p\">.</span><span class=\"n\">fromMap</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">)));</span>\n<span class=\"w\">        </span><span class=\"n\">signalNext</span><span class=\"p\">();</span>\n<span class=\"w\">      </span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">dispose</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_observer</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">_subscription</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span><span class=\"w\">  </span><span class=\"c1\">// Cancel only when feature is done</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Narrow subscription filter breaks multi-hop relay</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE priority = :priority&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;priority&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;high&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"c1\">// Problem: This device won&#39;t store/relay low-priority orders to other peers</span>\n\n<span class=\"c1\">// ✅ GOOD: Broad subscription + local filter in observer</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// No priority filter - enables relay</span>\n<span class=\"p\">);</span>\n\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">observer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE priority = :priority&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// Filter here for UI</span>\n<span class=\"w\">  </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">updateUI</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">);</span><span class=\"w\">  </span><span class=\"c1\">// Only high-priority orders displayed</span>\n<span class=\"w\">    </span><span class=\"n\">signalNext</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;priority&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;high&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Overly broad subscription when feature only displays current user&#39;s data</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// Syncs ALL orders from ALL users!</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ GOOD: Scoped to relevant customer</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE customerId = :customerId&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;customerId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">currentUserId</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"c1\">// Only syncs orders for this customer</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: No references saved, cannot cancel - memory leak</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">OrdersScreen</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">StatefulWidget</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nd\">@override</span>\n<span class=\"w\">  </span><span class=\"n\">State</span><span class=\"o\">&lt;</span><span class=\"n\">OrdersScreen</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">createState</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">_OrdersScreenState</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">_OrdersScreenState</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"o\">&lt;</span><span class=\"n\">OrdersScreen</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nd\">@override</span>\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">initState</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">super</span><span class=\"p\">.</span><span class=\"n\">initState</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"cm\">/* ... */</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ✅ GOOD: Save references and cancel in dispose()</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">_OrdersScreenState</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"o\">&lt;</span><span class=\"n\">OrdersScreen</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">Subscription</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">_subscription</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">StoreObserver</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">_observer</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"nd\">@override</span>\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">initState</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">super</span><span class=\"p\">.</span><span class=\"n\">initState</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">_subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">_observer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"cm\">/* ... */</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n\n<span class=\"w\">  </span><span class=\"nd\">@override</span>\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">dispose</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_observer</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">_subscription</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"k\">super</span><span class=\"p\">.</span><span class=\"n\">dispose</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ✅ GOOD: Observer with backpressure control</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">observer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM sensor_data WHERE deviceId = :deviceId&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;deviceId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">deviceId</span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">updateUI</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">).</span><span class=\"n\">toList</span><span class=\"p\">());</span>\n<span class=\"w\">    </span><span class=\"c1\">// Call signalNext() when ready for next batch</span>\n<span class=\"w\">    </span><span class=\"n\">signalNext</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Multiple separate operations without atomicity</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;customerId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;total&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"p\">}},</span>\n<span class=\"p\">);</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE customers APPLY orderCount PN_INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"c1\">// Problem: If second operation fails, order exists but customer count is wrong</span>\n\n<span class=\"c1\">// ✅ GOOD: Atomic transaction ensures all-or-nothing execution</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">transaction</span><span class=\"p\">(</span><span class=\"nl\">hint:</span><span class=\"w\"> </span><span class=\"s1\">&#39;create-order&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kd\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;customerId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;total&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"p\">}},</span>\n<span class=\"w\">  </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;UPDATE customers APPLY orderCount PN_INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n<span class=\"c1\">// Benefit: Both operations succeed together or both fail, ensuring data consistency</span>\n",
      "<span></span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">results</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">transaction</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kd\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// First, get all order IDs for a specific customer</span>\n<span class=\"w\">    </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">orderIds</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;SELECT _id FROM orders WHERE customerId = :customerId&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;customerId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">)).</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">[</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"p\">).</span><span class=\"n\">toList</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Then, fetch full details for each order</span>\n<span class=\"w\">    </span><span class=\"c1\">// Guaranteed to see the same data state as the first query</span>\n<span class=\"w\">    </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">orderDetails</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE _id IN :ids&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;ids&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">orderIds</span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">orderDetails</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"nl\">isReadOnly:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">hint:</span><span class=\"w\"> </span><span class=\"s1\">&#39;fetch-orders&#39;</span><span class=\"p\">,</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ BAD: Nested read-write transaction causes permanent deadlock</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">transaction</span><span class=\"p\">((</span><span class=\"n\">tx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kd\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;total&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"p\">}},</span>\n<span class=\"w\">  </span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"c1\">// DEADLOCK: Inner transaction waits for outer, outer waits for inner</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">transaction</span><span class=\"p\">((</span><span class=\"n\">innerTx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kd\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">innerTx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;UPDATE customers APPLY orderCount PN_INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">});</span>\n<span class=\"p\">});</span>\n<span class=\"c1\">// Result: App freezes permanently, requires force-quit</span>\n"
    ]
  },
  "ja": {
    "title": "Ditto SDK実装チェックリスト",
    "completed": "完了",
    "showCode": "コードを表示",
    "hideCode": "コードを非表示",
    "officialDoc": "公式ドキュメント",
    "whatMeans": "概要:",
    "whyMatters": "解説:",
    "sections": [
      "<span class=\"section-number\">セクション1:</span> 初期化とAPI基礎",
      "<span class=\"section-number\">セクション2:</span> データモデリングの基礎",
      "<span class=\"section-number\">セクション3:</span> 書き込み操作",
      "<span class=\"section-number\">セクション4:</span> 削除とストレージライフサイクル",
      "<span class=\"section-number\">セクション5:</span> 読み取り操作とクエリ",
      "<span class=\"section-number\">セクション6:</span> サブスクリプションとリアルタイム同期",
      "<span class=\"section-number\">セクション7:</span> パフォーマンス最適化",
      "<span class=\"section-number\">セクション8:</span> トランザクション",
      "<span class=\"section-number\">セクション9:</span> 添付ファイル (Attachments)",
      "<span class=\"section-number\">セクション10:</span> セキュリティ",
      "<span class=\"section-number\">セクション11:</span> 可観測性とテスト"
    ],
    "items": [
      "適切な認証モードでDittoを初期化する",
      "Ditto初期化エラーを適切に処理する",
      "DQL API（現行）を使用し、レガシーBuilder APIを使用しない",
      "startSync()の前に必ずALTER SYSTEM SETをawaitする",
      "デバイス間で衝突する可能性のあるIDパターンを避ける",
      "可変データには配列ではなくMAPを使用する",
      "埋め込みと外部キー関係を適切に使い分ける",
      "大きなバイナリデータを直接ドキュメントに保存しない",
      "計算・派生フィールドをドキュメントに保存しない",
      "不要なデータをドキュメントから除外する",
      "ピア間の型安全性のためにDQL Strict Modeを有効化する [SDK 4.11+]",
      "安全な繰り返しINSERTにはON ID CONFLICT DO NOTHINGを使用する",
      "ドキュメント全体の置き換えではなくフィールドレベルのUPDATEを使用する",
      "同じ値でフィールドを不必要に更新しない",
      "効率的なアップサートにはDO UPDATE_LOCAL_DIFFを使用する [SDK 4.12+]",
      "分散カウンターにはCOUNTER型を使用する [SDK 4.14.0+]",
      "計算可能な派生値にはカウンターを使用しない",
      "イベント履歴には配列ではなく個別のドキュメントを使用する",
      "デバイスローカルテンプレートにはINITIAL DOCUMENTSを使用する",
      "Soft-DeleteとDELETEクエリの違いを理解する",
      "（Soft-Delete使用時）広くサブスクライブし、オブザーバー/クエリでフィルタする",
      "（Soft-Delete使用時）古い削除済みドキュメントを定期的にEVICTする",
      "（Soft-Delete使用時）ローカル削除のみにはEVICTを使用する",
      "（Soft-Delete使用時）再同期ループを防ぐためEVICT前にサブスクリプションをキャンセルする",
      "（DELETE使用時）トゥームストーンとTTL動作を理解する",
      "（DELETE使用時）huskedドキュメントとその防止方法を理解する",
      "（DELETE使用時）永久的で不可逆な削除にのみDELETEを使用する",
      "アプリケーションコードではなくクエリでデータをフィルタする",
      "大規模データセットにはクエリ結果のページネーションを使用する",
      "QueryResultItem参照を長期間保持しない",
      "リクエスト/レスポンスパターンではなく長期サブスクリプションを使用する",
      "広くサブスクライブし、オブザーバーでフィルタする（マルチホップリレー用）",
      "不要なデータにサブスクライブしない",
      "不要になったオブザーバーとサブスクリプションをキャンセルする",
      "バックプレッシャー制御にはregisterObserverWithSignalNextを使用する",
      "オブザーバーエラーを適切に処理する",
      "オブザーバーコールバックで重い処理を避ける",
      "選択的クエリにはCREATE INDEXを使用する [SDK 4.12+]",
      "インデックス使用を確認するためにEXPLAINを使用する [SDK 4.12+]",
      "N+1クエリパターン（複数の個別ルックアップ）を避ける",
      "複数の操作をトランザクションでバッチ処理する",
      "一貫性のある複数クエリ読み取りには読み取り専用トランザクションを使用する",
      "読み書きトランザクションをネストしない（デッドロックの原因）",
      "トランザクションは短く集中させる",
      "（Flutter固有）ditto.close()の前に必ず保留中のトランザクションをawaitする",
      "大きなバイナリデータ（画像、動画、ファイル）には添付ファイルを使用する",
      "添付ファイル取得エラーを適切に処理する",
      "添付ファイル取得タイムアウトを適切に設定する",
      "添付ファイルの可用性制約（直接ピアのみ）を理解する",
      "停止した添付ファイル取得のタイムアウト検出を実装する",
      "孤立した添付ファイルトークンを定期的にクリーンアップする",
      "Bluetooth LE転送用の添付ファイルサイズ制限を検討する",
      "本番アプリにはOnlineWithAuthenticationIdentityを使用する",
      "APIキー、トークン、認証情報をコミットしない",
      "適切な認証デリゲートコールバックを実装する",
      "完全オフライン展開にのみSharedKeyIdentityを使用する",
      "アプリケーションコードにSharedKeyをハードコードしない（セキュリティリスク）",
      "Dittoに挿入する前にユーザー入力を検証・サニタイズする",
      "機密データ（PII、パスワード）をDittoドキュメントに保存しない",
      "本番環境では最小ログレベルを有効化する",
      "デバッグ用にシステム情報をクエリする（SDK 4.13+）",
      "可観測性コールバックで同期ヘルスを監視する",
      "プレゼンスを使用して接続ピアを追跡する",
      "オフラインファースト動作をテストする（オフライン時にデータ作成）",
      "複数デバイスの競合シナリオをテストする",
      "削除パターン（Soft-DeleteとDELETE）をテストする",
      "SDK動作ではなくアプリケーション固有のビジネスロジックをテストする",
      "タイムスタンプ精度とクロックドリフト耐性をテストする"
    ],
    "whatMeansSections": [
      "<p><strong data-what-means>概要:</strong> 適切なIDモードを選択する:</p>\n<p>- <strong>開発環境:</strong> <code>OnlinePlaygroundIdentity</code>（テスト専用、アクセス制御なし）</p>\n<p>- <strong>本番環境:</strong> 認証デリゲート付き <code>OnlineWithAuthenticationIdentity</code></p>\n<p>- <strong>エアギャップ/オフライン環境:</strong> <code>SharedKeyIdentity</code>（クラウド同期なし）</p>",
      "<p><strong data-what-means>概要:</strong> <code>Ditto.open()</code>、<code>startSync()</code>、<code>execute()</code> を try-catch ブロックでラップする。無効なライセンス、ネットワーク利用不可、権限問題、またはクエリエラーなどのケースを処理する。</p>",
      "<p><strong data-what-means>概要:</strong> <code>ditto.store.execute('SELECT * FROM collection ...')</code> および関連するDQLメソッドを使用する。<code>ditto.store.collection('name').find()</code> のような非推奨のビルダーAPIは避ける。</p>",
      "<p><strong data-what-means>概要:</strong> <code>DQL_STRICT_MODE</code> などのシステム設定を構成する際は、<code>startSync()</code> や他の操作を呼び出す前に必ず <code>await</code> を使用する。</p>",
      "<p><strong data-what-means>概要:</strong> 複数のデバイスが独立してドキュメントを作成できる場合、連番カウンター、タイムスタンプ、またはデバイスベースのパターンをドキュメントIDに使用しない。グローバルに一意な識別子（UUID v4、ULID）を使用するか、Dittoに自動生成させる。複合キー（例: <code>{\"userId\": \"user123\", \"orderId\": \"&lt;uuid&gt;\"}</code>）は、その組み合わせが一意であることが保証されている場合に許容される。</p>",
      "<p><strong data-what-means>概要:</strong> 配列はLast-Write-Wins（REGISTER CRDT）を使用するため、複数のピアが同時に更新するとマージ競合が発生する。複数のデバイスで変更可能なデータには、一意のキーを持つMAP（オブジェクト）構造を使用する。</p>",
      "<p><strong data-what-means>概要:</strong> 関連データを単一のドキュメントに埋め込むか、外部キー参照で別のドキュメントにするかを決定する:</p>\n<p><strong>埋め込み（非正規化）:</strong></p>\n<p>- 関連データを親ドキュメント内に直接保存</p>\n<p>- すべてのデータを取得するのに単一のクエリが必要</p>\n<p>- ドキュメント間でデータ重複（複数の注文に同じ顧客情報）</p>\n<p>- すべての関連データが単一のユニットとして同期</p>\n<p>- 最適な用途: 一緒に取得される小さな静的データ（注文品目、住所付きユーザープロフィール）</p>\n<p><strong>外部キー（正規化）:</strong></p>\n<p>- 関連データを別のドキュメントに保存、IDで参照</p>\n<p>- 複数の連続したクエリが必要（DittoはJOINをサポートしていない）</p>\n<p>- データ重複なし、単一の情報源</p>\n<p>- 関連データが独立して同期</p>\n<p>- 最適な用途: 大きなデータ、頻繁に更新されるデータ、または独立してアクセスされるデータ（ユーザープロフィール、製品カタログ）</p>",
      "<p><strong data-what-means>概要:</strong> 画像、動画、または大きなファイルをbase64文字列としてドキュメントフィールドに保存しない。代わりにDitto添付ファイルを使用する。</p>",
      "<p><strong data-what-means>概要:</strong> 既存のデータから計算できるフィールド（例: <code>lineTotal = price × quantity</code>、<code>subtotal = sum(items)</code>、<code>total = subtotal + tax</code>）を保存しない。必要なときにアプリケーションコードでこれらの値を計算する。</p>",
      "<p><strong data-what-means>概要:</strong> Dittoドキュメントのすべてのフィールドは、メッシュネットワーク内のすべてのピアに同期され、帯域幅とストレージを消費する。デバイス間で必要な共有ビジネス状態を表すデータのみを含める。同期しないもの:</p>\n<p>- <strong>UI固有の状態:</strong> 展開/選択/ホバー状態、スクロール位置、アクティブなタブインデックス</p>\n<p>- <strong>一時的/過渡的な状態:</strong> アップロード進行状況、処理フラグ、再試行カウンター、ローディングインジケーター</p>\n<p>- <strong>デバイス固有のデータ:</strong> ローカルファイルパス、デバイスID（認可に必要でない限り）、デバイス機能</p>\n<p>- <strong>キャッシュ/派生データ:</strong> 他のフィールドから計算できる値または外部ソースから取得できる値</p>\n<p>- <strong>高頻度の短命データ:</strong> マウスカーソル位置、タイピングインジケーター、永続化不要なリアルタイムセンサー読み取り</p>\n<p>- <strong>デバッグ/開発データ:</strong> テストフラグ、デバッグカウンター、開発専用メタデータ</p>",
      "<p><strong data-what-means>概要:</strong> ピア間での型の一貫性を強制するためにDQL Strict Modeを有効化する [SDK 4.11+]</p>",
      "<p><strong data-what-means>概要:</strong> 安全な繰り返しINSERTには <code>ON ID CONFLICT DO NOTHING</code> を使用する</p>",
      "<p><strong data-what-means>概要:</strong> ドキュメント全体を置き換える代わりに、<code>UPDATE</code> を使用して特定のフィールドのみを変更する</p>",
      "<p><strong data-what-means>概要:</strong> 既に同じ値を持つフィールドを更新しない（不要な同期トラフィックを回避）</p>",
      "<p><strong data-what-means>概要:</strong> 効率的なアップサート（存在しない場合は挿入、存在する場合は更新）には <code>DO UPDATE_LOCAL_DIFF</code> を使用する [SDK 4.12+]</p>",
      "<p><strong data-what-means>概要:</strong> 分散カウンター（在庫数量、いいね数など）には <code>COUNTER</code> 型を使用する [SDK 4.14.0+]</p>",
      "<p><strong data-what-means>概要:</strong> 計算可能な派生値（合計、平均など）にはカウンターを使用しない</p>",
      "<p><strong data-what-means>概要:</strong> イベント履歴やログには配列ではなく個別のドキュメントを使用する</p>",
      "<p><strong data-what-means>概要:</strong> デバイスローカルテンプレートには <code>INITIAL DOCUMENTS</code> を使用する</p>",
      "<p><strong data-what-means>概要:</strong> Soft-Delete（論理削除）とDELETEクエリ（物理削除）の違いを理解する</p>",
      "<p><strong data-what-means>概要:</strong> （Soft-Delete使用時）広くサブスクライブし、オブザーバー/クエリでフィルタする</p>",
      "<p><strong data-what-means>概要:</strong> （Soft-Delete使用時）ストレージを解放するため、古い削除済みドキュメントを定期的にEVICTする</p>",
      "<p><strong data-what-means>概要:</strong> （Soft-Delete使用時）ローカルデバイスからのみドキュメントを削除し、他のピアには伝播させない場合は <code>EVICT</code> を使用する</p>",
      "<p><strong data-what-means>概要:</strong> （Soft-Delete使用時）EVICT前にサブスクリプションをキャンセルして再同期ループを防ぐ</p>",
      "<p><strong data-what-means>概要:</strong> （DELETE使用時）トゥームストーン（削除マーカー）とTTL（Time To Live）動作を理解する</p>",
      "<p><strong data-what-means>概要:</strong> （DELETE使用時）huskedドキュメント（DELETEとUPDATEの同時実行による）とその防止方法を理解する</p>",
      "<p><strong data-what-means>概要:</strong> （DELETE使用時）永久的で不可逆な削除にのみ <code>DELETE</code> を使用する</p>",
      "<p><strong data-what-means>概要:</strong> アプリケーションコードで結果をフィルタするのではなく、DQLクエリの <code>WHERE</code> 句でデータをフィルタする</p>",
      "<p><strong data-what-means>概要:</strong> 大規模データセット（>1000行）にはクエリ結果のページネーションを使用する</p>",
      "<p><strong data-what-means>概要:</strong> <code>QueryResultItem</code> オブジェクトへの参照を長期間保持しない</p>",
      "<p><strong data-what-means>概要:</strong> リクエスト/レスポンスパターンではなく長期サブスクリプションを使用する</p>",
      "<p><strong data-what-means>概要:</strong> マルチホップリレーを確実にするため、広くサブスクライブし（フィルタなしまたは緩いフィルタ）、オブザーバーで厳密にフィルタする</p>",
      "<p><strong data-what-means>概要:</strong> 不要なデータにサブスクライブしない（不要な同期トラフィックを回避）</p>",
      "<p><strong data-what-means>概要:</strong> 画面を離れるとき、コンポーネントを破棄するとき、またはデータが不要になったときに、オブザーバーとサブスクリプションをキャンセルする</p>",
      "<p><strong data-what-means>概要:</strong> バックプレッシャー制御には <code>registerObserverWithSignalNext</code> を使用する</p>",
      "<p><strong data-what-means>概要:</strong> オブザーバーコールバック内で発生するエラーを適切に処理する</p>",
      "<p><strong data-what-means>概要:</strong> オブザーバーコールバック内で重い処理（大規模なデータ変換、同期API呼び出し、ファイルI/Oなど）を実行しない</p>",
      "<p><strong data-what-means>概要:</strong> 選択的クエリ（特定の値やフィールド範囲でフィルタリング）には <code>CREATE INDEX</code> を使用する [SDK 4.12+]</p>",
      "<p><strong data-what-means>概要:</strong> <code>EXPLAIN</code> を使用してクエリがインデックスを使用しているか、フルコレクションスキャンを実行しているかを確認する [SDK 4.12+]</p>",
      "<p><strong data-what-means>概要:</strong> N+1クエリパターン（ループ内で個別のクエリを実行）を避ける</p>",
      "<p><strong data-what-means>概要:</strong> 複数の操作（INSERT、UPDATE、DELETE）を単一のトランザクションにバッチ処理する</p>",
      "<p><strong data-what-means>概要:</strong> 一貫性のある複数クエリ読み取りには読み取り専用トランザクションを使用する</p>",
      "<p><strong data-what-means>概要:</strong> 読み書きトランザクションをネストしない（デッドロックの原因となる）</p>",
      "<p><strong data-what-means>概要:</strong> トランザクション内の操作数と実行時間を最小限に抑える。重い計算、ネットワーク呼び出し、または長時間実行されるロジックを避ける。</p>",
      "<p><strong data-what-means>概要:</strong> （Flutter固有）Flutter SDKでは、<code>ditto.close()</code> を呼び出す前にすべての保留中のトランザクションを追跡し、<code>await Future.wait(pendingTransactions)</code> を使用する。他のプラットフォームとは異なり、Flutter SDKは自動的にトランザクションを待機しない。</p>",
      "<p><strong data-what-means>概要:</strong> 大きなバイナリデータ（通常 >100KB）をドキュメントフィールドにbase64文字列として保存しない。Ditto添付ファイルとして保存し、ドキュメントフィールドに添付ファイルトークンを保存してバイナリデータを参照する。</p>",
      "<p><strong data-what-means>概要:</strong> <code>fetchAttachment()</code> を try-catch ブロックでラップして、ピアの利用不可、ネットワークタイムアウト、または破損データなどのケースを処理する</p>",
      "<p><strong data-what-means>概要:</strong> <code>fetchAttachment()</code> のタイムアウトパラメータを使用して、遅いまたは利用できないピアの待機時間を制限する: <code>fetchAttachment(token, timeout: Duration(seconds: 30))</code></p>",
      "<p><strong data-what-means>概要:</strong> 添付ファイルは、既に添付ファイルを取得した<strong>直接ピア</strong>（直接接続されたデバイス）からのみ取得できる。デバイスAが添付ファイルを持ち、デバイスCがそれを必要とするマルチホップシナリオでは、デバイスB（中間）がまだ取得していない場合、デバイスCはデバイスAから取得できない。</p>",
      "<p><strong data-what-means>概要:</strong> Dittoの添付ファイル取得は、接続が停止したときにエラーを発生させない。単に進行が停止するだけ。進行監視ラッパーを実装して、タイムアウト期間（例: 5分）内に進行がないことを検出する。</p>",
      "<p><strong data-what-means>概要:</strong> 添付ファイルを含むドキュメントを削除するときは、添付ファイル参照の削除を検討する。対応するドキュメントのない添付ファイルトークンを定期的にスキャンする。</p>",
      "<p><strong data-what-means>概要:</strong> Bluetooth LEトランスポートに依存するモバイルデバイスでは、添付ファイルサイズを制限する（例: 画像は &lt;5MB、より大きなものにはサムネイルを使用）。Bluetooth経由での同期パフォーマンスをテストする。</p>",
      "<p><strong data-what-means>概要:</strong> <code>OnlineWithAuthenticationIdentity</code> でDittoを構成し、認証デリゲートを実装して認証システム（OAuth、JWT、カスタム）と統合する</p>",
      "<p><strong data-what-means>概要:</strong> Ditto App ID、認証トークン、APIキーには環境変数または安全なストレージを使用する。それらをハードコードしたり、バージョン管理にコミットしたりしない。</p>",
      "<p><strong data-what-means>概要:</strong> <code>onAuthenticationExpiringSoon()</code> および <code>onAuthenticationRequired()</code> コールバックを実装して、有効期限前にトークンを更新し、再認証を促す</p>",
      "<p><strong data-what-means>概要:</strong> <code>SharedKeyIdentity</code>（オフラインモード）はクラウド同期を無効にし、メッシュ認証に共有シークレットを使用する。クラウド接続が利用できない場合にのみ使用する。</p>",
      "<p><strong data-what-means>概要:</strong> <code>SharedKey</code> の値をモバイルアプリのソースコードに直接ハードコードしない。MDM（モバイルデバイス管理）を使用して安全な鍵配布を行うか、ランタイムプロビジョニングを伴うプラットフォーム固有の安全なストレージを使用する。</p>",
      "<p><strong data-what-means>概要:</strong> Dittoに挿入する前にユーザー入力を検証およびサニタイズする</p>",
      "<p><strong data-what-means>概要:</strong> PII、パスワード、またはトークンなどの機密データをDittoドキュメントに保存しない</p>",
      "<p><strong data-what-means>概要:</strong> 本番環境では最小ログレベル（WARNING または ERROR）を有効化する</p>",
      "<p><strong data-what-means>概要:</strong> <code>SELECT * FROM %%SYSTEM_INFO%%</code> を使用してデバッグ用のシステム情報をクエリする（SDK 4.13+）</p>",
      "<p><strong data-what-means>概要:</strong> 可観測性コールバックを使用して同期ヘルスを監視する</p>",
      "<p><strong data-what-means>概要:</strong> プレゼンスを使用して接続ピアを追跡する</p>",
      "<p><strong data-what-means>概要:</strong> オフラインファースト動作（オフライン時にデータを作成）をテストする</p>",
      "<p><strong data-what-means>概要:</strong> 複数のDittoインスタンスから同じドキュメントへの同時変更をシミュレートするテストを作成し、同期後のCRDTマージ動作を検証する</p>",
      "<p><strong data-what-means>概要:</strong> 削除パターン（Soft-DeleteとDELETE）をテストする</p>",
      "<p><strong data-what-means>概要:</strong> <strong>アプリケーションのビジネスロジックとデータモデル</strong>を同時シナリオ下で検証するテストを作成する</p>",
      "<p><strong data-what-means>概要:</strong> デバイスのクロックがずれている（例: デバイスAは5秒進んでいる、デバイスBは3秒遅れている）状況をシミュレートするテストを作成する。タイムスタンプベースのロジックが適切な許容範囲でクロックドリフトを処理することを検証する。</p>"
    ],
    "whyMattersSections": [
      "<p>認証モードは、セキュリティモデルと同期機能を決定します。OnlinePlaygroundは本番環境では安全ではありません。OnlineWithAuthenticationは適切なアクセス制御を提供します。SharedKeyは完全にオフラインでの展開用です。</p>",
      "<p>Dittoの初期化と操作は、ライセンス、ネットワーク、プラットフォームの問題、または無効なクエリにより失敗する可能性があります。適切なエラーハンドリングは、アプリのクラッシュを防ぎ、ユーザーにフィードバックを提供します。</p>",
      "<p>Builder APIは非推奨であり、トランザクション、最適化、およびv5との前方互換性などの機能が欠けています。DQL APIは現在の標準（SDK 4.12+）であり、今後も保守されます。</p>",
      "<p><code>store.execute()</code>は非同期です。awaitせずに処理を進めると、同期が開始される前に設定が適用されず、ピア間で一貫性のない動作を引き起こす可能性があります。</p>",
      "<p>連番IDの生成は、複数のオフラインデバイスが同じIDパターンでドキュメントを作成する際に衝突を引き起こします（例: \"order_001\"）。衝突は競合解決をトリガーし、データ損失や予期しない動作を引き起こす可能性があります。複合キーを使用する認可パターン（例: <code>{\"userId\": \"user123\", \"resourceId\": \"&lt;uuid&gt;\"}</code>）では、少なくとも1つのコンポーネントがグローバルに一意であることを確認してください。</p>",
      "<p>オフラインピアからの同時配列更新は、同期後にデータ損失、重複、または不整合な状態を引き起こします。MAP構造は「追加が勝つ」セマンティクスを使用し、異なるキーへの同時更新を競合なしで自動的にマージします。</p>",
      "<p>DittoはSQL形式のJOINをサポートしていません。埋め込みデータの場合、1つのクエリですべてを取得できますが、ドキュメント間でデータが重複します。外部キーの場合、複数の連続クエリが必要（N+1パターンのリスク）ですが、単一の情報源を維持します。選択基準: (1) データがどのように一緒にアクセスされるか、(2) 更新頻度、(3) データサイズ、(4) 許容可能な重複のトレードオフ。埋め込みデータは、書き込みオーバーヘッドとストレージを犠牲にして読み取りパフォーマンスを最適化します。外部キーは、複数クエリを犠牲にして書き込みパフォーマンスとストレージを最適化します。</p>",
      "<p>ドキュメント内の大きなバイナリデータは、同期トラフィックとストレージを肥大化させます。添付ファイルは遅延ロードされ、オンデマンドで取得されるため、帯域幅とストレージを最適化します。</p>",
      "<p>計算フィールドを保存すると、帯域幅の無駄（不要なデータの同期）、古いデータのリスク（ソースが変更されても計算フィールドが更新されない）、および同期オーバーヘッドの追加が発生します。代わりにオンデマンドで計算してください。</p>",
      "<p>不要なデータの同期は、ネットワーク帯域幅の無駄（従量制接続では重要）、バッテリーの消耗（継続的な同期）、すべてのデバイスでのストレージの肥大化、および重要なビジネスデータの同期パフォーマンスの低下を引き起こします。すべてのピアは、このデータを保存、処理、中継する必要がありますが、その多くは単一のデバイスまたは瞬間にのみ関連します。</p><p><strong>重要な原則:</strong> デバイス間で必要な<strong>ビジネス状態</strong>（「単一の情報源」）のみを同期し、<strong>プレゼンテーション状態</strong>（UIがデータを表示する方法）、<strong>一時的な状態</strong>（一時的な処理ステータス）、または<strong>デバイスローカルな状態</strong>（1つのデバイスの環境に固有）は同期しないでください。</p>",
      "<p>DQL Strict Modeは、ピア間での型の一貫性を強制し、型の不一致によるランタイムエラーやクエリの失敗を防ぎます。厳密モードがない場合、1つのピアが文字列を挿入し、別のピアが数値を挿入すると、予期しない動作を引き起こす可能性があります。</p>",
      "<p><code>ON ID CONFLICT DO NOTHING</code>は、ドキュメントが既に存在する場合にエラーをスローせずに、安全に繰り返しINSERTを実行できます。これは、複数回実行される可能性のある冪等操作（リトライロジック、バックグラウンド同期）に役立ちます。</p>",
      "<p>フィールドレベルのUPDATEは、変更されたフィールドのみを同期し、帯域幅とストレージを節約します。ドキュメント全体の置き換え（再挿入）は、変更されていないフィールドも含めすべてのフィールドを同期し、不要なトラフィックを生成します。</p>",
      "<p>同じ値でフィールドを更新すると、不要な同期トラフィックが生成され、変更がないにもかかわらずすべてのピアに更新が伝播されます。更新前に値が実際に変更されたかどうかを確認してください。</p>",
      "<p><code>DO UPDATE_LOCAL_DIFF</code>は、ドキュメントが存在しない場合は挿入し、存在する場合は変更されたフィールドのみを更新する効率的なアップサート操作です。これにより、帯域幅とストレージが最適化されます。</p>",
      "<p>COUNTER型は、複数のピアが同時に値を増減できる分散カウンター（CvRDT）を提供します。すべての増減は自動的にマージされ、最終的な一貫性が保証されます。通常の数値フィールドは最後の書き込みが勝ち、同時更新により失われたインクリメントが発生する可能性があります。</p>",
      "<p>派生値（合計、平均など）にカウンターを使用すると、ソースデータが変更されたときに更新が複雑になります。代わりに、ソースデータを保存し、派生値をアプリケーションコードでオンデマンドで計算してください。</p>",
      "<p>イベントを配列に追加すると、同時更新時にマージ競合が発生します（Last-Write-Winsセマンティクス）。個別のドキュメントとして各イベントを保存すると、自動マージが可能になり、イベント履歴の独立したクエリとページネーションが可能になります。</p>",
      "<p><code>INITIAL DOCUMENTS</code>は、コレクションが空の場合にのみローカルデバイスにドキュメントを挿入します。これは、他のピアに同期されないデバイス固有のテンプレートまたはデフォルト設定に役立ちます。</p>",
      "<p>Soft-Delete（論理削除: <code>isDeleted</code>フラグを設定）は、削除をすべてのピアに伝播し、監査証跡を保持し、復元を可能にします。DELETEクエリ（物理削除）は、ドキュメントを永久に削除し、トゥームストーンを作成してTTL期間後に削除します。両者の違いを理解することは、データライフサイクル管理に不可欠です。</p>",
      "<p>マルチホップリレーを確実にするため、広くサブスクライブし（<code>isDeleted IS NULL OR isDeleted = false</code>ではなく<code>SELECT * FROM collection</code>）、オブザーバー/クエリでフィルタします。これにより、論理削除されたドキュメントが中間ピアを通じて伝播されます。</p>",
      "<p>論理削除されたドキュメントは、ストレージを消費し、クエリパフォーマンスに影響を与えます。古い削除済みドキュメント（例: 30日以上前）を定期的にEVICTして、ディスク使用量を管理し、クエリ速度を維持します。</p>",
      "<p><code>EVICT</code>は、ローカルデバイスからのみドキュメントを削除し、削除を他のピアに伝播しません。これは、ストレージをクリーンアップする必要があるが、削除をネットワーク全体にブロードキャストしたくない場合に役立ちます。</p>",
      "<p>アクティブなサブスクリプション中にドキュメントをEVICTすると、サブスクリプションがピアから再同期し、再びEVICTするという再同期ループが発生します。EVICT前にサブスクリプションをキャンセルして、この無限ループを防ぎます。</p>",
      "<p>トゥームストーン（削除マーカー）は、ピア間で削除を伝播するために作成されます。トゥームストーンはTTL期間（デフォルト: 30日）後に期限切れになります。TTL期間中にオンラインにならなかったピアは、削除されたドキュメントを再同期する可能性があります。</p>",
      "<p>Huskedドキュメントは、DELETEとUPDATEが同時に発生したときに発生します。DELETEはドキュメントを削除しますが、UPDATEは変更されたフィールドのみで新しいドキュメントを作成し、意図しない部分的なドキュメントを残します。Huskedドキュメントを防ぐには、DELETEの前にサブスクリプションをキャンセルし、UPDATEの前に存在チェックを実行します。</p>",
      "<p>DELETEクエリは永久的で不可逆です（トゥームストーンTTL後）。監査、復元、または履歴追跡が必要な場合は、代わりにSoft-Deleteを使用してください。</p>",
      "<p>DQLクエリの<code>WHERE</code>句でフィルタすることにより、ネットワークから関連データのみを取得し、帯域幅、メモリ使用量、処理時間を削減します。アプリケーションコードでのフィルタは、不要なデータを取得して破棄します。</p>",
      "<p>大規模データセット（>1000行）の場合、ページネーション（<code>LIMIT</code>と<code>OFFSET</code>）を使用してメモリ使用量を削減し、応答性を向上させます。すべてのデータを一度に読み込むと、メモリ不足やUI凍結を引き起こす可能性があります。</p>",
      "<p><code>QueryResultItem</code>オブジェクトは、内部ストレージ状態への参照を保持する場合があります。長期間保持すると、メモリリークや古いデータを引き起こす可能性があります。代わりに、<code>QueryResultItem</code>から必要なデータ（プレーンなDart/Swiftオブジェクト）を抽出し、その抽出されたデータを保持します。</p>",
      "<p>リクエスト/レスポンスパターン（定期的なポーリング、繰り返しクエリ）は、不要な帯域幅、バッテリー、処理を浪費します。長期サブスクリプションは、変更をリアルタイムでプッシュし、帯域幅とバッテリー使用量を最適化します。</p>",
      "<p>マルチホップリレーを確実にするため、広くサブスクライブし（<code>isActive = true</code>ではなく<code>SELECT * FROM collection</code>）、オブザーバーで厳密にフィルタします。これにより、中間ピアがデータを中継できます。</p>",
      "<p>不要なデータにサブスクライブすると、不要な同期トラフィック、ストレージ消費、およびオブザーバーの実行が発生します。必要なデータのみにサブスクライブしてください。</p>",
      "<p>オブザーバーとサブスクリプションをキャンセルしないと、メモリリーク、不要な同期トラフィック、およびバックグラウンドでのオブザーバーコールバックの実行が発生します。不要になったら必ずキャンセルしてください。</p>",
      "<p><code>registerObserverWithSignalNext</code>は、バックプレッシャー制御を提供し、前のイベントの処理が完了するまでオブザーバーが次のイベントを受信しないようにします。これにより、高速更新時のメモリ枯渇や処理遅延を防ぎます。</p>",
      "<p>オブザーバーコールバック内のエラーは、アプリのクラッシュ、サイレント失敗、または不整合な状態を引き起こす可能性があります。オブザーバー内に適切なエラーハンドリングを実装して、エラーをキャッチしてログに記録します。</p>",
      "<p>オブザーバーコールバック内で重い処理を実行すると、UIがブロックされ、オブザーバーキューがバックアップされ、応答性が低下します。重い処理はバックグラウンドスレッド/isolateにオフロードしてください。</p>",
      "<p>インデックスは、フルコレクションスキャンを回避することでクエリパフォーマンスを大幅に向上させます。インデックスがない場合、Dittoは一致するドキュメントを見つけるためにすべてのドキュメントをスキャンする必要があります。インデックスは、頻繁にクエリされるフィールド（<code>WHERE status = 'active'</code>、<code>WHERE userId = '...'</code>）に作成してください。</p>",
      "<p><code>EXPLAIN</code>は、クエリがインデックスを使用しているか（<code>index_scan</code>）、フルコレクションスキャンを実行しているか（<code>table_scan</code>）を示します。<code>table_scan</code>はパフォーマンスボトルネックを示し、インデックスを作成する必要があることを示唆します。</p>",
      "<p>N+1クエリパターン（ループ内で個別のクエリを実行）は、複数のクエリ実行のオーバーヘッドによりパフォーマンスを大幅に低下させます。代わりに、<code>IN</code>句を使用して単一のクエリですべての関連ドキュメントを取得してください。</p>",
      "<p>トランザクションは、複数の操作を単一のアトミックユニットにバッチ処理し、複数の個別クエリのオーバーヘッドを削減します。トランザクションは、すべての操作が成功するか、すべての操作が失敗することを保証し、部分的な更新を防ぎます。</p>",
      "<p>読み取り専用トランザクションは、複数のクエリにわたって一貫したスナップショットを提供し、読み取り中にデータが変更されないことを保証します。トランザクションがない場合、別々のクエリが異なる時点のデータを見る可能性があり、不整合な結果を引き起こします。</p>",
      "<p>ネストされた読み書きトランザクションは、両方のトランザクションが互いのロックを待機してデッドロックを引き起こす可能性があります。ネストされたトランザクションを避け、必要に応じて単一のトランザクションで操作を平坦化してください。</p>",
      "<p>長時間実行されるトランザクションは、ロックを長時間保持し、他の操作をブロックし、パフォーマンスを低下させます。トランザクションを短く集中させ（迅速なデータベース操作のみ）、重い計算やネットワーク呼び出しをトランザクションの外に移動してください。</p>",
      "<p>Flutter SDKでは、<code>ditto.close()</code>を呼び出す前にすべての保留中のトランザクションを<code>await</code>する必要があります。そうしないと、トランザクションが中断され、部分的な更新やデータ不整合が発生する可能性があります。他のプラットフォームのSDKは自動的に待機しますが、Flutter SDKは手動で管理する必要があります。</p>",
      "<p>ドキュメント内の大きなバイナリデータ（画像、動画、ファイル）は、同期トラフィックとストレージを肥大化させます。添付ファイルは、必要なときにのみオンデマンドで取得されるため、帯域幅とストレージを最適化します。ドキュメントは軽量な添付ファイルトークン（小さな参照）のみを保存します。</p>",
      "<p>添付ファイルの取得は、ピアの利用不可、ネットワークタイムアウト、または破損データにより失敗する可能性があります。適切なエラーハンドリング（try-catch、リトライロジック、ユーザーフィードバック）は、アプリのクラッシュを防ぎ、より良いユーザー体験を提供します。</p>",
      "<p>タイムアウトがない場合、<code>fetchAttachment()</code>は、遅いまたは利用できないピアを無期限に待機する可能性があります。タイムアウトを設定すると、応答性が保証され、ユーザーがフォールバック動作（キャッシュされた画像の表示、リトライのプロンプト）を実装できます。</p>",
      "<p>添付ファイルは、既に添付ファイルを持っている直接ピア（直接接続されたデバイス）からのみ取得できます。マルチホップシナリオでは、中間ピアが添付ファイルを取得していない場合、エンドピアは添付ファイルを取得できません。これにより、添付ファイルの可用性が制限されます。</p>",
      "<p>Dittoの添付ファイル取得は、接続が停止したときにエラーを発生させません。単に進行が停止するだけです。進行監視ラッパーを実装して、タイムアウト期間（例: 5分）内に進行がないことを検出し、適切にエラーをスローします。</p>",
      "<p>ドキュメントが削除された後も添付ファイルは残ります。対応するドキュメントのない孤立した添付ファイルトークンは、ストレージを無駄に消費します。定期的にスキャンしてクリーンアップし、ディスク使用量を管理します。</p>",
      "<p>Bluetooth LEトランスポートは、Wi-FiやLANよりも帯域幅が大幅に低いです。大きな添付ファイルは、同期を遅くしたり、タイムアウトを引き起こしたりする可能性があります。添付ファイルサイズを制限し（例: &lt;5MB）、より大きなものにはサムネイルまたは圧縮を使用し、Bluetooth経由で同期パフォーマンスをテストします。</p>",
      "<p><code>OnlineWithAuthenticationIdentity</code>は、認証システム（OAuth、JWT、カスタム）との統合を可能にし、適切なアクセス制御を提供し、大規模同期のためにBig Peer（クラウドデプロイメント）を有効にします。これは、すべての本番アプリケーションに推奨されるIDモードです。</p>",
      "<p>APIキー、トークン、または認証情報をハードコードまたはバージョン管理にコミットすると、深刻なセキュリティリスクが発生します。環境変数または安全なストレージを使用して、認証情報がソースコードで公開されないようにします。</p>",
      "<p>認証デリゲートコールバックは、トークンのライフサイクルを管理します。<code>onAuthenticationExpiringSoon()</code>は、有効期限前にトークンを更新し、<code>onAuthenticationRequired()</code>は、トークンが無効になったときに再認証を処理します。これらのコールバックがないと、トークンの有効期限によりユーザーが予期せず切断される可能性があります。</p>",
      "<p><code>SharedKeyIdentity</code>は、クラウド同期を無効にし、メッシュ認証に共有シークレットを使用します。これは、クラウド接続が利用できない完全にオフラインの展開（例: 軍事、産業、エアギャップ環境）専用です。</p>",
      "<p>モバイルアプリのソースコードに<code>SharedKey</code>の値をハードコードすると、深刻なセキュリティリスクが発生します。攻撃者がアプリを逆コンパイルしてキーを抽出し、メッシュネットワークへの不正アクセスを取得する可能性があります。MDMまたはプラットフォーム固有の安全なストレージを使用して安全な鍵配布を行います。</p>",
      "<p>サニタイズされていないユーザー入力は、インジェクション攻撃、予期しないデータ型、または無効なデータを引き起こす可能性があります。Dittoに挿入する前に入力を検証およびサニタイズして、データ整合性を確保します。</p>",
      "<p>Dittoドキュメントは、メッシュネットワーク内のすべてのピアに同期されます。PII、パスワード、またはトークンなどの機密データを保存すると、不正アクセスやコンプライアンス違反のリスクが発生します。機密データには専用の安全なストレージを使用してください。</p>",
      "<p>詳細なロギング（DEBUG、VERBOSE）は、本番環境で機密データ（ユーザーID、ドキュメントコンテンツ）を公開し、パフォーマンスを低下させる可能性があります。本番環境では最小ログレベル（WARNING、ERROR）を使用して、重要な問題のみをログに記録します。</p>",
      "<p><code>SELECT * FROM %%SYSTEM_INFO%%</code>は、アクティブなサブスクリプション、ストレージサイズ、同期状態などのシステムメタデータをクエリします。この情報は、同期の問題のデバッグ、パフォーマンスの監視、およびシステムヘルスの理解に役立ちます。</p>",
      "<p>可観測性コールバック（<code>onTransportConditionChange</code>、<code>onConnectionChange</code>）は、同期ヘルス、接続状態、およびトランスポートステータスへの可視性を提供します。これらのコールバックを監視することで、同期の問題を積極的に検出して対処できます。</p>",
      "<p>プレゼンスは、接続されたピア、そのオンライン/オフラインステータス、およびメタデータ（デバイスタイプ、ユーザー名）を追跡します。プレゼンスは、コラボレーション機能（\"誰がオンライン\"）、接続診断、およびピアの可用性の理解に役立ちます。</p>",
      "<p>オフラインファースト動作は、Dittoアプリの基本原則です。オフライン時にデータを作成し、デバイスが再接続したときに同期されることを検証することで、アプリがオフライン条件下で正しく機能することを保証します。</p>",
      "<p>複数のデバイスからの同時変更をテストすることで、CRDT競合解決が正しく機能することを検証します。これにより、データ損失、予期しないマージ、または不整合な状態が発生しないことを保証します。</p>",
      "<p>削除パターン（Soft-DeleteおよびDELETE）をテストすることで、削除がすべてのピアに正しく伝播され、古いドキュメントがクリーンアップされ、huskedドキュメントが発生しないことを検証します。</p>",
      "<p>Dittoは、CRDTマージ、同期、およびトランスポートを処理します。これらをテストする必要はありません。代わりに、同時シナリオ下でのアプリケーションのビジネスロジックとデータモデルに焦点を当ててください（例: 2つのユーザーが同じ注文を同時に更新した場合、アプリのロジックは正しい最終状態を生成しますか？）。</p>",
      "<p>Dittoの同期は、Hybrid Logical Clocks（HLC）を使用して因果順序を決定します。HLCはクロックドリフトに耐性がありますが、アプリケーションレベルのタイムスタンプロジック（例: 「最新のイベントを表示」、タイムスタンプによるフィルタリング）は、個別のデバイスクロックに依存します。妥当な許容範囲（例: ±5秒）でクロックドリフトを処理することをテストして、ユーザー体験が壊れないようにします。</p>"
    ],
    "codeExamples": [
      "<span></span><span class=\"c1\">// ✅ 良い例: Ditto初期化の適切なエラーハンドリング</span>\n<span class=\"k\">try</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">Ditto</span><span class=\"p\">.</span><span class=\"n\">open</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"nl\">identity:</span><span class=\"w\"> </span><span class=\"n\">OnlinePlaygroundIdentity</span><span class=\"p\">(</span><span class=\"nl\">appId:</span><span class=\"w\"> </span><span class=\"n\">appId</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nl\">token:</span><span class=\"w\"> </span><span class=\"n\">token</span><span class=\"p\">),</span>\n<span class=\"w\">  </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">startSync</span><span class=\"p\">();</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"kd\">on</span><span class=\"w\"> </span><span class=\"n\">DittoError</span><span class=\"w\"> </span><span class=\"k\">catch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"c1\">// Ditto固有のエラーを処理（ライセンス、権限など）</span>\n<span class=\"w\">  </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;Ditto initialization failed: </span><span class=\"si\">${</span><span class=\"n\">e</span><span class=\"p\">.</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">showErrorDialog</span><span class=\"p\">(</span><span class=\"s1\">&#39;Failed to initialize sync&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">catch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"c1\">// 予期しないエラーを処理</span>\n<span class=\"w\">  </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;Unexpected error: </span><span class=\"si\">$</span><span class=\"n\">e</span><span class=\"s1\">&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: awaitの欠落（同期前に設定が適用されない可能性がある）</span>\n<span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;ALTER SYSTEM SET DQL_STRICT_MODE = false&#39;</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// awaitがない！</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">startSync</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"c1\">// 誤った設定で開始される可能性がある</span>\n\n<span class=\"c1\">// ✅ 良い例: ALTER SYSTEM SETは常にawaitする</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;ALTER SYSTEM SET DQL_STRICT_MODE = false&#39;</span><span class=\"p\">);</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">startSync</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"c1\">// 設定が確実に適用される</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: 連番IDはオフラインデバイス間で衝突を引き起こす</span>\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">orderCounter</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">;</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;order_</span><span class=\"si\">${</span><span class=\"n\">orderCounter</span><span class=\"o\">++</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;item&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;Coffee&#39;</span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"c1\">// デバイスAが「order_1」を作成、デバイスBも「order_1」を作成 → 衝突！</span>\n\n<span class=\"c1\">// ✅ 良い例: Dittoにグローバルに一意なIDを自動生成させる</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;item&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;Coffee&#39;</span><span class=\"p\">}</span><span class=\"w\">  </span><span class=\"c1\">// _idなし → Dittoが自動生成</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: 並行更新される配列（Last-Write-Wins）</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;order_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;items&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[{</span><span class=\"s2\">&quot;id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;item1&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;qty&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">}]</span><span class=\"w\">  </span><span class=\"c1\">// マージ時に競合！</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ✅ 良い例: 並行更新のためのMAP構造</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;order_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;items&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s2\">&quot;item1&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s2\">&quot;qty&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;productId&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;p1&quot;</span><span class=\"p\">}}</span><span class=\"w\">  </span><span class=\"c1\">// マージ安全</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: 計算値を保存（帯域幅の無駄、古いデータのリスク）</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;order_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;items&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s2\">&quot;item_1&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s2\">&quot;price&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">12.99</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;quantity&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;lineTotal&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">25.98</span><span class=\"p\">}</span><span class=\"w\">  </span><span class=\"c1\">// ❌ 計算値！</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;subtotal&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">25.98</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// ❌ 計算値！</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;tax&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2.60</span><span class=\"p\">,</span><span class=\"w\">        </span><span class=\"c1\">// ❌ 計算値！</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;total&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">28.58</span><span class=\"w\">      </span><span class=\"c1\">// ❌ 計算値！</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ✅ 良い例: ソースデータのみを保存、アプリで計算</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;order_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;items&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s2\">&quot;item_1&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s2\">&quot;price&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">12.99</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;quantity&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">}</span><span class=\"w\">  </span><span class=\"c1\">// ソースデータのみ</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// アプリケーション内でオンデマンドで計算</span>\n<span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">calculateLineTotal</span><span class=\"p\">(</span><span class=\"n\">Map</span><span class=\"o\">&lt;</span><span class=\"kt\">String</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">dynamic</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">[</span><span class=\"s1\">&#39;price&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">[</span><span class=\"s1\">&#39;quantity&#39;</span><span class=\"p\">];</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">calculateTotal</span><span class=\"p\">(</span><span class=\"n\">Map</span><span class=\"o\">&lt;</span><span class=\"kt\">String</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">dynamic</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">taxRate</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subtotal</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">values</span><span class=\"p\">.</span><span class=\"n\">fold</span><span class=\"p\">(</span><span class=\"m\">0.0</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">sum</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">[</span><span class=\"s1\">&#39;price&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">[</span><span class=\"s1\">&#39;quantity&#39;</span><span class=\"p\">]));</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">subtotal</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">subtotal</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">taxRate</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: 不要なデータを同期</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;task_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;title&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;Review PR&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;status&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;pending&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"c1\">// ❌ UIの状態（デバイス固有、ビジネスデータではない）</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;isExpanded&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;selectedTab&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"c1\">// ❌ 一時的な状態（一過性、頻繁に変化）</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;uploadProgress&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">67</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;isProcessing&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"c1\">// ❌ デバイス固有（1つのデバイスのみに関連）</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;localFilePath&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;/storage/cache/task_123.tmp&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"c1\">// ❌ キャッシュされたデータ（外部ソースから取得可能）</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;userAvatarUrl&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;https://api.example.com/avatars/user_789.jpg&quot;</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ✅ 良い例: ビジネス状態のみを同期、その他のデータはローカルで管理</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;task_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;title&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;Review PR&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;status&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;pending&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;assignee&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;user_789&quot;</span><span class=\"w\">  </span><span class=\"c1\">// ビジネスデータ: 担当者</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// 非ビジネス状態はローカルに保存（ViewModel、キャッシュ、デバイスストレージ）:</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">TaskViewModel</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// Dittoのビジネスデータ</span>\n<span class=\"w\">  </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">isExpanded</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// UIの状態（ローカル）</span>\n<span class=\"w\">  </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">uploadProgress</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.0</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// 一時的な状態（ローカル）</span>\n<span class=\"w\">  </span><span class=\"kt\">String</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">cachedAvatarUrl</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// キャッシュされたデータ（必要に応じて取得）</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: ドキュメント全体の置き換え（不要な同期トラフィック）</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order) ON ID CONFLICT DO UPDATE&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;status&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;done&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;customer&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;items&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[...]}</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ 良い例: フィールドレベルの更新（変更されたフィールドのみ同期）</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE orders SET status = :status WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;status&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;done&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: DO UPDATEはすべてのフィールドを同期（未変更でも）</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order) ON ID CONFLICT DO UPDATE&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;status&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;done&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;customer&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ 良い例: DO UPDATE_LOCAL_DIFFは変更されたフィールドのみ同期（SDK 4.12+）</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order) ON ID CONFLICT DO UPDATE_LOCAL_DIFF&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;status&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;done&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;customer&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: カウンターのSET操作（更新の喪失）</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">product</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM products WHERE _id = :id&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;p1&#39;</span><span class=\"p\">}</span>\n<span class=\"p\">)).</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">first</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">;</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE products SET viewCount = :count WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;count&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">product</span><span class=\"p\">[</span><span class=\"s1\">&#39;viewCount&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">??</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;p1&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ 良い例: 分散カウンター用のCOUNTERタイプ（SDK 4.14.0+）</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE products APPLY viewCount COUNTER INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;p1&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: 派生在庫値のためにカウンターを使用</span>\n<span class=\"c1\">// 商品ドキュメントがcurrentStockカウンターを維持</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;product_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;name&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;Coffee Beans&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;currentStock&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">50</span><span class=\"w\">  </span><span class=\"c1\">// ❌ ordersコレクションから更新されるカウンター</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// 注文が配置されると、2つのコレクションを更新する必要がある:</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;productId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;product_123&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;qty&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"p\">}}</span>\n<span class=\"p\">);</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE products APPLY currentStock PN_INCREMENT BY -5.0 WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;product_123&#39;</span><span class=\"p\">}</span>\n<span class=\"p\">);</span>\n<span class=\"c1\">// 問題点: コレクション間の結合、整合性リスク、自己修正されない</span>\n\n<span class=\"c1\">// ✅ 良い例: 注文履歴から在庫を計算</span>\n<span class=\"c1\">// 商品ドキュメントには在庫カウンターがない</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;_id&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;product_123&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;name&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">&quot;Coffee Beans&quot;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"s2\">&quot;initialStock&quot;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"w\">  </span><span class=\"c1\">// 開始在庫（ベースライン）</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// 注文ドキュメントが真実のソース</span>\n<span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;productId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;product_123&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;qty&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"p\">}</span>\n<span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o2&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;productId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;product_123&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;qty&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">10</span><span class=\"p\">}</span>\n\n<span class=\"c1\">// 必要なときに注文から現在の在庫を計算:</span>\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">calculateCurrentStock</span><span class=\"p\">(</span><span class=\"kt\">String</span><span class=\"w\"> </span><span class=\"n\">productId</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">product</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">getProduct</span><span class=\"p\">(</span><span class=\"n\">productId</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">getOrders</span><span class=\"p\">(</span><span class=\"n\">productId</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">totalOrdered</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">orders</span><span class=\"p\">.</span><span class=\"n\">fold</span><span class=\"p\">(</span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">sum</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"p\">[</span><span class=\"s1\">&#39;qty&#39;</span><span class=\"p\">]);</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">product</span><span class=\"p\">[</span><span class=\"s1\">&#39;initialStock&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">totalOrdered</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"c1\">// 利点: 単一の真実のソース、自己修正、コレクション間の更新なし</span>\n",
      "<span></span><span class=\"c1\">// ❌ 誤り: サブスクリプションで削除フラグをフィルタリング</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE isDeleted != true&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// リレーをブロック！</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ 正しい: 広くサブスクライブし、オブザーバーでフィルタリング</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// フィルタなし - マルチホップリレーを許可</span>\n<span class=\"p\">);</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">observer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE isDeleted != true&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// ここでフィルタリング</span>\n<span class=\"w\">  </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">updateUI</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">signalNext</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: サブスクリプションをキャンセルせずにEVICT（再同期ループ！）</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;EVICT FROM orders WHERE deletedAt &lt; :cutoff&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;cutoff&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cutoffDate</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ 良い例: サブスクリプションをキャンセル → EVICT → 更新されたフィルタで再作成</span>\n<span class=\"n\">orderSubscription</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span><span class=\"w\">  </span><span class=\"c1\">// ステップ1: 最初にキャンセル</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;EVICT FROM orders WHERE isDeleted = true AND deletedAt &lt; :cutoff&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;cutoff&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cutoffDate</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"n\">orderSubscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE isDeleted != true&#39;</span><span class=\"p\">,</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ 問題: DELETE + 並行UPDATE = ハスク化ドキュメント</span>\n<span class=\"c1\">// デバイスA:</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;DELETE FROM cars WHERE _id = :id&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;car1&#39;</span><span class=\"p\">});</span>\n<span class=\"c1\">// デバイスB（オフライン）:</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;UPDATE cars SET color = :color WHERE _id = :id&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;color&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;blue&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;car1&#39;</span><span class=\"p\">});</span>\n<span class=\"c1\">// 同期後の結果: {_id: &quot;car1&quot;, color: &quot;blue&quot;, make: null, model: null}</span>\n\n<span class=\"c1\">// ✅ 解決策: Soft-Deleteはハスク化ドキュメントを防ぐ</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE cars SET isDeleted = true, deletedAt = :time WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;time&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DateTime</span><span class=\"p\">.</span><span class=\"n\">now</span><span class=\"p\">().</span><span class=\"n\">toIso8601String</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;car1&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: すべてのドキュメントを取得し、アプリケーションコードでフィルタリング</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">activeOrders</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span>\n<span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">where</span><span class=\"p\">((</span><span class=\"n\">order</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"p\">[</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"s1\">&#39;active&#39;</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">toList</span><span class=\"p\">();</span>\n<span class=\"c1\">// 問題点: メモリ使用量が多い、デシリアライゼーションが遅い、すべてのドキュメントがロードされる</span>\n\n<span class=\"c1\">// ✅ 良い例: WHERE句でデータベースレベルでフィルタリング</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE status = :status&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;status&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;active&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">activeOrders</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">).</span><span class=\"n\">toList</span><span class=\"p\">();</span>\n<span class=\"c1\">// 利点: メモリ使用量が少ない、クエリが高速、フィルタリングされたドキュメントのみがロードされる</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: QueryResultItem参照を保持（メモリリーク）</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">OrdersViewModel</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"o\">&lt;</span><span class=\"n\">QueryResultItem</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">_orderItems</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[];</span><span class=\"w\">  </span><span class=\"c1\">// ❌ カーソルを保存！</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">updateOrders</span><span class=\"p\">(</span><span class=\"n\">QueryResult</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_orderItems</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">toList</span><span class=\"p\">();</span><span class=\"w\">  </span><span class=\"c1\">// ❌ 長期間の参照</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">displayOrder</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_orderItems</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">].</span><span class=\"n\">value</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// ❌ 古いカーソルを使用</span>\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;Order: </span><span class=\"si\">${</span><span class=\"n\">order</span><span class=\"p\">[</span><span class=\"s1\">&#39;title&#39;</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"c1\">// 問題点: QueryResultItemカーソルを無期限に保持、メモリが解放されない</span>\n\n<span class=\"c1\">// ✅ 良い例: データをすぐに抽出し、プレーンオブジェクトを保存</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">OrdersViewModel</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"o\">&lt;</span><span class=\"n\">Order</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">_orders</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[];</span><span class=\"w\">  </span><span class=\"c1\">// ✅ プレーンなアプリケーションモデル</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">updateOrders</span><span class=\"p\">(</span><span class=\"n\">QueryResult</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// データをすぐに抽出してモデルに変換</span>\n<span class=\"w\">    </span><span class=\"n\">_orders</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span>\n<span class=\"w\">      </span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"p\">.</span><span class=\"n\">fromMap</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">))</span>\n<span class=\"w\">      </span><span class=\"p\">.</span><span class=\"n\">toList</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"c1\">// ここでQueryResultItemsがスコープ外になり、GCがクリーンアップできる</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">displayOrder</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_orders</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">];</span><span class=\"w\">  </span><span class=\"c1\">// ✅ プレーンモデルを使用</span>\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;Order: </span><span class=\"si\">${</span><span class=\"n\">order</span><span class=\"p\">.</span><span class=\"n\">title</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// アプリケーションモデル（プレーンなDartクラス）</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">Order</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"w\"> </span><span class=\"n\">title</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"n\">Order</span><span class=\"p\">({</span><span class=\"kd\">required</span><span class=\"w\"> </span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kd\">required</span><span class=\"w\"> </span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"n\">title</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kd\">required</span><span class=\"w\"> </span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"n\">status</span><span class=\"p\">});</span>\n\n<span class=\"w\">  </span><span class=\"kd\">factory</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"p\">.</span><span class=\"n\">fromMap</span><span class=\"p\">(</span><span class=\"n\">Map</span><span class=\"o\">&lt;</span><span class=\"kt\">String</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">dynamic</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"nl\">id:</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">[</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">title:</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">[</span><span class=\"s1\">&#39;title&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">status:</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">[</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: リクエスト/レスポンスパターン（DittoをHTTPのように扱う）</span>\n<span class=\"n\">Future</span><span class=\"o\">&lt;</span><span class=\"n\">List</span><span class=\"o\">&lt;</span><span class=\"n\">Order</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">fetchOrders</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"kd\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">Future</span><span class=\"p\">.</span><span class=\"n\">delayed</span><span class=\"p\">(</span><span class=\"n\">Duration</span><span class=\"p\">(</span><span class=\"nl\">seconds:</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">));</span><span class=\"w\">  </span><span class=\"c1\">// 非効率的な待機！</span>\n<span class=\"w\">  </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span><span class=\"w\">  </span><span class=\"c1\">// メッシュ同期の利点を無効化</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"p\">.</span><span class=\"n\">fromMap</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">)).</span><span class=\"n\">toList</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ✅ 良い例: リアルタイム更新のための長期間のサブスクリプションとオブザーバー</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">OrdersService</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">Subscription</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">_subscription</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">StoreObserver</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">_observer</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">initialize</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// サブスクリプションを開始 - 機能のライフタイムの間維持</span>\n<span class=\"w\">    </span><span class=\"n\">_subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// リアルタイム更新のためにオブザーバーを使用</span>\n<span class=\"w\">    </span><span class=\"n\">_observer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">updateUI</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"p\">.</span><span class=\"n\">fromMap</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">)));</span>\n<span class=\"w\">        </span><span class=\"n\">signalNext</span><span class=\"p\">();</span>\n<span class=\"w\">      </span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">dispose</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_observer</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">_subscription</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span><span class=\"w\">  </span><span class=\"c1\">// 機能が完了したときのみキャンセル</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: 狭いサブスクリプションフィルタがマルチホップリレーを破壊</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE priority = :priority&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;priority&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;high&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"c1\">// 問題点: このデバイスは低優先度の注文を保存/リレーしない</span>\n\n<span class=\"c1\">// ✅ 良い例: 広いサブスクリプション + オブザーバーでのローカルフィルタ</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// 優先度フィルタなし - リレーを有効化</span>\n<span class=\"p\">);</span>\n\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">observer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE priority = :priority&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// UI用にここでフィルタリング</span>\n<span class=\"w\">  </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">updateUI</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">);</span><span class=\"w\">  </span><span class=\"c1\">// 高優先度の注文のみが表示される</span>\n<span class=\"w\">    </span><span class=\"n\">signalNext</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;priority&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;high&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: 機能が現在のユーザーのデータのみを表示する場合の過度に広いサブスクリプション</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// すべてのユーザーからすべての注文を同期！</span>\n<span class=\"p\">);</span>\n\n<span class=\"c1\">// ✅ 良い例: 関連する顧客にスコープ設定</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE customerId = :customerId&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;customerId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">currentUserId</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"c1\">// この顧客の注文のみを同期</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: 参照が保存されず、キャンセルできない - メモリリーク</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">OrdersScreen</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">StatefulWidget</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nd\">@override</span>\n<span class=\"w\">  </span><span class=\"n\">State</span><span class=\"o\">&lt;</span><span class=\"n\">OrdersScreen</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">createState</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">_OrdersScreenState</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">_OrdersScreenState</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"o\">&lt;</span><span class=\"n\">OrdersScreen</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nd\">@override</span>\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">initState</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">super</span><span class=\"p\">.</span><span class=\"n\">initState</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"cm\">/* ... */</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ✅ 良い例: 参照を保存し、dispose()でキャンセル</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"nc\">_OrdersScreenState</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"o\">&lt;</span><span class=\"n\">OrdersScreen</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">Subscription</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">_subscription</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">StoreObserver</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"n\">_observer</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"nd\">@override</span>\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">initState</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">super</span><span class=\"p\">.</span><span class=\"n\">initState</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">_subscription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"kd\">sync</span><span class=\"p\">.</span><span class=\"n\">registerSubscription</span><span class=\"p\">(</span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">_observer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;SELECT * FROM orders&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"cm\">/* ... */</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n\n<span class=\"w\">  </span><span class=\"nd\">@override</span>\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">dispose</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_observer</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">_subscription</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">cancel</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"k\">super</span><span class=\"p\">.</span><span class=\"n\">dispose</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n",
      "<span></span><span class=\"c1\">// ✅ 良い例: バックプレッシャー制御付きのオブザーバー</span>\n<span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">observer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">registerObserverWithSignalNext</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;SELECT * FROM sensor_data WHERE deviceId = :deviceId&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;deviceId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">deviceId</span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"nl\">onChange:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">signalNext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">updateUI</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">).</span><span class=\"n\">toList</span><span class=\"p\">());</span>\n<span class=\"w\">    </span><span class=\"c1\">// 次のバッチの準備ができたらsignalNext()を呼び出す</span>\n<span class=\"w\">    </span><span class=\"n\">signalNext</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: アトミック性のない複数の個別操作</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;customerId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;total&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"p\">}},</span>\n<span class=\"p\">);</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"s1\">&#39;UPDATE customers APPLY orderCount PN_INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">},</span>\n<span class=\"p\">);</span>\n<span class=\"c1\">// 問題点: 2番目の操作が失敗すると、注文は存在するが顧客カウントが間違っている</span>\n\n<span class=\"c1\">// ✅ 良い例: アトミックトランザクションがすべて成功またはすべて失敗を保証</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">transaction</span><span class=\"p\">(</span><span class=\"nl\">hint:</span><span class=\"w\"> </span><span class=\"s1\">&#39;create-order&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kd\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;customerId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;total&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"p\">}},</span>\n<span class=\"w\">  </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;UPDATE customers APPLY orderCount PN_INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n<span class=\"c1\">// 利点: 両方の操作が一緒に成功するか、両方とも失敗し、データの一貫性を保証</span>\n",
      "<span></span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">results</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">transaction</span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kd\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// まず、特定の顧客のすべての注文IDを取得</span>\n<span class=\"w\">    </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">orderIds</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;SELECT _id FROM orders WHERE customerId = :customerId&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;customerId&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">)).</span><span class=\"n\">items</span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">((</span><span class=\"n\">item</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">[</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"p\">).</span><span class=\"n\">toList</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// 次に、各注文の完全な詳細を取得</span>\n<span class=\"w\">    </span><span class=\"c1\">// 最初のクエリと同じデータ状態を見ることが保証される</span>\n<span class=\"w\">    </span><span class=\"kd\">final</span><span class=\"w\"> </span><span class=\"n\">orderDetails</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;SELECT * FROM orders WHERE _id IN :ids&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;ids&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">orderIds</span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">orderDetails</span><span class=\"p\">.</span><span class=\"n\">items</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"nl\">isReadOnly:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nl\">hint:</span><span class=\"w\"> </span><span class=\"s1\">&#39;fetch-orders&#39;</span><span class=\"p\">,</span>\n<span class=\"p\">);</span>\n",
      "<span></span><span class=\"c1\">// ❌ 悪い例: ネストされた読み書きトランザクションが永続的なデッドロックを引き起こす</span>\n<span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">transaction</span><span class=\"p\">((</span><span class=\"n\">tx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kd\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s1\">&#39;INSERT INTO orders DOCUMENTS (:order)&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;order&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;_id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;o1&#39;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">&#39;total&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"p\">}},</span>\n<span class=\"w\">  </span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"c1\">// デッドロック: 内部トランザクションが外部を待ち、外部が内部を待つ</span>\n<span class=\"w\">  </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">ditto</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">transaction</span><span class=\"p\">((</span><span class=\"n\">innerTx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kd\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">await</span><span class=\"w\"> </span><span class=\"n\">innerTx</span><span class=\"p\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s1\">&#39;UPDATE customers APPLY orderCount PN_INCREMENT BY 1.0 WHERE _id = :id&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"nl\">arguments:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"s1\">&#39;id&#39;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">&#39;c1&#39;</span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">});</span>\n<span class=\"p\">});</span>\n<span class=\"c1\">// 結果: アプリが永続的にフリーズし、強制終了が必要</span>\n"
    ]
  }
};

    // ==========================================================================
    // UI Logic Functions
    // ==========================================================================

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.toggle('collapsed');
      }
    }

    function toggleCode(codeId) {
      const codeContent = document.getElementById(codeId);
      const button = codeContent.previousElementSibling.querySelector('.code-toggle');
      if (codeContent.classList.contains('hidden')) {
        codeContent.classList.remove('hidden');
        button.textContent = translations[currentLang].hideCode;
      } else {
        codeContent.classList.add('hidden');
        button.textContent = translations[currentLang].showCode;
      }
    }

    function updateProgress() {
      const checkboxes = document.querySelectorAll('.item-checkbox');
      const total = checkboxes.length;
      const completed = Array.from(checkboxes).filter(cb => cb.checked).length;
      const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

      document.getElementById('completed-count').textContent = completed;
      document.getElementById('total-count').textContent = total;
      document.getElementById('percent').textContent = percent;
      document.getElementById('global-progress').style.width = percent + '%';

      // Save state to localStorage
      const state = {};
      checkboxes.forEach(cb => {
        state[cb.id] = cb.checked;
      });
      localStorage.setItem('ditto-checklist-state', JSON.stringify(state));
    }

    let currentLang = 'en';

    function switchLanguage(lang) {
      currentLang = lang;

      // Update language buttons
      document.querySelectorAll('.lang-btn').forEach(btn => {
        if (btn.dataset.lang === lang) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // Update UI text
      document.getElementById('main-title').textContent = translations[lang].title;
      document.getElementById('completed-text').textContent = translations[lang].completed;
      document.getElementById('official-doc-text').textContent = translations[lang].officialDoc;

      // Update section titles
      document.querySelectorAll('.section').forEach((section, index) => {
        const titleElement = section.querySelector('.section-title');
        if (titleElement && translations[lang].sections[index]) {
          titleElement.innerHTML = translations[lang].sections[index];
        }
      });

      // Update item titles
      if (translations[lang].items) {
        document.querySelectorAll('.item-title').forEach((title, index) => {
          if (translations[lang].items[index]) {
            title.textContent = translations[lang].items[index];
          }
        });
      }

      // Update "What this means" sections
      if (translations[lang].whatMeansSections) {
        let whatMeansIndex = 0;
        document.querySelectorAll('.detail-section').forEach(section => {
          const heading = section.querySelector('.detail-heading');
          const content = section.querySelector('.detail-content');
          if (heading && content && (heading.textContent.includes('What this means') || heading.textContent.includes('概要'))) {
            if (translations[lang].whatMeansSections[whatMeansIndex]) {
              content.innerHTML = translations[lang].whatMeansSections[whatMeansIndex];

              // Remove embedded heading from Japanese translation (to avoid duplication)
              const embeddedHeading = content.querySelector('strong[data-what-means]');
              if (embeddedHeading) {
                // Remove just the <strong data-what-means>概要:</strong> tag, keeping the rest of the paragraph
                embeddedHeading.remove();
              }

              // Process paragraphs that start with "- " to add bullet styling
              content.querySelectorAll('p').forEach(p => {
                const text = p.textContent.trim();
                if (text.startsWith('- ')) {
                  p.classList.add('bullet-item');
                  // Remove the "- " prefix from the text
                  p.innerHTML = p.innerHTML.replace(/^-\s*/, '');
                }
              });
            }
            whatMeansIndex++;
          }
        });
      }

      // Update "Why this matters" sections
      if (translations[lang].whyMattersSections) {
        let whyMattersIndex = 0;
        document.querySelectorAll('.detail-section').forEach(section => {
          const heading = section.querySelector('.detail-heading');
          const content = section.querySelector('.detail-content');
          if (heading && content && (heading.textContent.includes('Why this matters') || heading.textContent.includes('解説'))) {
            if (translations[lang].whyMattersSections[whyMattersIndex]) {
              content.innerHTML = translations[lang].whyMattersSections[whyMattersIndex];

              // Process paragraphs that start with "- " to add bullet styling
              content.querySelectorAll('p').forEach(p => {
                const text = p.textContent.trim();
                if (text.startsWith('- ')) {
                  p.classList.add('bullet-item');
                  // Remove the "- " prefix from the text
                  p.innerHTML = p.innerHTML.replace(/^-\s*/, '');
                }
              });
            }
            whyMattersIndex++;
          }
        });
      }

      // Update code examples
      if (translations[lang].codeExamples) {
        let codeIndex = 0;
        document.querySelectorAll('.code-content pre code').forEach(codeElement => {
          if (translations[lang].codeExamples[codeIndex]) {
            // Replace entire innerHTML with syntax-highlighted code
            codeElement.innerHTML = translations[lang].codeExamples[codeIndex];
          }
          codeIndex++;
        });
      }

      // Update code example headers (e.g., "Code Example (dart)" -> "コード例 (dart)")
      document.querySelectorAll('.code-label').forEach(header => {
        const text = header.textContent;
        const match = text.match(/^Code Example \((.+)\)$/i);
        if (match && lang === 'ja') {
          header.textContent = `コード例 (${match[1]})`;
        } else if (text.match(/^コード例 \((.+)\)$/) && lang === 'en') {
          const jaMatch = text.match(/^コード例 \((.+)\)$/);
          if (jaMatch) {
            header.textContent = `Code Example (${jaMatch[1]})`;
          }
        }
      });

      // Update code toggle buttons
      document.querySelectorAll('.code-toggle').forEach(btn => {
        const codeContent = btn.closest('.code-header').nextElementSibling;
        if (codeContent.classList.contains('hidden')) {
          btn.textContent = translations[lang].showCode;
        } else {
          btn.textContent = translations[lang].hideCode;
        }
      });

      // Update detail headings
      document.querySelectorAll('.detail-heading').forEach(heading => {
        const text = heading.textContent.trim();
        if (text.includes('What this means') || text.includes('概要')) {
          heading.textContent = translations[lang].whatMeans;
        } else if (text.includes('Why this matters') || text.includes('解説')) {
          heading.textContent = translations[lang].whyMatters;
        }
      });

      // Save language preference
      localStorage.setItem('ditto-checklist-lang', lang);
    }

    // ==========================================================================
    // Initialization
    // ==========================================================================

    document.addEventListener('DOMContentLoaded', () => {
      // Restore checkbox state from localStorage
      const savedState = localStorage.getItem('ditto-checklist-state');
      if (savedState) {
        try {
          const state = JSON.parse(savedState);
          Object.keys(state).forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
              checkbox.checked = state[id];
            }
          });
        } catch (e) {
          console.error('Failed to restore checkbox state:', e);
        }
      }

      // Restore language preference
      const savedLang = localStorage.getItem('ditto-checklist-lang');
      if (savedLang && (savedLang === 'en' || savedLang === 'ja')) {
        switchLanguage(savedLang);
      }

      // Initial progress update
      updateProgress();

      // Add event listeners to all checkboxes
      document.querySelectorAll('.item-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateProgress);
      });
    });
  </script>
</body>
</html>
